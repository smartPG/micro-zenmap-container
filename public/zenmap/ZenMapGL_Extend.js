MapPlatForm={Base:{},ModdleMarker:0,BottomMarker:1,CustomMarker:2,VERSIONNUMBER:"v3.0.5",ServiceType:"zenmap",AK:"",dataServiceURL:"/zenmapdataservice/"},MapPlatForm.Base.MapConfig=function(e,t){this.CLASS_NAME="MapConfig",this.dataServiceURL=e||MapPlatForm.dataServiceURL,this.otherServiceURL=t,this.mapServiceURL="",this.mapInfo=null,this._mapJson=null},MapPlatForm.Base.MapConfig.prototype._addLayerToMap=function(e,t,i){var o=[];if(t&&0<t.length){for(var r=0,a=t.length;r<a;r++){var s,n=(s=t[r]).layerType.split("."),l=s.layerOpt;"ArcgisTileLayer"==n[n.length-1]&&(l=s.layerOpt.layerInfo),l=new ZenMap.Layers[n[n.length-1]](s.layerOpt.url,s.layerName,l),o.push(l)}1<o.length?e.addLayers(o,!0):(i&&o[0].setStyle(i),e.addLayers(o))}return o},MapPlatForm.Base.MapConfig.prototype.createMap=function(e,t,i){this.mapInfo=t,this._mapInfo=ZenMap.Utils.deepClone(this.mapInfo),this.styleJson=i;e=new ZenMap.Map(e,t.mapOpts),t=this._addLayerToMap(e,this._mapInfo.vectorLayer,this.styleJson);return this._mapJson={map:e,vectorLayer:t},this._mapJson},MapPlatForm.Base.MapConfig.prototype.showVectorLayer=function(){if(this._mapJson&&!this._mapJson.vectorLayer){if(this._mapJson.sattilateLayer){for(var e=0;e<this._mapJson.sattilateLayer.length;e++)this._mapJson.map.removeLayer(this._mapJson.sattilateLayer[e]);this._mapJson.sattilateLayer=null}this._mapInfo=ZenMap.Utils.deepClone(this.mapInfo);var t=this._addLayerToMap(this._mapJson.map,this._mapInfo.vectorLayer);this._mapJson.vectorLayer=t}},MapPlatForm.Base.MapConfig.prototype.showSattilateLayer=function(){if(this._mapJson&&!this._mapJson.sattilateLayer){if(this._mapJson.vectorLayer){for(var e=0;e<this._mapJson.vectorLayer.length;e++)this._mapJson.map.removeLayer(this._mapJson.vectorLayer[e]);this._mapJson.vectorLayer=null}this._mapInfo=ZenMap.Utils.deepClone(this.mapInfo);var t=this._addLayerToMap(this._mapJson.map,this._mapInfo.sattilateLayer);this._mapJson.sattilateLayer=t}},MapPlatForm.Base.MapConfig.prototype.createSceneMap=function(r,e,a,s,n){var e=MapPlatForm.dataServiceURL+"scene/"+e,l=this;ZenMap.Utils.Request.Get(e,"",function(t){if(!(t=(t=JSON.parse(t)).data.sceneInfo))return(i=l.createMap(r,s,n)).load(function(){a&&a()}),i.map;if((t=JSON.parse(t)).sceneOpts.centerPoint=t.sceneOpts.center,t.sceneOpts.defaultZoom=t.sceneOpts.zoom,t.sceneOpts.minZoom=5,t.sceneOpts.maxZoom=24,s){if(t.sceneOpts)for(var e in t.sceneOpts)t.sceneOpts.hasOwnProperty(e)&&t.sceneOpts[e]&&(s.mapOpts[e]=t.sceneOpts[e]);var i,o=(i=l.createMap(r,s,n)).map}else t.sceneOpts.showBackground=!1,o=new ZenMap.Map(r,t.sceneOpts);o.load(function(){var e=new ZenMap.Layers.ThreeLayer("threeLayer");o.addLayer(e),s.mapOpts.showSkyBox&&((new BigScreenMap.MapSkyBox2).addToMap(e),o._mapContainer.style.backgroundColor="#172437"),l._creatScene(o,e,t),a&&a(o,e)}),l._mapJson={map:o}},function(){var e=l.createMap(r,s,n);return e.load(function(){a&&a()}),e.map})},MapPlatForm.Base.MapConfig.prototype._creatScene=function(u,m,d){for(var r=MapPlatForm.dataServiceURL+"models/{modelID}/{modelID}.gltf",e=[],a=0;a<d.models.length;a++){var t=new Promise(function(t,e){var i=r.replace("{modelID}",d.models[a]).replace("{modelID}",d.models[a]),o=a;m.loader.load(i,function(e){t({index:o,model:e.scene})},void 0,void 0,function(){t({index:o,model:null})})});e.push(t)}if(Promise.all(e).then(function(r){function e(e){var o={};for(var t=0;t<r.length;t++)if(e==r[t].index){if(r[t].model){var i=r[t].model.clone();return function e(t){if(0<t.children.length)for(var i=0;i<t.children.length;i++)"Mesh"==t.children[i].type&&(o[t.children[i].material.uuid]||(o[t.children[i].material.uuid]=t.children[i].material.clone())),e(t.children[i])}(i),function e(t){if(0<t.children.length)for(var i=0;i<t.children.length;i++)"Mesh"==t.children[i].type&&(t.children[i].material=o[t.children[i].material.uuid]),e(t.children[i])}(i),i}return null}}if(d.buildings)for(var t=0;t<d.buildings.length;t++)(i=e(d.buildings[t].modelIndex))&&((h=m.addModel(i,d.buildings[t].position,{rotation:d.buildings[t].rotation,scale:d.buildings[t].scale,name:d.buildings[t].name,id:d.buildings[t].id})).renderOrder=50,h.type="building");if(d.appliances)for(t=0;t<d.appliances.length;t++)(i=e(d.appliances[t].modelIndex))&&((h=m.addModel(i,d.appliances[t].position,{rotation:d.appliances[t].rotation,scale:d.appliances[t].scale,name:d.appliances[t].name,id:d.appliances[t].id})).type="appliances");if(d.outRoom)for(var i,t=0;t<d.outRoom.length;t++)(i=e(d.outRoom[t].modelIndex))&&((h=m.addModel(i,d.outRoom[t].position,{rotation:d.outRoom[t].rotation,scale:d.outRoom[t].scale,name:d.outRoom[t].name,id:d.outRoom[t].id})).type="outRoom");if(d.tree)for(var o=new BigScreenMap.TreeManager(u,m.tb),t=0;t<d.tree.length;t++){for(var a,s=d.tree[t],n=[],l=0;l<s.treeGeometries.length;l++)"POLYLINE"===s.type||"POLYGON"===s.type?(a=WKT.read(s.treeGeometries[l]),n.push(a)):(a=new ZenMap.Geometry.Point(s.treeGeometries[l][0],s.treeGeometries[l][1]),n.push(a));for(var h,p,c=[],l=0;l<s.models.length;l++)(h=e(s.models[l]))&&c.push(h);c.length&&(p=new BigScreenMap.TreeCollect(n,s.type,s.split,c,s.side),o.addTreeCollect(p))}}),d.particle)for(var i,o,s=new BigScreenMap.WaterFountainManager(u,m.tb),n=new BigScreenMap.FireManager(u,m.tb),a=0;a<d.particle.length;a++)"water"===d.particle[a].type?(i=new BigScreenMap.WaterFountain({dX:d.particle[a].system[0],dY:d.particle[a].system[1],dZ:d.particle[a].system[2],dX1:d.particle[a].system[3],dY1:d.particle[a].system[4],dZ1:d.particle[a].system[5]}),o=d.particle[a].position,s.addWaterFountain(i,new ZenMap.Geometry.Point(o[0],o[1]),{height:o[2]})):"fire"===d.particle[a].type&&((i=new BigScreenMap.Fire(m.tb)).scale(d.particle[a].scale[0],d.particle[a].scale[1],d.particle[a].scale[2]),o=d.particle[a].position,n.addFire(i,new ZenMap.Geometry.Point(o[0],o[1]),{height:o[2]}));if(d.walls)for(var l=new BigScreenMap.WallManager(u,m.tb),a=0;a<d.walls.length;a++)for(var h=0;h<d.walls[a].geomtries.length;h++){var p=WKT.read(d.walls[a].geomtries[h]),p=new BigScreenMap.Wall(p,d.walls[a].height,{imageURL:d.walls[a].image,width_height:d.walls[a].width_height});l.addWall(p)}var c=[],y=new BigScreenMap.GroundManager(u,m.tb);if(d.grounds)for(a=0;a<d.grounds.length;a++){for(var _=WKT.read(d.grounds[a].landGeometry),f=[],h=0;h<d.grounds[a].grassGeometries.length;h++){var g=WKT.read(d.grounds[a].grassGeometries[h]);f.push(g)}c.push(_),d.grounds[a].landImage.imageURL=d.grounds[a].landImage.imageURL,d.grounds[a].grassImage.imageURL=d.grounds[a].grassImage.imageURL;_=new BigScreenMap.Ground(_,f,{land:d.grounds[a].landImage,grass:d.grounds[a].grassImage},d.grounds[a].hasHoles);y.addGround(_)}if(d.water)for(var v=new BigScreenMap.WaterEffectManager(u,m.tb),a=0;a<d.water.length;a++){var M=WKT.read(d.water[a].geometry);v.addWaterRegion(M,d.water[a].height)}},MapPlatForm.Base.MapGeometry=function(e){this.CLASS_NAME="MapPlatForm.Base.MapGeometry",this.map=e},MapPlatForm.Base.MapGeometry.prototype.getGeometryByGeoJson=function(e){return GeoJSON.read(e)},MapPlatForm.Base.MapGeometry.prototype.getGeometryByWKT=function(e){return WKT.read(e)},MapPlatForm.Base.MapGeometry.prototype.getFGeoJsonByGeometry=function(e){return GeoJSON.write(e,this.map)},MapPlatForm.Base.MapGeometry.prototype.getGGeoJsonByGeometry=function(e){var t=GeoJSON.write(e,this.map),t=JSON.parse(t);return e=JSON.stringify(t.geometry)},MapPlatForm.Base.MapGeometry.prototype.getWKTByGeometry=function(e){return WKT.write(e,this.map)},MapPlatForm.Base.MapGeometry.prototype.getExtent2Polygon=function(e){var t=[];return t.push(new ZenMap.Geometry.Point(e.sw.lon,e.sw.lat)),t.push(new ZenMap.Geometry.Point(e.ne.lon,e.sw.lat)),t.push(new ZenMap.Geometry.Point(e.ne.lon,e.ne.lat)),t.push(new ZenMap.Geometry.Point(e.sw.lon,e.ne.lat)),t.push(new ZenMap.Geometry.Point(e.sw.lon,e.sw.lat)),new ZenMap.Geometry.Polygon(t)},MapPlatForm.Base.MapGeometry.prototype.createMarker=function(e,t){markerType=t.markerType||MapPlatForm.ModdleMarker;var i=new ZenMap.Symbols.Icon(t.url,t.size);markerType===MapPlatForm.BottomMarker&&(i.setAnchor(new ZenMap.Geometry.Size(0,-t.size.height/2)),t.labelOffset=t.labelOffset||{x:0,y:-t.size.height/2}),markerType==MapPlatForm.CustomMarker&&i.setAnchor(new ZenMap.Geometry.Size(-t.iconOffset.width,-t.iconOffset.height)),t.showInMap&&(i._showInMap=t.showInMap);e=new ZenMap.Symbols.Marker(e);return e.setIcon(i),t.text&&(label=new ZenMap.Symbols.Label(t.text),label.setStyle({color:t.color||"#FFFFFF"}),t.labelOffset=t.labelOffset||{x:0,y:0},i=new ZenMap.Geometry.Size(t.labelOffset.x,t.labelOffset.y),label.setOffset(i),e.setLabel(label)),t.title&&e.setTitle(t.title),e},MapPlatForm.Base.MapGeometry.prototype.createCircleSector=function(e,t,i,o){var r,a,s=ZenMap.T.helper.webMoctorJW2PM(e.lon,e.lat),n=[],l=[];o=o*Math.PI/180,i=i*Math.PI/180,n.push(new ZenMap.Geometry.Point(s.lon,s.lat));for(var h=0;h<61;h++)a=o+i/60*h,r=s.lon+t*Math.cos(a),a=s.lat+t*Math.sin(a),n.push(new ZenMap.Geometry.Point(r,a));n.push(new ZenMap.Geometry.Point(s.lon,s.lat));for(h=0;h<n.length;h++){var p=ZenMap.T.helper.inverseMercator(n[h].lon,n[h].lat),p=new ZenMap.Geometry.Point(p.lon,p.lat);l.push(p)}return new ZenMap.Geometry.Polygon(l)},MapPlatForm.Base.MapGeometry.prototype.getIconByParam=function(e){markerType=e.markerType||MapPlatForm.ModdleMarker;var t=new ZenMap.Symbols.Icon(e.url,new ZenMap.Geometry.Size(e.size.width,e.size.height));return markerType===MapPlatForm.BottomMarker&&t.setAnchor(new ZenMap.Geometry.Size(0,-e.size.height/2)),markerType===MapPlatForm.CustomMarker&&t.setAnchor(new ZenMap.Geometry.Size(-e.iconOffset.width,-e.iconOffset.height)),t},MapPlatForm.Base.MapGeometry.prototype.getExtentByOverlays=function(e){for(var t,i,o,r,a=e.length-1;0<=a;a--){var s=e[a].getExtent();t&&i&&o&&r?(t>s.left&&(t=s.left),i>s.bottom&&(i=s.bottom),o<s.right&&(o=s.right),r<s.top&&(r=s.top)):(t=s.left,i=s.bottom,o=s.right,r=s.top)}return new ZenMap.Geometry.Extent(t,i,o,r)},MapPlatForm.Base.MapGeometry.prototype.sortingResourceByLine=function(e,t,i){for(var o=[],r=this._getLinePoints(t,i=i||50),a=this._getShortPointsInLine(e,t),s=0;s<r.length;s++)for(var n=null,n=s<r.length-1?r[s+1]:new ZenMap.Geometry.Point(r[s].lon+(r[s].lon-r[s-1].lon)/2,r[s].lat+(r[s].lat-r[s-1].lat)/2),l=this._findShortestMarker(a,r[s],n,i),h=l.length-1;0<=h;h--){for(var p=!1,c=0;c<o.length;c++)o[c]&&o[c].id===l[h].id&&(p=!0);!p&&l[h]&&o.push(l[h])}for(s=0;s<e.length;s++){for(p=!1,c=0;c<o.length;c++)o[c].id===e[s].id&&(p=!0);p||o.push(e[s])}return o},MapPlatForm.Base.MapGeometry.prototype._getLinePoints=function(e,t){for(var i=e.getPath(),o=[],r=0;r<i.length-1;r++){s_points=this._splitPoints(i[r],i[r+1],t);for(var a=0;a<s_points.length;a++)o.push(s_points[a])}return o},MapPlatForm.Base.MapGeometry.prototype._splitPoints=function(e,t,i){var o=[e],r=this.map.getDistance(e,t,"4326");if(r<=i)return[e,t];var a=0;0<i&&(a=Math.ceil(r/i));for(var s=1;s<a;s++){var n=s/a,l=parseFloat((t.lon-e.lon)*n)+parseFloat(e.lon),n=parseFloat((t.lat-e.lat)*n)+parseFloat(e.lat),n=new ZenMap.Geometry.Point(l,n);o.push(n)}return o},MapPlatForm.Base.MapGeometry.prototype._getShortPointsInLine=function(e,t){for(var i=[],o=0;o<e.length;o++){var r=null,r=e[o].longitude&&e[o].latitude?new ZenMap.Geometry.Point(e[o].longitude,e[o].latitude):e[o].getPosition(),a=t.getPath(),s=999999,n=null;sline=null;for(var l=0;l<a.length-1;l++){var h=this._getSibgleShortPointInLine(r.lon,r.lat,a[l].lon,a[l].lat,a[l+1].lon,a[l+1].lat),p=this._calculateEuclideanDistance(h.lon,h.lat,r.lon,r.lat);p<s&&(s=p,n=h,sline=new ZenMap.Geometry.Polyline([a[l],a[l+1]]))}i.push({key:o,shortPoint:n,data:e[o]})}return i},MapPlatForm.Base.MapGeometry.prototype._findShortestMarker=function(e,t,i,o){for(var r=[],a=0;a<e.length;a++){var s=e[a].shortPoint,n=this.map.getDistance(s,t,"4326"),l=this.map.getDistance(s,i,"4326"),s=this.map.getDistance(t,i,"4326");n<o/2&&(n*n+s*s<l*l&&(n=0-n),r.push({distance:n,marker:e[a].data}))}for(var h=[],a=(r=r.sort(function(e,t){return e.distance-t.distance})).length-1;0<=a;a--)h.push(r[a].marker);return h},MapPlatForm.Base.MapGeometry.prototype._getSibgleShortPointInLine=function(e,t,i,o,r,a){var s=this._calculateEuclideanDistance(i,o,r,a),n=this._calculateEuclideanDistance(i,o,e,t),l=this._calculateEuclideanDistance(r,a,e,t);if(s===n+l)return new ZenMap.Geometry.Point(e,t);if(s<=1e-6)return new ZenMap.Geometry.Point(i,o);if(s*s+n*n<=l*l)return new ZenMap.Geometry.Point(i,o);if(s*s+l*l<=n*n)return new ZenMap.Geometry.Point(r,a);if(i==r)return new ZenMap.Geometry.Point(i,t);r=(a-o)/(r-i),t=(e+(t-o)*r+r*r*i)/(r*r+1);return new ZenMap.Geometry.Point(t,r*t-r*i+o)},MapPlatForm.Base.MapGeometry.prototype._calculateEuclideanDistance=function(e,t,i,o){return Math.sqrt((e-i)*(e-i)+(t-o)*(t-o))},function(){MapPlatForm.Base.MapService=function(e,t,i){this.CLASS_NAME="MapService",this._currentService=null,this.map=e,this.mapConfig=new MapPlatForm.Base.MapConfig(t,i),this.mapGeometry=new MapPlatForm.Base.MapGeometry(this.map),this.routeService=null},MapPlatForm.Base.MapService.prototype.queryRoadByName=function(roadName,callBack){var url=this.mapConfig.dataServiceURL+"query/getRoadsByName",service=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),params=new ZenMap.Services.queryParams,params={roadName:roadName};this.queryRoadByNameService&&(this.queryRoadByNameService.abort(),this.queryRoadByNameService=null),this.queryRoadByNameService=service.query(url,params,function(result){for(var lines=[],i=result.length-1;0<=i;i--){var geometry=eval("("+result[i].feature+")"),obj={},line=GeoJSON.read(geometry);if(line instanceof Array)for(var j=line.length-1;0<=j;j--)line[j].data=result[i];else line.data=result[i];obj.name=result[i].name,obj.geometry=line,lines.push(obj)}callBack instanceof Function&&callBack(lines)})},MapPlatForm.Base.MapService.prototype.getGeometryBuffer=function(e,t,i){var o=this.mapConfig.dataServiceURL+"gis/buffer",r=new ZenMap.Services.bufferParams;r.projection=this.map.getProjection(),r.distance=t,r.units="m",r.geometry=e;e=new ZenMap.Services.BufferService(this.map,ZenMap.MAPTYPE_ZENMAP);this.geometryBufferService&&(this.geometryBufferService.abort(),this.geometryBufferService=null),this.geometryBufferService=e.buffer(o,r,i)},MapPlatForm.Base.MapService.prototype.queryPOIByName=function(name,callBack,maxResult,rowIndex){var url,service,params,tempUrl,tempUrl;this.queryPOIByNameService&&(this.queryPOIByNameService.abort(),this.queryPOIByNameService=null),"gaode"!=MapPlatForm.ServiceType?"minemap"!=MapPlatForm.ServiceType?(url=this.mapConfig.dataServiceURL+"query/poiname",service=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),params=new ZenMap.Services.queryParams,params.keyWord=name,maxResult&&(params.maxResult=maxResult),rowIndex&&(params.rowIndex=rowIndex),this.queryPOIByNameService=service.query(url,params,function(result){for(var points=[],i=0;i<result.features.length;i++){var geometry=eval("("+result.features[i].geometry+")"),point;"Point"!==geometry.type&&"point"!==geometry.type||(point=new ZenMap.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]),point.data=result.features[i],points.push(point))}callBack instanceof Function&&callBack(points,result)})):(tempUrl=this.mapConfig.otherServiceURL+"search/keyword",this.queryPOIByNameService=queryPOIByMinMapServer(tempUrl,{key:name,searchType:"poi",source:3,pageCount:maxResult,pageNumber:rowIndex,token:MapPlatForm.AK},function(e,t){callBack(e,t)})):(tempUrl=this.mapConfig.otherServiceURL+"search/poi",this.queryPOIByNameService=queryPOIByGaodeServer(tempUrl,{query:name,region:"全国",page_size:maxResult,page_num:rowIndex,ak:MapPlatForm.AK},function(e,t){callBack(e,t)}))},MapPlatForm.Base.MapService.prototype.queryPOIByCoord=function(point,callBack){var url,service,params,params,tempUrl,tempUrl;this.queryPOIByCoordService&&(this.queryPOIByCoordService.abort(),this.queryPOIByCoordService=null),"gaode"!=MapPlatForm.ServiceType?"minemap"!=MapPlatForm.ServiceType?(url=this.mapConfig.dataServiceURL+"query/poicoord",service=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),params=new ZenMap.Services.queryParams,params={coord:point.lon+","+point.lat},this.queryPOIByCoordService=service.query(url,params,function(result){var point,geometry;result&&result.geometry&&(geometry=eval("("+result.geometry+")"),"Point"!==geometry.type&&"point"!==geometry.type||(point=new ZenMap.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]),point.data=result)),callBack instanceof Function&&callBack(point)})):(tempUrl=this.mapConfig.otherServiceURL+"coder/reverseGeocoding",this.queryPOIByCoordService=queryGeoByMinMapServer(tempUrl,{location:point.lon+","+point.lat,type:1,radius:1e3,roadRadius:1e3,kind:0,source:3,token:MapPlatForm.AK},function(e){callBack(e)})):(tempUrl=this.mapConfig.otherServiceURL+"rgeo",this.queryPOIByCoordService=queryGeoByGaodeServer(tempUrl,{location:point.lon+","+point.lat,pois:1,ak:MapPlatForm.AK},function(e){callBack(e)}))},MapPlatForm.Base.MapService.prototype.addPOI=function(t,i){var e=this.mapConfig.dataServiceURL+"query/addPoi",o=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),r=(new ZenMap.Services.queryParams,{name:t.data.name,poiType:t.data.type,address:t.data.address,x:t.lon,y:t.lat});this.addPOIService&&(this.addPOIService.abort(),this.addPOIService=null),this.addPOIService=o.updata(e,r,function(e){e?(t.data=e,i instanceof Function&&i(t)):i instanceof Function&&i(null)})},MapPlatForm.Base.MapService.prototype.updataPOI=function(t,i){var e=this.mapConfig.dataServiceURL+"query/updataPoi",o=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),r=(new ZenMap.Services.queryParams,{gid:t.data.gid,name:t.data.name,poiType:t.data.type,address:t.data.address,x:t.lon,y:t.lat});this.updataPOIService&&(this.updataPOIService.abort(),this.updataPOIService=null),this.updataPOIService=o.updata(e,r,function(e){e?(t.data=e,i instanceof Function&&i(t)):i instanceof Function&&i(null)})},MapPlatForm.Base.MapService.prototype.queryPOIByGeometry=function(geometry,callBack,maxResult,rowIndex){if("gaode"==MapPlatForm.ServiceType){for(var tempUrl=this.mapConfig.otherServiceURL+"search/poi",geoStr="",points=geometry.getPath(),i=0;i<points.length;i++)geoStr+=points[i].lon+","+points[i].lat+";";return geoStr=geoStr.substring(0,geoStr.length-1),void queryPOIByGaodeServer(tempUrl,{query:name,regionType:"polygon",bounds:geoStr,page_size:maxResult,page_num:rowIndex,ak:MapPlatForm.AK},function(e,t){callBack(e,t)})}var url=this.mapConfig.dataServiceURL+"query/searchInBounds",wktGeo=this.mapGeometry.getWKTByGeometry(geometry),service=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),params=new ZenMap.Services.queryParams;params.wkt=wktGeo,maxResult&&(params.maxResult=maxResult),rowIndex&&(params.rowIndex=rowIndex),this.queryPOIByGeometryService&&(this.queryPOIByGeometryService.abort(),this.queryPOIByGeometryService=null),this.queryPOIByGeometryService=service.query(url,params,function(result){for(var points=[],i=0;i<result.data.length;i++){var geometry=eval("("+result.data[i].geometry+")"),point;"Point"!==geometry.type&&"point"!==geometry.type||(point=new ZenMap.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]),point.data=result.data[i],points.push(point))}callBack instanceof Function&&callBack(points,result.pageCount,result.totalCount)})},MapPlatForm.Base.MapService.prototype.queryPOIByFilter=function(filter,callBack,maxResult,rowIndex){var url=this.mapConfig.dataServiceURL+"query/poiname",service=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),params=new ZenMap.Services.queryParams;maxResult&&(params.maxResult=maxResult),rowIndex&&(params.rowIndex=rowIndex);var fs=filter.split("=");params.type=fs[0],params.keyWord=fs[1],this.queryPOIByFilterService&&(this.queryPOIByFilterService.abort(),this.queryPOIByFilterService=null),this.queryPOIByFilterService=service.query(url,params,function(result){for(var points=[],i=0;i<result.features.length;i++){var geometry=eval("("+result.features[i].geometry+")"),point;"Point"!==geometry.type&&"point"!==geometry.type||(point=new ZenMap.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]),point.data=result.features[i],points.push(point))}callBack instanceof Function&&callBack(points,result.pageCount,result.totalCount)})},MapPlatForm.Base.MapService.prototype.queryPOIByGeometryAndFilter=function(geometry,filter,callBack,maxResult,rowIndex){var url=this.mapConfig.dataServiceURL+"query/searchInBounds",wktGeo=this.mapGeometry.getWKTByGeometry(geometry),service=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),params=new ZenMap.Services.queryParams;params.wkt=wktGeo,maxResult&&(params.maxResult=maxResult),rowIndex&&(params.rowIndex=rowIndex);var fs=filter.split("=");params.type=fs[0],params.key=fs[1],params.requestType="post",this.queryPOIByGeometryAndFilterService&&(this.queryPOIByGeometryAndFilterService.abort(),this.queryPOIByGeometryAndFilterService=null),this.queryPOIByGeometryAndFilterService=service.query(url,params,function(result){for(var points=[],i=0;i<result.data.length;i++){var geometry=eval("("+result.data[i].geometry+")"),point;"Point"!==geometry.type&&"point"!==geometry.type||(point=new ZenMap.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]),point.data=result.data[i],points.push(point))}callBack instanceof Function&&callBack(points,result.pageCount,result.totalCount)})},MapPlatForm.Base.MapService.prototype.queryRoadInterByGeometry=function(geometry,callBack){var url=this.mapConfig.dataServiceURL+"query/roadInterByGeo",wktGeo=this.mapGeometry.getWKTByGeometry(geometry),service=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),params=new ZenMap.Services.queryParams;params.wkt=wktGeo,params.requestType="post",this.queryRoadInterByGeometryService&&(this.queryRoadInterByGeometryService.abort(),this.queryRoadInterByGeometryService=null),this.queryRoadInterByGeometryService=service.query(url,params,function(result){for(var points=[],i=0;i<result.data.length;i++){var geometry=eval("("+result.data[i].geometry+")"),point;"Point"!==geometry.type&&"point"!==geometry.type||(point=new ZenMap.Geometry.Point(geometry.coordinates[0],geometry.coordinates[1]),point.data=result.data[i],points.push(point))}callBack instanceof Function&&callBack(points)})},MapPlatForm.Base.MapService.prototype.queryRoadCrossByName=function(e,r){var t=this.mapConfig.dataServiceURL+"query/getRoadCrossByName",i=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),o=new ZenMap.Services.queryParams;o.roadName=e,this.queryRoadCrossByNameService&&(this.queryRoadCrossByNameService.abort(),this.queryRoadCrossByNameService=null),this.queryRoadCrossByNameService=i.query(t,o,function(e){for(var t=[],i=0;i<e.length;i++){var o=new ZenMap.Geometry.Point(e[i].lon,e[i].lat);o.data=e[i],t.push(o)}r instanceof Function&&r(t)})},MapPlatForm.Base.MapService.prototype.queryRoadCrossByGeometry=function(e,r){var t=this.mapGeometry.getWKTByGeometry(e),i=this.mapConfig.dataServiceURL+"query/searchRoadCrossInBounds",o=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),e=new ZenMap.Services.queryParams;e.wkt=t,this.queryRoadCrossByGeometryService&&(this.queryRoadCrossByGeometryService.abort(),this.queryRoadCrossByGeometryService=null),this.queryRoadCrossByGeometryService=o.query(i,e,function(e){for(var t=[],i=0;i<e.data.length;i++){var o=new ZenMap.Geometry.Point(e.data[i].lon,e.data[i].lat);o.data=e.data,t.push(o)}r instanceof Function&&r(t)})},MapPlatForm.Base.MapService.prototype.queryAllFeaturesByName=function(e,s){var t,i,o;this.queryFeaturesByNameService&&(this.queryFeaturesByNameService.abort(),this.queryFeaturesByNameService=null),"gaode"!=MapPlatForm.ServiceType?(t=this.mapConfig.dataServiceURL+"query/getFOIByName",i=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),(o=new ZenMap.Services.queryParams).keyWordString=e,this.queryFeaturesByNameService=i.query(t,o,function(e){for(var t=new MapPlatForm.Base.MapGeometry(this.map),i=[],o=0;o<e.length;o++){var r=null,a={},r="road"===e[o].type?(a.address=e[o].address,t.getGeometryByGeoJson(e[o].feature)):("poi"===e[o].type&&(a.address=e[o].address),t.getGeometryByGeoJson(e[o].wkt));a.name=e[o].name,a.type=e[o].type,a.geometry=r,i.push(a)}s instanceof Function&&s(i)})):(o=this.mapConfig.otherServiceURL+"search/poi",this.queryFeaturesByNameService=queryPOIByGaodeServer(o,{query:e,region:"全国",page_size:10,page_num:1,ak:MapPlatForm.AK},function(e,t){for(var i=[],o=0;o<e.length;o++){var r={};r.name=e[o].data.name,r.address=e[o].data.address,r.type="poi",r.geometry=e[o],i.push(r)}s(i)}))},MapPlatForm.Base.MapService.prototype.addRoadCross=function(e){var t=this.mapConfig.dataServiceURL+"query/addRoadCross",i=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),o=(new ZenMap.Services.queryParams,{name:e.data.name,x:e.lon,y:e.lat});this.addRoadCrossService&&(this.addRoadCrossService.abort(),this.addRoadCrossService=null),this.addRoadCrossService=i.updata(t,o,function(e){e?((void 0).data=e,callBack instanceof Function&&callBack(void 0)):callBack instanceof Function&&callBack(null)})},MapPlatForm.Base.MapService.prototype.updataRoadCross=function(e){var t=this.mapConfig.dataServiceURL+"query/updataRoadCross",i=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),o=(new ZenMap.Services.queryParams,{gid:e.data.gid,name:e.data.name,x:e.lon,y:e.lat});this._updataRoadCrossService&&(this._updataRoadCrossService.abort(),this._updataRoadCrossService=null),this._updataRoadCrossService=i.updata(t,o,function(e){e?((void 0).data=e,callBack instanceof Function&&callBack(void 0)):callBack instanceof Function&&callBack(null)})},MapPlatForm.Base.MapService.prototype.searchRouteByCoor=function(e,t){var i=null,o=new ZenMap.Services.routeParams,r=this.mapConfig.dataServiceURL+"/gis/na";"gaode"==MapPlatForm.ServiceType?(r=this.mapConfig.otherServiceURL,i=new ZenMap.Services.RouteService(this.map,ZenMap.MAPTYPE_ARCGISTILE),o.extendURL="route/",o.ak=MapPlatForm.AK):(i=new ZenMap.Services.RouteService(this.map,ZenMap.MAPTYPE_GEOSERVER),o.service="na",o.request="getroute",o.networkName="shanghai_roadnet_supermap",o.geoBarriers=[],o.algorithm="Dijkstra"),o.startStop=e.startStop,o.endStop=e.endStop,o.trafficModel=e.trafficModel,o.planRoadType=e.planRoadType,this.routeService&&(this.routeService.abort(),this.routeService=null),this.routeService=i.route(r,o,t)},MapPlatForm.Base.MapService.prototype.searchRouteByMultiPoints=function(e,h,t){for(var i=new ZenMap.Services.RouteService(this.map,ZenMap.MAPTYPE_GEOSERVER),o=new ZenMap.Services.routeParams,r="",a=0;a<e.length;a++)r+=e[a].lon+","+e[a].lat+";";r=r.substr(0,r.length-1),o.stops=r,this.routeMultiService&&(this.routeMultiService.abort(),this.routeMultiService=null),this.routeMultiService=i.routeByMultPoints(this.mapConfig.dataServiceURL+"/gis/routing",o,function(e){var t=[];if(e&&e instanceof Array)for(var i=0;i<e.length;i++){for(var o=[],r=e[i].expend.split(";"),a=0;a<r.length;a++){var s=r[a].split(","),n=parseFloat(s[0]),s=parseFloat(s[1]);o.push(new ZenMap.Geometry.Point(n,s))}var l=new ZenMap.Geometry.Polyline(o);l.setData({length:e[i].length,start:new ZenMap.Geometry.Point(parseFloat(e[i].start.split(",")[0]),parseFloat(e[i].start.split(",")[1])),end:new ZenMap.Geometry.Point(parseFloat(e[i].end.split(",")[0]),parseFloat(e[i].end.split(",")[1]))}),t.push(l)}h(t)},t)},MapPlatForm.Base.MapService.prototype.searchDistrictsByID=function(e,i){var t=this.mapConfig.dataServiceURL+"query/getRegionalBound",o=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),r=(new ZenMap.Services.queryParams,{addvcd:e});this._searchDistrictsService&&(this._searchDistrictsService.abort(),this._searchDistrictsService=null);var a=this;this._searchDistrictsService=o.query(t,r,function(e){if(e){if(e.geometry&&(e.geometry=a.mapGeometry.getGeometryByGeoJson(e.geometry)),e.districts)for(var t=0;t<e.districts.length;t++)e.districts[t].geometry&&(e.districts[t].geometry=a.mapGeometry.getGeometryByGeoJson(e.districts[t].geometry));i instanceof Function&&i(e)}else i instanceof Function&&i(null)})},MapPlatForm.Base.MapService.prototype.searchDistrictsByName=function(e,i){var t=this.mapConfig.dataServiceURL+"query/getRegionalBoundByName",o=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),r=(new ZenMap.Services.queryParams,{name:e});this._searchDistrictsService&&(this._searchDistrictsService.abort(),this._searchDistrictsService=null);var a=this;this._searchDistrictsService=o.query(t,r,function(e){if(e){if(e.geometry&&(e.geometry=a.mapGeometry.getGeometryByGeoJson(e.geometry)),e.districts)for(var t=0;t<e.districts.length;t++)e.districts[t].geometry&&(e.districts[t].geometry=a.mapGeometry.getGeometryByGeoJson(e.districts[t].geometry));i instanceof Function&&i(e)}else i instanceof Function&&i(null)})},MapPlatForm.Base.MapService.prototype.searchPanoramaByPoint=function(e,t,i){var o=this.mapConfig.dataServiceURL+"panorama/getConfigsByPosition",r=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),a=(new ZenMap.Services.queryParams,{position:this.mapGeometry.getWKTByGeometry(e),distance:t});this._searchPanoramaByPoint&&(this._searchPanoramaByPoint.abort(),this._searchPanoramaByPoint=null);this._searchPanoramaByPoint=r.query(o,a,function(e){e?i instanceof Function&&i(e):i instanceof Function&&i(null)})},MapPlatForm.Base.MapService.prototype.searchSNPanoramaPoints=function(t){var e=this.mapConfig.dataServiceURL+"panorama/getAllSnPoints",i=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),o=(new ZenMap.Services.queryParams,{});this._searchSNPanoramaPoints&&(this._searchSNPanoramaPoints.abort(),this._searchSNPanoramaPoints=null);this._searchSNPanoramaPoints=i.query(e,o,function(e){e?t instanceof Function&&t(e):t instanceof Function&&t(null)})},MapPlatForm.Base.MapService.prototype.searchSNPanoramaByPointID=function(e,t){var i=this.mapConfig.dataServiceURL+"panorama/getSnConfigsByParentId",o=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),r=(new ZenMap.Services.queryParams,{parentid:e});this._searchSNPanoramaByPointID&&(this._searchSNPanoramaByPointID.abort(),this._searchSNPanoramaByPointID=null);this._searchSNPanoramaByPointID=o.query(i,r,function(e){e?t instanceof Function&&t(e):t instanceof Function&&t(null)})},MapPlatForm.Base.MapService.prototype.queryRoomFloor=function(e,t,i){var o=this.mapConfig.dataServiceURL+"indoormap/getFloorByPidAndName",r=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP);params={pid:e,floorName:t},this._queryRoomFloor&&(this._queryRoomFloor.abort(),this._queryRoomFloor=null),this._queryRoomFloor=r.query(o,params,function(e){e?i instanceof Function&&i(e):i instanceof Function&&i(null)})},MapPlatForm.Base.MapService.prototype.queryRoomFloorsByGeometry=function(e,t){var i,o="";e instanceof ZenMap.Geometry.Polygon&&(o=WKT.write(e),i=this.mapConfig.dataServiceURL+"indoormap/listFloorByBounds",e=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),params={bounds:o},this._queryRoomFloorsByExtent&&(this._queryRoomFloorsByExtent.abort(),this._queryRoomFloorsByExtent=null),this._queryRoomFloorsByExtent=e.query(i,params,function(e){e?t instanceof Function&&t(e):t instanceof Function&&t(null)}))},MapPlatForm.Base.MapService.prototype.queryBuildingRoomList=function(e,t){var i=this.mapConfig.dataServiceURL+"indoormap/listBuilding",o=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP);e={pageSize:(e=e||{}).pageSize,recordIndex:e.pageIndex},this._queryBuildingRoomList&&(this._queryBuildingRoomList.abort(),this._queryBuildingRoomList=null),this._queryBuildingRoomList=o.query(i,e,function(e){e?t instanceof Function&&t(e):t instanceof Function&&t(null)})},MapPlatForm.Base.MapService.prototype.queryBuildingByName=function(e,t){var i=this.mapConfig.dataServiceURL+"indoormap/getBuildingByName",o=new ZenMap.Services.QueryService(ZenMap.MAPTYPE_ZENMAP),e={name:e};this._queryBuildingByName&&(this._queryBuildingByName.abort(),this._queryBuildingByName=null),this._queryBuildingByName=o.query(i,e,function(e){e?t instanceof Function&&t(e):t instanceof Function&&t(null)})},MapPlatForm.Base.MapService.prototype.cancelService=function(){this.queryPOIByFilterService&&(this.queryPOIByFilterService.abort(),this.queryPOIByFilterService=null),this.addRoadCrossService&&(this.addRoadCrossService.abort(),this.addRoadCrossService=null),this.queryPOIByGeometryService&&(this.queryPOIByGeometryService.abort(),this.queryPOIByGeometryService=null),this.updataPOIService&&(this.updataPOIService.abort(),this.updataPOIService=null),this._updataRoadCrossService&&(this._updataRoadCrossService.abort(),this._updataRoadCrossService=null),this.addPOIService&&(this.addPOIService.abort(),this.addPOIService=null),this.queryRoadByNameService&&(this.queryRoadByNameService.abort(),this.queryRoadByNameService=null),this.queryRoadCrossByGeometryService&&(this.queryRoadCrossByGeometryService.abort(),this.queryRoadCrossByGeometryService=null),this.queryPOIByGeometryAndFilterService&&(this.queryPOIByGeometryAndFilterService.abort(),this.queryPOIByGeometryAndFilterService=null),this.queryRoadCrossByNameService&&(this.queryRoadCrossByNameService.abort(),this.queryRoadCrossByNameService=null),this._queryRoomFloorsByExtent&&(this._queryRoomFloorsByExtent.abort(),this._queryRoomFloorsByExtent=null),this._queryRoomFloor&&(this._queryRoomFloor.abort(),this._queryRoomFloor=null),this._queryRoomFloorsByExtent&&(this._queryRoomFloorsByExtent.abort(),this._queryRoomFloorsByExtent=null),this._queryBuildingByName&&(this._queryBuildingByName.abort(),this._queryBuildingByName=null),this.routeService&&(this.routeService.abort(),this.routeService=null),this.queryRoadInterByGeometryService&&(this.queryRoadInterByGeometryService.abort(),this.queryRoadInterByGeometryService=null)};var queryPOIByGaodeServer=function queryPOIByGaodeServer(url,params,successCallback,errorCallback){return ZenMap.Utils.Request.Get(url,params,function(reply){if("function"==typeof successCallback){var text=reply.replace("'",""),result=eval("("+text+")"),points=[],features=[];if(result.results)for(var i=0;i<result.results.length;i++){var obj=result.results[i],point=new ZenMap.Geometry.Point(parseFloat(obj.location.lng),parseFloat(obj.location.lat)),feature={gid:obj.uid,address:obj.address,name:obj.name,telephone:obj.telephone,geometry:'{"type":"Point","coordinates":['+obj.location.lng+","+obj.location.lat+"]}"};point.data=feature,points.push(point)}successCallback(points,{totalCount:result.total,features:features})}},function(e){"function"==typeof errorCallback&&errorCallback(e)})},queryGeoByGaodeServer=function queryGeoByGaodeServer(url,params,successCallback,errorCallback){return ZenMap.Utils.Request.Get(url,params,function(reply){var text,result,point,obj,point,name,feature;"function"==typeof successCallback&&(text=reply.replace("'",""),result=eval("("+text+")"),result.results&&(obj=result.results[0],point=new ZenMap.Geometry.Point(parseFloat(obj.location.lng),parseFloat(obj.location.lat)),name=obj.formatted_address,obj.pois&&0<obj.pois.length&&(name=obj.pois[0].name),feature={address:obj.formatted_address,name:name,geometry:'{"type":"Point","coordinates":['+obj.location.lng+","+obj.location.lat+"]}"},point.data=feature),successCallback(point))},function(e){"function"==typeof errorCallback&&errorCallback(e)})},queryPOIByMinMapServer=function queryPOIByMinMapServer(url,params,successCallback,errorCallback){return ZenMap.Utils.Request.Get(url,params,function(reply){if("function"==typeof successCallback){var text=reply.replace("'",""),result=eval("("+text+")"),points=[],features=[],result=result.data;if(result.rows)for(var i=0;i<result.rows.length;i++){var obj=result.rows[i],point=new ZenMap.Geometry.Point(parseFloat(obj.geom.coordinates[0]),parseFloat(obj.geom.coordinates[1])),feature={gid:obj.id,address:obj.address,name:obj.name,telephone:obj.tel,geometry:'{"type":"Point","coordinates":['+obj.geom.coordinates[0]+","+obj.geom.coordinates[1]+"]}"};point.data=feature,points.push(point)}successCallback(points,{totalCount:result.total,features:features})}},function(e){"function"==typeof errorCallback&&errorCallback(e)})},queryGeoByMinMapServer=function queryGeoByMinMapServer(url,params,successCallback,errorCallback){return ZenMap.Utils.Request.Get(url,params,function(reply){var text,result,point,xy,obj,point,name,feature;"function"==typeof successCallback&&(text=reply.replace("'",""),result=eval("("+text+")"),xy=params.location.split(","),result.data&&(obj=result.data,point=new ZenMap.Geometry.Point(parseFloat(xy[0]),parseFloat(xy[1])),name=obj.restName,feature={address:obj.city+obj.dist+obj.town+obj.village+obj.restName,name:name,geometry:'{"type":"Point","coordinates":['+params.location+"]}"},point.data=feature),successCallback(point))},function(e){"function"==typeof errorCallback&&errorCallback(e)})}}(),function(){var n;MapPlatForm.Base.MapTag=function(e,t){this.CLASS_NAME="MapTag",this.layer=t,this.map=e,this._activeMarker=null,this.callback=null,this._mapGeometry=new MapPlatForm.Base.MapGeometry(e),this.markerParam=null,this.layer||(this.layer=this.map.getDefaultLayer()),(n=this).isclick=!1},MapPlatForm.Base.MapTag.prototype._clickCallBack=function(){var e;!n.isclick&&n._activeMarker?(n.isclick=!0,e=n._mapGeometry.createMarker(n._activeMarker.getPosition(),n.markerParam),n.layer.addOverlay(e),n.delAdrawMarker(),n.callback&&n.callback instanceof Function&&n.callback(e)):n.delAdrawMarker()},MapPlatForm.Base.MapTag.prototype._moveCallBack=function(e){e=e.object.getLonLatFromPixel(e.xy),e=new ZenMap.Geometry.Point(e.lon,e.lat),e=ZenMap.T.getPoint(n.map,e);n._activeMarker?n.isclick||n._activeMarker.setPosition(e):(n._activeMarker=n._mapGeometry.createMarker(e,n.markerParam),n.layer.addOverlay(n._activeMarker),n._activeMarker.addEventListener("click",n._clickCallBack),n._activeMarker.addEventListener("rightclick",n._rigthClickCallBack))},MapPlatForm.Base.MapTag.prototype._rigthClickCallBack=function(){n._activeMarker&&(n.delAdrawMarker(),n.cancelCallback&&n.cancelCallback())},MapPlatForm.Base.MapTag.prototype._mouseMoveCallBack=function(e){n._activeMarker?n._activeMarker.setPosition(e):(n._activeMarker=n._mapGeometry.createMarker(e,n.markerParam),n.layer.addOverlay(n._activeMarker),n._activeMarker.addEventListener("click",n._clickCallBack),n._activeMarker.addEventListener("rightclick",n._rigthClickCallBack))},MapPlatForm.Base.MapTag.prototype.adrawMarker=function(e,t,i,o,r){this.markerParam=e,this.isclick=!1,this.delAdrawMarker(),this.callback=t,this.cancelCallback=r,this.layer.removeOverlay(this._activeMarker),this._activeMarker=null,this._contextHeight="20px","EN"===ZenMap.CULTURE?(this.map.activateMouseContext("Click on add annotations, right click to cancel"),this._contextHeight="34px"):this.map.activateMouseContext("点击添加标注,右键取消");var a=this.map.getMouseContextStyle();if(a.height=this._contextHeight,i&&this.map.activateMouseContext(i),o)for(var s in o)a[s]=o[s];this.map.addEventListener(ZenMap.MAP_EVENT_MOUSE_MOVE,n._mouseMoveCallBack),this.map.addEventListener(ZenMap.MAP_EVENT_RIGHT_CLICK,n._rigthClickCallBack),this.map.addEventListener(ZenMap.MAP_EVENT_CLICK,n._clickCallBack),this.map.getContainer().onmouseenter=function(){n._activeMarker&&n._activeMarker.show()},this.map.getContainer().onmouseleave=function(){n._activeMarker&&n._activeMarker.hide()}},MapPlatForm.Base.MapTag.prototype.delAdrawMarker=function(){this.map&&(this._activeMarker&&(this._activeMarker.removeEventListener("click",n._clickCallBack),this._activeMarker.removeEventListener("rightclick",n._rigthClickCallBack)),this.layer.removeOverlay(this._activeMarker),this.map.deactivateMouseContext(),this.map.removeEventListener("click",n._clickCallBack),this.map.removeEventListener("rightclick",n._rigthClickCallBack),this.map.removeEventListener("mousemove",n._mouseMoveCallBack))}}(),MapPlatForm.Base.MapTools=function(e,t){this.CLASS_NAME="MapTools",this.map=e,this.measureTool=null,this.drawTool=null,this.searchCircle=null,this.editMarker=null,this.layer=t},MapPlatForm.Base.MapTools.prototype._initMeasureTool=function(){this.measureTool=new ZenMap.Tools.MeasureTool(this.map)},MapPlatForm.Base.MapTools.prototype._getStyle=function(e){return e?e.cursor="crosshair":e={cursor:"crosshair"},e},MapPlatForm.Base.MapTools.prototype._initDrawTool=function(){this.drawTool=new ZenMap.Tools.DrawingTool(this.map),this.map.MapTools=this},MapPlatForm.Base.MapTools.prototype.measureDistance=function(e,t){this.measureTool||this._initMeasureTool(),this.cancelDraw(),this.measureTool.setMode(ZenMap.MEASURE_MODE_DISTANCE,e,t)},MapPlatForm.Base.MapTools.prototype.measureArea=function(e,t){this.measureTool||this._initMeasureTool(),this.cancelDraw(),this.measureTool.setMode(ZenMap.MEASURE_MODE_AREA,e,t)},MapPlatForm.Base.MapTools.prototype.cancelMeasure=function(){this.measureTool&&this.measureTool.cancleMeasure()},MapPlatForm.Base.MapTools.prototype.cancelDraw=function(){this.drawTool&&this.drawTool.cancleDraw()},MapPlatForm.Base.MapTools.prototype.drawLine=function(e,t){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),t=this._getStyle(t),this.drawTool.setMode(ZenMap.DRAW_MODE_POLYLINE,e,t)},MapPlatForm.Base.MapTools.prototype.drawRectangle=function(e,t){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),t=this._getStyle(t),this.drawTool.setMode(ZenMap.DRAW_MODE_RECT,e,t)},MapPlatForm.Base.MapTools.prototype.drawCircle=function(e,t){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),t=this._getStyle(t),this.drawTool.setMode(ZenMap.DRAW_MODE_CIRCLE,e,t)},MapPlatForm.Base.MapTools.prototype.drawPolygon=function(e,t){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),t=this._getStyle(t),this.drawTool.setMode(ZenMap.DRAW_MODE_POLYLGON,e,t)},MapPlatForm.Base.MapTools.prototype.drawCircleByDiameter=function(e,t){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),t=this._getStyle(t),this.drawTool.setMode(ZenMap.DRAW_MODE_CIRCLE_DIAMETER,e,t)},MapPlatForm.Base.MapTools.prototype.drawFreehand=function(e,t){this.drawTool||this._initDrawTool(),this.cancelMeasure(),this.cancelDraw(),t=this._getStyle(t),this.drawTool.setMode(ZenMap.DRAW_MODE_FREEHAND,e,t)},MapPlatForm.Base.MapTools.prototype.addCircleSearchControl=function(e,t,i,o,r){var a=this,s=1e3,n="米";"EN"===ZenMap.CULTURE&&(n="M"),i?s=i:i=500,o=o||5e3,r&&i<=r&&r<=o&&(s=r);var l=t;this.searchCircle=new ZenMap.Geometry.Circle(e,s,{color:"#acb9d1",fillColor:"#6980bc",weight:2,opacity:1,fillOpacity:.2});var h=this.map.getDefaultLayer();(this.layer||this.map.getDefaultLayer()).addOverlay(this.searchCircle);r=new ZenMap.Geometry.Size(76,24);this.map.addImages([["editCircle",ZenMap.Utils.BaseUtils.getHostPath()+"/ZenView/editCircle.png"]]);r=new ZenMap.Symbols.Icon("editCircle",r);this.editMarker=new ZenMap.Symbols.Marker(e),h.addOverlay(this.editMarker),this.editMarker.setIcon(r),this.editMarker.setOffset(new ZenMap.Geometry.Size(25,-12));h=new ZenMap.Symbols.Label(s+n,{offset:new ZenMap.Geometry.Size(45/14,-12/14)});h.setStyle({fontSize:12,fontFamily:"宋体",align:"left"}),this.editMarker.setLabel(h);r=this.searchCircle.getCenter(),h=ZenMap.T.helper.webMoctorJW2PM(r.lon,r.lat);h.lon=h.lon+s,r=ZenMap.T.helper.inverseMercator(h.lon,h.lat),this.editMarker.setPosition(r),this.editMarker.isEnableEdit=!0,a._resetControlMarker(),this.editMarker.addEventListener("draging",a._updateCircle(i,o,n).bind(this)),this.editMarker.addEventListener("dragend",a._callback(l).bind(this)),this.map.addEventListener("moving",a._resetControlMarker.bind(this)),t&&t instanceof Function&&t(a.searchCircle)},MapPlatForm.Base.MapTools.prototype._updateCircle=function(i,o,r){return function(){var e=this.searchCircle.getCenter(),t=ZenMap.T.helper.webMoctorJW2PM(e.lon,e.lat),e=this.editMarker.getPosition(),e=ZenMap.T.helper.webMoctorJW2PM(e.lon,e.lat),e=Math.sqrt(Math.pow(e.lon-t.lon,2)+Math.pow(e.lat-t.lat,2));this.map._obj.transform.pitch=0,e<i?e=i:o<e&&(e=o);t=this.editMarker.getLabel();t.setContent(Math.round(e)+r),this.editMarker.setLabel(t),this.searchCircle.setRadius(e),this._resetControlMarker()}},MapPlatForm.Base.MapTools.prototype._callback=function(e){return function(){this._resetControlMarker(),e&&e instanceof Function&&e(this.searchCircle)}},MapPlatForm.Base.MapTools.prototype._resetControlMarker=function(){if(this.searchCircle){for(var e=this.searchCircle.getPath(),t=[],i=0;i<e.length;i++){var o=this.map.pointToPixel(e[i]);t.push(o)}for(var r=t[0].x,a=t[0],i=1;i<t.length;i++)r<t[i].x&&(a=t[i],r=t[i].x);var s=this.map.pixelToPoint({x:a.x,y:a.y});this.editMarker.setPosition(s)}},MapPlatForm.Base.MapTools.prototype.setCircleSearchControlRadius=function(e,t){var i,o,r;this.searchCircle&&this.editMarker&&(i="米","EN"===ZenMap.CULTURE&&(i="M"),r=this.searchCircle.getCenter(),(o=ZenMap.T.helper.webMoctorJW2PM(r.lon,r.lat)).lon=o.lon+e,r=ZenMap.T.helper.inverseMercator(o.lon,o.lat),this.editMarker.setPosition(r),this.editMarker.setPosition(r),this.searchCircle.setRadius(e),(r=this.editMarker.getLabel()).setContent(Math.round(e)+i),this.editMarker.setLabel(r),this.editMarker.refresh(),r=this.searchCircle.getExtent(),this.map.zoomToExtent(r),t&&t instanceof Function&&t(self.searchCircle))},MapPlatForm.Base.MapTools.prototype.removeCircleSearchControl=function(){this.editMarker&&(this.editMarker.removeEventListener("dragend",this._callback),this.editMarker.removeEventListener("draging",this._updateCircle),this.map.removeEventListener("moving",this._resetControlMarker));var e=this.map.getDefaultLayer(),t=this.layer||this.map.getDefaultLayer();e.removeOverlay(this.editMarker),t.removeOverlay(this.searchCircle),this.map.disableEditing()},function(){var l;MapPlatForm.Base.MapRoutePlan=function(e,t,i,o){this.CLASS_NAME="MapRoutePlan",this.map=e,this.layer=t||this.map.getDefaultLayer(),this.startMarker=null,this._planRoadType=1,this._trafficModel="car",this._currentPolyline=null,this.endMarker=null,this.editMarker=null,this._throughMarkerInfo={},this._routes=[],this._throughMarkerNum=0,this._routeIndex=0,this.dataServiceURL=i,this.otherServiceURL=o,this._mapService=new MapPlatForm.Base.MapService(e,i,o),this._mapGeometry=new MapPlatForm.Base.MapGeometry(e),this.result1=null,this.result2=null,this._researchCallback=function(){},this.routeGroup=this.layer.addGroup("route"),this.editGroup=this.layer.addGroup("route_edit"),this.defaultName="未知地址",l=this,"EN"===ZenMap.CULTURE&&(this.defaultName="Unknown Position"),window.getElementsByClassName=function(e){for(var t=[],i=document.getElementsByTagName("*"),o=0;o<i.length;o++)i[o].className===e&&(t[t.length]=i[o]);return t}},MapPlatForm.Base.MapRoutePlan.prototype._addPath=function(e){var o;e.features.length<1||e.features.length<1?this._errorCallBack&&this._errorCallBack instanceof Function&&("EN"===ZenMap.CULTURE?this._errorCallBack("There is no suitable route, please re-drag！"):this._errorCallBack("没有合适的路线，请重新拖动！")):((e=e.features[0]).setStyle({color:"red",weight:5}),this.routeGroup.addOverlay(e),o=this,e.addEventListener("mousemove",function(e,t){var i=new MapPlatForm.Base.MapGeometry(map);o.editMarker?(o.editMarker.setPosition(t),o.editMarker.show()):(o.editMarker=i.createMarker(t,{url:o._crossMarkerStyle.editImageUrl,size:{width:o._crossMarkerStyle.width,height:o._crossMarkerStyle.height},markerType:2}),o.editGroup.addOverlay(o.editMarker),o.editMarker.isEnableEdit=!0,o.editMarker.enableEditing())}))},MapPlatForm.Base.MapRoutePlan.prototype.addEidtMarkerEvent=function(){this.editMarker&&this.editMarker.addEventListener(ZenMap.MARKER_EVENT_DRAG_END,function(e){_afterDrag(e)})},MapPlatForm.Base.MapRoutePlan.prototype._afterDrag=function(i,o,r){var e,a=null,s=null,s=o?(a=o.startPosition,o.stopPosition):(e=_currentPolyline.getPath(),a=e[0],e[e.length-1]),n={startStop:a,endStop:i,trafficModel:this._trafficModel,planRoadType:this._planRoadType},l=this;_mapService.searchRouteByCoor(n,function(t){n={startStop:i,endStop:s,trafficModel:this._trafficModel,planRoadType:this._planRoadType},_mapService.searchRouteByCoor(n,function(e){t.features.length<1||e.features.length<1?l._errorCallBack&&l._errorCallBack instanceof Function&&("EN"==ZenMap.CULTURE?l._errorCallBack("There is no suitable route, please re-drag！"):l._errorCallBack("没有合适的路线，请重新拖动！")):_addRoutes(i,{result1:t,result2:e,startPosition:a,stopPosition:s,throughMarkerRelativeInfo:o,key:r})})})},MapPlatForm.Base.MapRoutePlan.prototype._addRoutes=function(e){this.routeGroup.addOverlay(e.features[0])},MapPlatForm.Base.MapRoutePlan.prototype._clearEditInfoOnMap=function(){this.editGroup&&(this.editGroup.removeAllOverlays(),this.editMarker=null),this.routeGroup&&(this.routeGroup.removeAllOverlays(),this.editMarker=null),this.map.closeAllInfoWindows()},MapPlatForm.Base.MapRoutePlan.prototype._queryRoute=function(){var e={startStop:this._startMarker.getPosition(),endStop:this._endMarker.getPosition(),trafficModel:this._trafficModel,planRoadType:this._planRoadType},i=this;this._mapService.searchRouteByCoor(e,function(e){var t;e.features?(t=e.features,i._setPolylineStyle([t]),i.routeGroup.addOverlay(t),t.setData({index:i._routeIndex}),i._routeArray=[t],i._addEventToLines([t]),i._routes=[{index:i._routeIndex,dragIconIndex:{icon1:0,icon2:0},route:t,routeInfo:e.messages}],t={routes:i._routes,polyline:t},i._researchCallback(t)):i._errorCallBack&&i._errorCallBack instanceof Function&&("EN"===ZenMap.CULTURE?i._errorCallBack("There is no suitable route, please re-drag！"):i._errorCallBack("没有合适的路线，请重新拖动！"))})},MapPlatForm.Base.MapRoutePlan.prototype._addEventToLines=function(e){if(e&&e instanceof Array)for(var t=e.length,i=0;i<t;i++)e[i].addEventListener("mousemove",this._addMarker),e[i].addEventListener("mouseout",this._removeMarker)},MapPlatForm.Base.MapRoutePlan.prototype._removeMarker=function(){l.editGroup.removeOverlay(l.editMarker),l.editMarker=null},MapPlatForm.Base.MapRoutePlan.prototype._addMarker=function(e){var t;this.flag||(t=e.srcObject,e=new ZenMap.Geometry.Point(e.lon,e.lat),l.editMarker?(l.editMarker.setPosition(e),l.editMarker.show()):(l.editMarker=l._mapGeometry.createMarker(e,{url:l._crossMarkerStyle.editImageUrl,size:{width:l._crossMarkerStyle.width,height:l._crossMarkerStyle.height},markerType:0}),l.editGroup.addOverlay(l.editMarker),l._dragEdit()),l.editMarker.setData({line:t}))},MapPlatForm.Base.MapRoutePlan.prototype._removeEventToLines=function(e){if(e&&e instanceof Array)for(var t=e.length,i=0;i<t;i++)e[i].removeEventListener("mousemove",this._addMarker)},MapPlatForm.Base.MapRoutePlan.prototype._dragEdit=function(){var e;this.editMarker&&(this.editMarker.isEnableEdit=!0,(e=this).map.ModifyFeatureControl&&!this.map.ModifyFeatureControl._active&&(this.map.ModifyFeatureControl.disableEdit(),this.map.ModifyFeatureControl=null),this.map.ModifyFeatureControl||(this.map.ModifyFeatureControl=new ZenMap.Controls.ModifyFeatureControl("",this.editMarker)),this.editMarker.addEventListener("dragstart",function(){this.flag=!0}),this.editMarker.addEventListener("dragend",function(){this.flag=!1,e._currentPolyline=e.editMarker.getData().line,e._afterDrag(e.editMarker.getPosition()),e._removeMarker()}))},MapPlatForm.Base.MapRoutePlan.prototype._getRelativeRoute=function(e){for(var t=null,i=null,o=0,r=this._routes.length;o<r;o++)if(this._routes[o].dragIconIndex.icon1===parseInt(e,10)||this._routes[o].dragIconIndex.icon2===parseInt(e,10))if(t){if(!i){i=this._routes[o];break}}else t=this._routes[o];return{route1:t,route2:i}},MapPlatForm.Base.MapRoutePlan.prototype._afterDrag=function(t,i){var e,o,r,a,s=null,n=null,l="add";l=i?(r=(o=this._getRelativeRoute(i)).route1.route.getPath(),a=o.route2.route.getPath(),s=("MultiLineString"===o.route1.route._lineType?r[0]:r)[0],n="MultiLineString"===o.route2.route._lineType?a[a.length-1][a[a.length-1].length-1]:a[a.length-1],"edit"):(e=this._currentPolyline.getPath(),s=("MultiLineString"===this._currentPolyline._lineType?e[0]:e)[0],n="MultiLineString"===this._currentPolyline._lineType?e[e.length-1][e[e.length-1].length-1]:e[e.length-1],"add");var h,p,c,s={startStop:s,endStop:t,trafficModel:this._trafficModel,planRoadType:this._planRoadType},u=this;this._mapService.searchRouteByCoor(s,function(e){h=e,u._searchRouteByDrag(t,l,o,i,h,p,c)});n={startStop:t,endStop:n,trafficModel:this._trafficModel,planRoadType:this._planRoadType};new MapPlatForm.Base.MapService(this.map,this.dataServiceURL,this.otherServiceURL).searchRouteByCoor(n,function(e){p=e,u._searchRouteByDrag(t,l,o,i,h,p,c)}),new MapPlatForm.Base.MapService(this.map,this.dataServiceURL,this.otherServiceURL).queryPOIByCoord(t,function(e){c=e||{data:{}},u._searchRouteByDrag(t,l,o,i,h,p,c)})},MapPlatForm.Base.MapRoutePlan.prototype._searchRouteByDrag=function(e,t,i,o,r,a,s){if(r&&a&&s){for(var n=this.routeGroup.getAllOverlayers(),l=[],h=0;h<n.length;h++)"ZenMap.Geometry.Polyline"===n[h].CLASS_NAME&&l.push(n[h]);this._addEventToLines(l),r.features.length<1||a.features.length<1?this._errorCallBack&&this._errorCallBack instanceof Function&&("EN"===ZenMap.CULTURE?this._errorCallBack("There is no suitable route, please re-drag！"):this._errorCallBack("没有合适的路线，请重新拖动！")):this._getAddressByCoor(e,{result1:r,result2:a,type:t,relativeRoutes:i,key:o},s)}},MapPlatForm.Base.MapRoutePlan.prototype._getAddressByCoor=function(e,t,i){"add"===t.type?this._afteDragAdd(e,t,i):this._afterDragEdit(e,t,i)},MapPlatForm.Base.MapRoutePlan.prototype._afteDragAdd=function(e,t,i){var o=t.result1.features,r=t.result2.features;this._setPolylineStyle([o,r]),o.setData({index:++this._routeIndex}),r.setData({index:++this._routeIndex}),this.routeGroup.addOverlay(o),this.routeGroup.addOverlay(r),this._addEventToLines([o,r]);var a=this._crossMarkerStyle.crossImageUrl,s=this._mapGeometry.createMarker(e,{url:a,size:{width:this._crossMarkerStyle.width,height:this._crossMarkerStyle.height},markerType:0});this.editGroup.addOverlay(s);a=i.data.name,i=a||this.defaultName;this._throughMarkerNum++,s.setData({key:this._throughMarkerNum,name:i});a=this._getRouteByIndex(this._currentPolyline.getData().index),e=this._addInfowin(i,this._throughMarkerNum,e);e.getBaseDiv().title=i,this._throughMarkerInfo[this._throughMarkerNum]={infoWindow:e,marker:s},s.isEnableEdit=!0;var n=this;s.addEventListener("mouseover",function(){l.map.disableInertialDragging()}),s.addEventListener("mouseout",function(){l.map.enableInertialDragging()}),s.addEventListener("dragend",function(){var e=parseInt(s.getData().key,10);n._throughMarkerInfo[e].infoWindow.close(),n._afterDrag(s.getPosition(),e)}),t.result1.messages.startPointName=a.routeInfo.startPointName,t.result2.messages.startPointName=i,this._refreshRouteArray({route1:{index:o.getData().index,dragIconIndex:{icon1:a.dragIconIndex.icon1,icon2:this._throughMarkerNum},route:o,routeInfo:t.result1.messages},route2:{index:r.getData().index,dragIconIndex:{icon1:this._throughMarkerNum,icon2:a.dragIconIndex.icon2},route:r,routeInfo:t.result2.messages},key:t.key},t.type),this.routeGroup.removeOverlay(this._currentPolyline)},MapPlatForm.Base.MapRoutePlan.prototype._afterDragEdit=function(e,t,i){var o=t.relativeRoutes;this.routeGroup.removeOverlay(o.route1.route),this.routeGroup.removeOverlay(o.route2.route);var r=t.result1.features,a=t.result2.features;this._setPolylineStyle([r,a]),r.setData({index:o.route1.route.getData().index}),a.setData({index:o.route2.route.getData().index}),this.routeGroup.addOverlay(r),this.routeGroup.addOverlay(a),this._addEventToLines([r,a]);i=i.data.name,i=i||this.defaultName;this._throughMarkerInfo[t.key].marker.setData({key:t.key,name:i}),o.route1.route=r,o.route1.routeInfo=t.result1.messages,o.route2.route=a,o.route2.routeInfo=t.result2.messages,o.route2.routeInfo.startPointName=i;e=this._addInfowin(i,t.key,e);this._throughMarkerInfo[t.key].infoWindow=e,this._refreshRouteArray({route1:o.route1,route2:o.route2,key:t.key},t.type)},MapPlatForm.Base.MapRoutePlan.prototype._getThroughInfo=function(e,t){var i=document.createElement("div");i.style.fontSize="13px",i.style.border="1px solid #dfdfdf",i.style.borderRadius="5px",i.style.webkitBorderRadius="5px",i.style.height="21px",i.style.backgroundColor="#fff";var o=document.createElement("span");o.style.maxWidth="100px",o.style.overflow="hidden",o.style.whiteSpace="nowrap",o.style.textOverflow="ellipsis",o.style.float="left",o.style.marginLeft="2px",o.style.display="inline-block",o.style.lineHeight="21px",o.innerText=e;e=document.createElement("i");return e.style.width="14px",e.style.height="14px",e.style.float="left",e.style.display="inline-block",e.style.marginLeft="5px",e.style.marginTop="3px",e.style.cursor="pointer",e.style.background="url("+ZenMap.Utils.BaseUtils.getHostPath()+"/ZenView/close1.png) no-repeat",e.className="infowindow-close",e.setAttribute("key",t),i.appendChild(o),i.appendChild(e),i},MapPlatForm.Base.MapRoutePlan.prototype._addInfowin=function(e,t,i){t=this._getThroughInfo(e,t),t=new ZenMap.Symbols.InfoWindow(i,"",t,{iscommon:!0,closeButton:!1,offset:new ZenMap.Geometry.Size(7,-9)});this.map.addOverlay(t),t.open(),t.getBaseDiv().style.padding="2px 5px 2px";for(var o=document.getElementsByClassName("infowindow-close"),r=this,a=o.length-1;0<=a;a--)o[a].onclick=function(){key=this.getAttribute("key");var o=r._getRelativeRoute(key),e=o.route1.route.getPath(),t=o.route2.route.getPath(),t={startStop:e[0],endStop:t[t.length-1],trafficModel:r._trafficModel,planRoadType:r._planRoadType};r._mapService.searchRouteByCoor(t,function(e){var t,i;e.features[0]?((i=r._throughMarkerInfo[key]).infoWindow.close(),r.editGroup.removeOverlay(i.marker),r.routeGroup.removeOverlay(o.route1.route),r.routeGroup.removeOverlay(o.route2.route),t=e.features[0],i=++r._routeIndex,t.setData({index:i}),r._setPolylineStyle([t]),r.routeGroup.addOverlay(t),e.messages.startPointName=o.route1.routeInfo.startPointName,r._refreshRouteArray({route:{index:i,dragIconIndex:{icon1:o.route1.dragIconIndex.icon1,icon2:o.route2.dragIconIndex.icon2},route:e.features[0],routeInfo:e.messages},key:key},"delete"),r._addEventToLines([e.features[0]])):r._errorCallBack()})};return t},MapPlatForm.Base.MapRoutePlan.prototype._refreshRouteArray=function(e,t){var i,o=null,r=null;if("add"===t){for(var a=this._currentPolyline.getData().index,s=0,n=this._routes.length;s<n;s++)if(this._routes[s].index===parseInt(a,10)){i=s;break}this._routes.splice(i,1,e.route1),this._routes.splice(i+1,0,e.route2)}else if("edit"===t){for(s=0,n=this._routes.length;s<n;s++)if(this._routes[s].dragIconIndex.icon1===parseInt(e.key,10)||this._routes[s].dragIconIndex.icon2===parseInt(e.key,10))if(o){if(!r){r=this._routes[s],this._routes.splice(s,1,e.route2);break}}else o=this._routes[s],this._routes.splice(s,1,e.route1)}else for(s=0,n=this._routes.length;s<n;s++)if(this._routes[s].dragIconIndex.icon1===parseInt(e.key,10)||this._routes[s].dragIconIndex.icon2===parseInt(e.key,10))if(o){if(!r){r=this._routes[s],this._routes.splice(s,1);break}}else o=this._routes[s],this._routes.splice(s,1,e.route);var l=[];if(this._routes&&0<this._routes.length){for(s=0,n=this._routes.length;s<n;s++)l=l.concat(this._routes[s].route.getPath());h=new ZenMap.Geometry.Polyline(l)}var h={routes:this._routes,polyline:h};this._researchCallback(h)},MapPlatForm.Base.MapRoutePlan.prototype._setPolylineStyle=function(e){if(e&&e instanceof Array)for(var t=e.length,i=0;i<t;i++)e[i].setStyle(this._lineStyle)},MapPlatForm.Base.MapRoutePlan.prototype._getRouteByIndex=function(e){for(var t=null,i=0,o=this._routes.length;i<o;i++)if(this._routes[i].index===parseInt(e,10)){t=this._routes[i];break}return t},MapPlatForm.Base.MapRoutePlan.prototype._refreshRelativeThroughInfo=function(e,t){var i,o,r,a,s=t.startPosition,n=t.stopPosition;for(i in this._throughMarkerInfo)e!==parseInt(i)&&(o=this._throughMarkerInfo[i].startPosition,r=this._throughMarkerInfo[i].stopPosition,a=this._throughMarkerInfo[i].crossPoint,s.lat===o.lat&&s.lon===o.lon&&(this._throughMarkerInfo[i].startPosition=t.crossPoint,this._throughMarkerInfo[i].route1=t.route2),n.lat===r.lat&&n.lon===r.lon&&(this._throughMarkerInfo[i].stopPosition=t.crossPoint,this._throughMarkerInfo[i].route2=t.route1),s.lat===a.lat&&s.lon===a.lon&&(this._throughMarkerInfo[i].stopPosition=t.crossPoint,this._throughMarkerInfo[i].route2=t.route1),n.lat===a.lat&&n.lon===a.lon&&(this._throughMarkerInfo[i].startPosition=t.crossPoint,this._throughMarkerInfo[i].route1=t.route2))},MapPlatForm.Base.MapRoutePlan.prototype._refreshRelativeThroughInfoDel=function(e,t,i){var o,r,a,s=t.crossPoint;for(o in _throughMarkerInfo)e!==parseInt(o)&&(r=this._throughMarkerInfo[o].startPosition,a=this._throughMarkerInfo[o].stopPosition,s.lat===r.lat&&s.lon===r.lon&&(this._throughMarkerInfo[o].startPosition=t.startPosition,this._throughMarkerInfo[o].route1=i),s.lat===a.lat&&s.lon===a.lon&&(this._throughMarkerInfo[o].stopPosition=t.stopPosition,this._throughMarkerInfo[o].route2=i))},MapPlatForm.Base.MapRoutePlan.prototype.addRoutePlanControl=function(e,t,i){this._planRoadType=e.planRoadType||this._planRoadType,this._trafficModel=e.trafficModel||this._trafficModel,this._startMarker=e.startMarker,this._endMarker=e.endMarker,this._lineStyle=e.lineStyle||{color:"green",weight:10,opacity:.7},this.map.addImages([["path-cross",ZenMap.Utils.BaseUtils.getHostPath()+"/ZenView/path-cross.png"],["path-edit",ZenMap.Utils.BaseUtils.getHostPath()+"/ZenView/path-edit.png"]]),this._crossMarkerStyle=e.crossMarkerStyle||{crossImageUrl:"path-cross",editImageUrl:"path-edit",height:22,width:22},this._clearEditInfoOnMap(),this._researchCallback=t,this._errorCallBack=i,e.polyline?(e=e.polyline,this._setPolylineStyle([e]),this.routeGroup.addOverlay(e),e.setData({index:this._routeIndex}),this._routeArray=[e],this._addEventToLines([e]),this._routes=[{index:this._routeIndex,dragIconIndex:{icon1:0,icon2:0},route:e,routeInfo:""}]):this._queryRoute()},MapPlatForm.Base.MapRoutePlan.prototype.stopEdit=function(){for(var e,t=this.routeGroup.getAllOverlayers(),i=[],o=0;o<t.length;o++)"ZenMap.Geometry.Polyline"===t[o].CLASS_NAME&&i.push(t[o]);for(e in this._removeEventToLines(i),this.editGroup.removeOverlay(this.editMarker),this.editMarker=null,this._throughMarkerInfo)this._throughMarkerInfo[e].marker&&this._throughMarkerInfo[e].marker.disableEditing();for(var r=document.getElementsByClassName("infowindow-close"),o=r.length-1;0<=o;o--)r[o].onclick=null},MapPlatForm.Base.MapRoutePlan.prototype.startEdit=function(){for(var e,t=this.routeGroup.getAllOverlayers(),i=[],o=0;o<t.length;o++)"ZenMap.Geometry.Polyline"===t[o].CLASS_NAME&&i.push(t[o]);for(e in this._addEventToLines(i),this._throughMarkerInfo)this._throughMarkerInfo[e].marker&&this._throughMarkerInfo[e].marker.enableEditing();for(var r=document.getElementsByClassName("infowindow-close"),a=this,o=r.length-1;0<=o;o--)r[o].onclick=function(){key=this.getAttribute("key");var o=a._getRelativeRoute(key),e=o.route1.route.getPath(),t=o.route2.route.getPath(),t={startStop:e[0],endStop:t[t.length-1],trafficModel:a._trafficModel,planRoadType:a._planRoadType};a._mapService.searchRouteByCoor(t,function(e){var t,i;e.features[0]?((i=a._throughMarkerInfo[key]).infoWindow.close(),a.editGroup.removeOverlay(i.marker),a.routeGroup.removeOverlay(o.route1.route),a.routeGroup.removeOverlay(o.route2.route),t=e.features[0],i=++a._routeIndex,t.setData({index:i}),a._setPolylineStyle([t]),a.routeGroup.addOverlay(t),e.messages.startPointName=o.route1.routeInfo.startPointName,a._refreshRouteArray({route:{index:i,dragIconIndex:{icon1:o.route1.dragIconIndex.icon1,icon2:o.route2.dragIconIndex.icon2},route:e.features[0],routeInfo:e.messages},key:key},"delete"),a._addEventToLines([e.features[0]])):a._errorCallBack()})}}}(),function(){var e=MapPlatForm.Base.AnimationLineManager=function(e){this._map=e,this.animationLineArr=[]};e.prototype.addAnimationLines=function(e){this.animationLineArr=e;for(var t,i=0,o=0;o<this.animationLineArr.length;o++){1<this.animationLineArr.length&&(this.animationLineArr[o].isSetCenter=!1);var r=this.animationLineArr[o].getAllSegCount();i<r&&(t=this.animationLineArr[o],i=r),this.animationLineArr[o].unRedraw=!0}t.unRedraw=!1},e.prototype.start=function(){for(var e=0;e<this.animationLineArr.length;e++)this.animationLineArr[e].start()},e.prototype.stop=function(){for(var e=0;e<this.animationLineArr.length;e++)this.animationLineArr[e].stop()},e.prototype.restart=function(){for(var e=0;e<this.animationLineArr.length;e++)this.animationLineArr[e].restart()},e.prototype.continus=function(){for(var e=0;e<this.animationLineArr.length;e++)this.animationLineArr[e].continus()},e.prototype.pause=function(){for(var e=0;e<this.animationLineArr.length;e++)this.animationLineArr[e].pause()}}(),function(o){function e(e,t,i){var o;this._line_layer_name="my-line-layer",this._line_layer_source="my-line-source",this._point_animate_layer_name="my-point-animate-layer",this._line_animate_layer_source="my-line-animate-source",this._line_animate_layer_name="my-line-animate-layer",this._flowIdentityBackFiled="flowIdentityBack",this._flowIdentityValueLength=1,this._flowIdentityPlayHandler=0,this._map=e._obj,this._opts=this._mergeOpts(i),this.__animateFps=1e3/this._opts.flowFps,this._animageLineSegLength=this._opts.flowLineSegLength,this._data=this._processedData(e,t),this._animatePointHandler=0,this._animatePointFlag=!0,this._animateLineHandler=0,this._animateLineFlag=!0,this._lineItemlengthArr=[],this._lineItemlengthArrBack=[],this._publisher=new MapPlatForm.Base.publisher,this._map.loaded()?this._addLayers():(o=this)._map.on("load",function(){o._addLayers()})}e.prototype.subscribePlayTopic=function(e){this._publisher.subscribe("spriteLine-play","identity",e)},e.prototype.cancelPlayTopic=function(){this._publisher.cancel("spriteLine-play","identity")},e.prototype.destroy=function(){if("visible"===this._opts.lineVisibility&&(this._map.removeLayer(this._line_layer_name),this._map.removeSource(this._line_layer_source)),this._opts.flow){this.removeFlowIdentityPlay();var i=this;if(this._data.map(function(e){var t=e.properties;return void 0!==t[i._flowIdentityBackFiled]&&(t[i._opts.flowIdentity]=t[i._flowIdentityBackFiled],t[i._flowIdentityBackFiled]=void 0,e.properties=t),e}),"point"===this._opts.flowType)this._map.removeLayer(this._point_animate_layer_name),this._map.removeSource(this._point_animate_layer_name),this._animatePointFlag=!1,o.cancelAnimationFrame(this._animatePointHandler);else{for(var e=0,t=this._opts.animateLineLayerFilters.length;e<t;e++)this._map.removeLayer(this._line_animate_layer_name+"_"+e);this._map.removeSource(this._line_animate_layer_source),this._animateLineFlag=!1,o.cancelAnimationFrame(this._animateLineHandler)}}},e.prototype.show=function(){if("visible"===this._opts.lineVisibility&&this._map.setLayoutProperty(this._line_layer_name,"visibility","visible"),this._opts.flow)if("point"===this._opts.flowType)this._map.setLayoutProperty(this._point_animate_layer_name,"visibility","visible");else for(var e=0,t=this._opts.animateLineLayerFilters.length;e<t;e++)this._map.setLayoutProperty(this._line_animate_layer_name+"_"+e,"visibility","visible")},e.prototype.hide=function(){if("visible"===this._opts.lineVisibility&&this._map.setLayoutProperty(this._line_layer_name,"visibility","none"),this._opts.flow)if("point"===this._opts.flowType)this._map.setLayoutProperty(this._point_animate_layer_name,"visibility","none");else for(var e=0,t=this._opts.animateLineLayerFilters.length;e<t;e++)this._map.setLayoutProperty(this._line_animate_layer_name+"_"+e,"visibility","none")},e.prototype.disableFlow=function(){if(this._opts.flow)if("point"===this._opts.flowType)this._animatePointFlag&&(this._animatePointFlag=!1,this._map.setLayoutProperty(this._point_animate_layer_name,"visibility","none"));else if(this._animateLineFlag){this._animateLineFlag=!1;for(var e=0,t=this._opts.animateLineLayerFilters.length;e<t;e++)this._map.setLayoutProperty(this._line_animate_layer_name+"_"+e,"visibility","none")}},e.prototype.enableFlow=function(){if(this._opts.flow)if("point"===this._opts.flowType)this._animatePointFlag||(this._animatePointFlag=!0,this._map.setLayoutProperty(this._point_animate_layer_name,"visibility","visible"),this._animatePoint());else if(!this._animateLineFlag){this._animateLineFlag=!0;for(var e=0,t=this._opts.animateLineLayerFilters.length;e<t;e++)this._map.setLayoutProperty(this._line_animate_layer_name+"_"+e,"visibility","visible");this._animateLine()}},e.prototype.addFlow=function(){if(!this._opts.flow)if(this._opts.flow=!0,this._opts.flowIdentityPlay=!1,"point"===this._opts.flowType){this._animatePointFlag=!0;for(var e=JSON.parse('{"type":"FeatureCollection","features":[]}'),t=[],i=0,o=this._data.length;i<o;i++){var r={type:"Feature"},a={type:"Point",coordinates:(n=(h=this._data[i].geometry).coordinates)[0]};r.geometry=a,t.push(r)}e.features=t,this._addAnimatePointLayer(e)}else{this._animateLineFlag=!0;for(var e=JSON.parse('{"type":"FeatureCollection","features":[]}'),s=[],i=0,o=this._data.length;i<o;i++){var n,l={type:"Feature"},h=this._data[i].geometry,p=this._data[i].properties,c=[(n=h.coordinates)[n.length-1]];l.geometry={type:"LineString",coordinates:c},l.properties=p,s.push(l)}e.features=s,this._addAnimateLineLayer(e)}},e.prototype.removeFlow=function(){if(this._opts.flow){if(this.removeFlowIdentityPlay(),"point"===this._opts.flowType)this._map.removeLayer(this._point_animate_layer_name),this._map.removeSource(this._point_animate_layer_name),this._animatePointFlag=!1,o.cancelAnimationFrame(this._animatePointHandler);else{for(var e=0,t=this._opts.animateLineLayerFilters.length;e<t;e++)this._map.removeLayer(this._line_animate_layer_name+"_"+e);this._map.removeSource(this._line_animate_layer_source),this._animateLineFlag=!1,o.cancelAnimationFrame(this._animateLineHandler)}this._opts.flow=!1}},e.prototype.addFlowIdentityPlay=function(){if(!this._opts.flow)throw"flow 属性必须为 true !";var e;this._opts.flowIdentityPlay||1===this._flowIdentityValueLength||(e=this._map.getSource(this._line_animate_layer_source)._data,this._cycleUpdateAnimateLineSourceFlowIdentityValue(e),this._opts.flowIdentityPlay=!0)},e.prototype.removeFlowIdentityPlay=function(){var e;this._opts.flowIdentityPlay&&1!==this._flowIdentityValueLength&&(o.clearInterval(this._flowIdentityPlayHandler),e=this._map.getSource(this._line_animate_layer_source)._data,this._updateAnimateLineSourceFlowIdentityValue(e,0),this._opts.flowIdentityPlay=!1)},e.prototype._mergeOpts=function(e){var t={lineColor:"#ff0000",lineWidth:1,lineOpacity:1,lineDasharray:[-1,-1],lineBlur:0,lineVisibility:"visible",flow:!0,flowType:"point",flowFps:60,flowIdentity:void 0,flowIdentityPlay:!1,flowIdentityPlayInterval:3e4,flowLineSegLength:15,flowLineSegStepCount:5,flowLineSegStep:1,flowLineColor:"#ffffff",flowLineWidth:2,flowLineOpacity:1,flowLineCap:"round",flowLinejoin:"round",flowLineDasharray:[-1,-1],flowLineBlur:0,flowPointColor:"#ffffff",flowPointSize:2,flowPointBlur:0,flowPointOpacity:1,flowPointStrokeWidth:0,flowPointStrokeColor:"#ffffff",flowPointStrokeOpacity:1};if(e)for(var i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&(t[i]=e[i]);if(void 0!==t.flowLineGradient&&void 0===t.flowIdentity)throw"flowIdentity 属性不正确!";var o={flow:t.flow,flowType:t.flowType,flowFps:t.flowFps,flowIdentity:t.flowIdentity,flowIdentityPlay:t.flowIdentityPlay,flowIdentityPlayInterval:t.flowIdentityPlayInterval,flowLineSegLength:t.flowLineSegLength,flowLineSegStepCount:t.flowLineSegStepCount,flowLineSegStep:t.flowLineSegStep};o.lineLayerPaint={"line-color":t.lineColor,"line-width":t.lineWidth,"line-dasharray":t.lineDasharray,"line-opacity":t.lineOpacity,"line-blur":t.lineBlur},o.lineVisibility=t.lineVisibility;var r=this._animateLineLayerPaintAndFilterBuilder(t);return o.animateLineLayerPaints=r.animateLineLayerPaints,o.animateLineLayerFilters=r.animateLineLayerFilters,o.animateLineLayerLayout={"line-cap":t.flowLineCap,"line-join":t.flowLinejoin},o.animatePointLayerPaint={"circle-radius":t.flowPointSize,"circle-color":t.flowPointColor,"circle-blur":t.flowPointBlur,"circle-opacity":t.flowPointOpacity,"circle-stroke-width":t.flowPointStrokeWidth,"circle-stroke-color":t.flowPointStrokeColor,"circle-stroke-opacity":t.flowPointStrokeOpacity},o},e.prototype._animateLineLayerPaintAndFilterBuilder=function(e){var t=[],i=[],o=e.flowLineGradient;if(void 0!==o&&0<o.length)for(var r=o.length,a=0;a<r;a++){var s=o[a];if(2!==s.length)throw"flowLineGradient 格式错误!";var n,l=s[0],s=s[1];(n={})["line-width"]=e.flowLineWidth,n["line-opacity"]=e.flowLineOpacity,n["line-blur"]=e.flowLineBlur,void 0!==s?n["line-gradient"]=this._paintLineGradientBuilder(s):n["line-dasharray"]=e.flowLineDasharray,i[a]=n;s=o[a+1],s=void 0===s?Number.MAX_VALUE:s[0];t[a]=["all",[">=",e.flowIdentity,l],["<",e.flowIdentity,s]]}else(n={})["line-color"]=e.flowLineColor,n["line-width"]=e.flowLineWidth,n["line-opacity"]=e.flowLineOpacity,n["line-blur"]=e.flowLineBlur,i[0]=n,t[0]=["==","$type","LineString"];return{animateLineLayerPaints:i,animateLineLayerFilters:t}},e.prototype._paintLineGradientBuilder=function(e){var t=["interpolate",["linear"],["line-progress"]],i=e.length;if(0<i)for(var o=0,r=i;o<r;o++)t.push(1/r*o),t.push(e[o]);else t.push(0),t.push("blue"),t.push(1),t.push("red");return t},e.prototype._processedData=function(e,t){t=this._convertData(e,t);return this._calculateLinesSeg(t)},e.prototype._convertData=function(t,e){for(var i=0,o=e.length;i<o;i++)e[i].geometry.coordinates=e[i].geometry.coordinates.map(function(e){e=t.T.setPoint(t,{lon:e[0],lat:e[1]});return[e.lon,e.lat]});return e},e.prototype._calculateLinesSeg=function(e){for(var t=0,i=e.length;t<i;t++){for(var o=e[t].geometry.coordinates,r=[],a=0,s=o.length;a<s;a++)var n=this._calculateLineSeg(o,a),r=r.concat(n);e[t].geometry.coordinates=r}return e},e.prototype._calculateLineSeg=function(e,t){var i=[];if(t+1>=e.length)return i.push(0),i;var o=e[t],r=e[t+1],a=this._getDistance(o,r),s=0;0<this._animageLineSegLength&&(s=Math.round(a/this._animageLineSegLength));for(var n=1;n<s;n++){var l=n/s,h=parseFloat((r[0]-o[0])*l)+parseFloat(o[0]),l=parseFloat((r[1]-o[1])*l)+parseFloat(o[1]);i.push([h,l])}return i.push(e[t+1]),i},e.prototype._getDistance=function(e,t){e=ZenMap.T.helper.webMoctorJW2PM(e[0],e[1]),t=ZenMap.T.helper.webMoctorJW2PM(t[0],t[1]);return Math.sqrt((e.lon-t.lon)*(e.lon-t.lon)+(e.lat-t.lat)*(e.lat-t.lat))},e.prototype._cycleAnimatePoint=function(){var e=this;o.setTimeout(function(){e._animatePointHandler=o.requestAnimationFrame(function(){e._animatePoint()})},this.__animateFps)},e.prototype._animatePoint=function(){if(this._animatePointFlag){for(var e=this._map.getSource(this._point_animate_layer_name)._data,t=0,i=this._data.length;t<i;t++){var o=this._data[t].geometry.coordinates,r=this._lineItemlengthArr[t];0===r&&(r=this._lineItemlengthArr[t]=this._lineItemlengthArrBack[t]),e.features[t].geometry.coordinates=o[r],this._lineItemlengthArr[t]=this._lineItemlengthArr[t]-1}this._map.getSource(this._point_animate_layer_name).setData(e),this._cycleAnimatePoint()}},e.prototype._cycleAnimateLine=function(){var e=this;o.setTimeout(function(){e._animateLineHandler=o.requestAnimationFrame(function(){e._animateLine()})},this.__animateFps)},e.prototype._animateLine=function(){if(this._animateLineFlag){for(var e=this._map.getSource(this._line_animate_layer_source)._data,t=0,i=this._data.length;t<i;t++){var o=this._data[t].geometry.coordinates,r=this._lineItemlengthArr[t];r<0&&(r=this._lineItemlengthArr[t]=this._lineItemlengthArrBack[t],e.features[t].geometry.coordinates=[]);var a=e.features[t].geometry.coordinates;a.length===this._opts.flowLineSegStepCount&&a.shift(),a.push(o[r]),e.features[t].geometry.coordinates=a,this._lineItemlengthArr[t]=this._lineItemlengthArr[t]-this._opts.flowLineSegStep}this._map.getSource(this._line_animate_layer_source).setData(e),this._cycleAnimateLine()}},e.prototype._addLayers=function(){for(var e=JSON.parse('{"type":"geojson","data":{"type":"FeatureCollection","features":[]}}'),t=JSON.parse('{"type":"FeatureCollection","features":[]}'),i=JSON.parse('{"type":"FeatureCollection","lineMetrics":true,"features":[]}'),o=[],r=[],a=[],s=0,n=this._data.length;s<n;s++){var l={type:"Feature"},h={type:"Feature"},p={type:"Feature"},c=this._data[s].geometry,u=c.coordinates;"visible"===this._opts.lineVisibility&&(l.geometry=c,o.push(l));l=u.length-1;this._lineItemlengthArr.push(l),this._lineItemlengthArrBack.push(l);u={type:"Point",coordinates:u[0]};h.geometry=u,r.push(h);p.geometry={type:"LineString",coordinates:[]},p.properties=this._processAnimateLineSourceProperties(this._data[s].properties),a.push(p)}e.data.features=o,t.features=r,i.features=a,"visible"===this._opts.lineVisibility&&this._addLineLayer(e),"line"===this._opts.flowType?(this._addAnimateLineLayer(i),this._opts.flow&&this._opts.flowIdentityPlay&&1!==this._flowIdentityValueLength&&this._cycleUpdateAnimateLineSourceFlowIdentityValue(i)):this._addAnimatePointLayer(t)},e.prototype._processAnimateLineSourceProperties=function(e){var t=e[this._opts.flowIdentity];return t instanceof Array&&(e[this._opts.flowIdentity]=t[0],e[this._flowIdentityBackFiled]=t,this._flowIdentityValueLength=t.length),e},e.prototype._updateAnimateLineSourceFlowIdentityValue=function(e,i){var o;void 0!==e&&(o=this,e.features.map(function(e){var t=e.properties;return t[o._opts.flowIdentity]=t[o._flowIdentityBackFiled][i],e.properties=t,e}),this._publisher.publish({name:"spriteLine-play",callback:"identity"},i))},e.prototype._cycleUpdateAnimateLineSourceFlowIdentityValue=function(e){var t=0,i=this;this._flowIdentityPlayHandler=o.setInterval(function(){i._opts.flowIdentityPlay&&(t>i._flowIdentityValueLength-1&&(t=0),i._updateAnimateLineSourceFlowIdentityValue(e,t),t++)},this._opts.flowIdentityPlayInterval)},e.prototype._addLineLayer=function(e){this._map.addSource(this._line_layer_source,e);e=this._getBuildingLayerId();this._map.addLayer({id:this._line_layer_name,type:"line",source:this._line_layer_source,paint:this._opts.lineLayerPaint,filter:["==","$type","LineString"]},e)},e.prototype._addAnimateLineLayer=function(e){if(this._opts.flow){this._map.addSource(this._line_animate_layer_source,{type:"geojson",lineMetrics:!0,data:e});for(var t=this._getBuildingLayerId(),i=0,o=this._opts.animateLineLayerFilters.length;i<o;i++)this._map.addLayer({id:this._line_animate_layer_name+"_"+i,type:"line",source:this._line_animate_layer_source,filter:this._opts.animateLineLayerFilters[i],layout:this._opts.animateLineLayerLayout,paint:this._opts.animateLineLayerPaints[i]},t);this._animateLine()}},e.prototype._addAnimatePointLayer=function(e){var t;this._opts.flow&&(t=this._getBuildingLayerId(),this._map.addLayer({id:this._point_animate_layer_name,type:"circle",source:{type:"geojson",data:e},paint:this._opts.animatePointLayerPaint},t),this._animatePoint())},e.prototype._getBuildingLayerId=function(){return void 0===this._map.getLayer("city_normal_building_id")?null:"city_normal_building_id"},o.MapPlatForm.Base.SpriteLine=e}(window),function(){function e(){this.callbacks={},this.preCallbacks={}}e.prototype={subscribe:function(e,t,i){e&&t&&i&&(this.callbacks[e]||(this.callbacks[e]={}),this.callbacks[e][t]=i,this.preCallbacks[e]&&this.preCallbacks[e][t]&&this.preCallbacks[e][t].length&&(i.apply(this,this.preCallbacks[e][t][0]),delete this.preCallbacks[e][t]))},cancel:function(e,t){e&&this.callbacks[e]&&(t?delete this.callbacks[e][t]:this.callbacks[e]=[])},publish:function(){var e=Array.prototype.shift.call(arguments);if(e&&e.name){var t=arguments;if(this.callbacks[e.name])if(e.callback)this.callbacks[e.name][e.callback]&&this.callbacks[e.name][e.callback].apply(this,t);else for(var i in this.callbacks[e.name])this.callbacks[e.name][i].apply(this,t);else this.preCallbacks[e.name]||(this.preCallbacks[e.name]={}),this.preCallbacks[e.name][e.callback]||(this.preCallbacks[e.name][e.callback]=[]),this.preCallbacks[e.name][e.callback][0]=t}}},window.MapPlatForm.Base.publisher=e}(window),MapPlatForm.Base.MapShapRegion=function(e,t,i){this.geoRegion=t;var o=++ZenMap.LayerIndex;this._layerID="RegionLayer"+o,this.CLASS_NAME="MapPlatForm.Base.MapShapRegion",this._map=e;e=GeoJSON.read(t.geometry);this.fullExtent=e.getExtent(),this._layers=[],this._regions=[],this.acvtiveLayer=null,this.acvtiveRegion=null,this.opts=i||{},this.fillColor=this.opts.fillColor||"#1a65fb",this.lineColor=this.opts.lineColor||"#FFFFFF",this.outLineColor=this.opts.outLineColor||"#FFFFFF",this.sharderFillColor=this.opts.sharderFillColor||"#3961b1",this.showSharder=void 0===this.opts.showSharder||this.opts.showSharder,this.sharderLineColor=this.opts.sharderLineColor||"#1040a0",this.outLineWidth=this.opts.outLineWidth||4,this.innerLineWidth=this.opts.innerLineWidth||1,this.opacity=this.opts.opacity||.5,this.lineOpacity=this.opts.lineOpacity||.5,this.hoverOpacity=this.opts.hoverOpacity||.5,this.hoverColor=this.opts.hoverColor,this.hoverStrokeColor=this.opts.hoverStrokeColor||"#FFFFFF",this.font=this.opts.font||"14px 宋体",this.fontColor=this.opts.fontColor||"#000000",this.sharderWidth=this.opts.sharderWidth||20,this.showName=void 0===this.opts.showName||this.opts.showName,this.minZoom=this.opts.minZoom||7,this.maxZoom=this.opts.maxZoom||12,this.mouseOver=this.opts.mouseOver||function(){},this.mouseOut=this.opts.mouseOut||function(){},this.click=this.opts.click||function(){},this._source={type:"geojson",data:{type:"FeatureCollection",features:[]}},this.labelLayer={id:this._layerID+"_symbol",type:"symbol",source:this._layerID+"_source",layout:{"text-field":"{title}","text-font":["Microsoft YaHei"],"text-size":["get","text-size"],"text-offset":["get","text-offset"],"text-anchor":"center"},paint:{"text-color":["get","text-color"],"text-opacity":1},filter:["==","$type","Point"]},this.addGeoRegions(t)},MapPlatForm.Base.MapShapRegion.prototype._getFeature=function(e){if(12<=this._map.getZoom())return[];for(var t=this._map._obj.style._order.length-1;0<=t;t--)if(-1<this._map._obj.style._order[t].indexOf(this._layerID+"_polygon")){var i=this._map._obj.style._order[t];if("none"!=this._map._obj.getLayoutProperty(i,"visibility")){i=this._map._obj.queryRenderedFeatures(e.point,{layers:[i]});if(i&&0<i.length)return[i[0]]}}return[]},MapPlatForm.Base.MapShapRegion.prototype._mouseout=function(){this.mouseOut&&this.acvtiveRegion&&(this._map._obj.getCanvas().style.cursor="",this.mouseOut(this.acvtiveRegion),this.acvtiveRegion=null,this.refresh())},MapPlatForm.Base.MapShapRegion.prototype._initInteractive=function(e){this._map._events.through=!0;var r=this;this._moveFun||(this._moveFun=function(e){var t,i,o;r.showSharder&&(t=r._map._obj.getBearing(),o=r._map._obj.getPitch()*r.sharderWidth/60,i=0-Math.sin(t/180*Math.PI)*o,o=Math.cos(t/180*Math.PI)*o,r._map._obj.setPaintProperty(r._layerID+"_sharderPolygon","fill-translate",[i,o]))}),this._mouseMoveFun||(this._mouseMoveFun=function(e){e=r._getFeature(e);0!=e.length?12<=r._map.getZoom()||r.acvtiveRegion&&e[0].properties.id==r.acvtiveRegion.id||(r._mouseout(),e&&0<e.length&&(r._map._obj.getCanvas().style.cursor="pointer",r.acvtiveRegion=r._regions[e[0].properties.index],r.mouseOver&&r.acvtiveRegion&&(r.refresh(),r.mouseOver(r.acvtiveRegion)))):r._mouseout()}),this._clickFun||(this._clickFun=function(){r.acvtiveRegion&&r.click(r.acvtiveRegion)}),e?(this._map._obj.off("move",this._moveFun),this._map._obj.off("mousemove",this._mouseMoveFun),this._map._obj.off("click",this._clickFun)):(this._map._obj.on("move",this._moveFun),this._map._obj.on("mousemove",this._mouseMoveFun),this._map._obj.on("click",this._clickFun))},MapPlatForm.Base.MapShapRegion.prototype.addGeoRegions=function(e){if(e.districts){for(var t,i,o=0;o<e.districts.length;o++)e.districts[o]&&(i=GeoJSON.read(e.districts[o].geometry),e.districts[o].id=i.id,this._regions.push(e.districts[o]),t={type:"Feature",geometry:{type:e.districts[o].geometry.type,coordinates:i._getCoordinates(this._map)},properties:{id:i.id,fillColor:e.districts[o].fillColor||this.fillColor,index:o,children:1}},this._source.data.features.push(t),this.showName&&(i={type:"Feature",geometry:{type:"Point",coordinates:[i.getCenter().lon,i.getCenter().lat]},properties:{id:i.id,title:e.districts[o].name,"text-offset":[0,1],"text-opacity":1,"text-size":12,"text-color":this.fontColor,visible:!0,index:o}},this._source.data.features.push(i)));var r=GeoJSON.read(e.geometry),r={type:"Feature",geometry:{type:e.geometry.type,coordinates:r._getCoordinates(this._map)},properties:{id:r.id,children:0}};this._source.data.features.push(r),this._map._obj.addSource(this._layerID+"_source",this._source),this._addLayers()}this._initInteractive()},MapPlatForm.Base.MapShapRegion.prototype._addLayers=function(){var e=this._map._obj.getBearing(),t=this._map._obj.getPitch()*this.sharderWidth/60,i=0-Math.sin(e/180*Math.PI)*t,t=Math.cos(e/180*Math.PI)*t,t={id:this._layerID+"_sharderPolygon",type:"fill",source:this._layerID+"_source",paint:{"fill-color":this.sharderFillColor,"fill-opacity":["interpolate",["linear"],["zoom"],this.minZoom,.5,this.maxZoom,0],"fill-translate-anchor":"map","fill-translate":[i,t]},filter:["all",["==","$type","Polygon"],["==","children",0]]};this.showSharder&&(this._map._obj.addLayer(t),this._layers.push(t));t={id:this._layerID+"_polygon",type:"fill",source:this._layerID+"_source",paint:{"fill-color":["get","fillColor"],"fill-opacity":["interpolate",["linear"],["zoom"],this.minZoom,this.opacity,this.maxZoom,0],"fill-translate-anchor":"map"},filter:["all",["==","$type","Polygon"],["==","children",1]]};this._map._obj.addLayer(t),this._layers.push(t);t={id:this._layerID+"_Line",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":this.lineColor,"line-width":this.innerLineWidth,"line-opacity":["interpolate",["linear"],["zoom"],this.minZoom,this.lineOpacity,this.maxZoom,0]},filter:["all",["==","$type","Polygon"],["==","children",1]]};this._map._obj.addLayer(t),this._layers.push(t);t={id:this._layerID+"_parentLine",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":this.outLineColor,"line-width":this.outLineWidth,"line-opacity":["interpolate",["linear"],["zoom"],this.minZoom,this.lineOpacity,this.maxZoom,0]},filter:["all",["==","$type","Polygon"],["==","children",0]]};this._map._obj.addLayer(t),this._layers.push(t),this.acvtiveLayer={id:this._layerID+"_polygonActive",type:"fill",source:this._layerID+"_source",paint:{"fill-color":this.hoverColor||["get","fillColor"],"fill-opacity":["interpolate",["linear"],["zoom"],this.minZoom,this.hoverOpacity,this.maxZoom,0],"fill-translate-anchor":"map"},filter:["all",["==","$type","Polygon"],["==","children",1],["==","id",""]]},this._map._obj.addLayer(this.acvtiveLayer),this._layers.push(this.acvtiveLayer);t={id:this._layerID+"_activeLine",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":this.hoverStrokeColor,"line-width":this.innerLineWidth,"line-opacity":["interpolate",["linear"],["zoom"],this.minZoom,this.lineOpacity,this.maxZoom,0]},filter:["all",["==","$type","Polygon"],["==","children",1],["==","id",""]]};this._map._obj.addLayer(t),this._layers.push(t),this.showName&&(this._map._obj.addLayer(this.labelLayer),this._layers.push(this.labelLayer))},MapPlatForm.Base.MapShapRegion.prototype.destory=function(){if(this._map){this._initInteractive(!0);for(var e=0;e<this._layers.length;e++)this._map._obj.removeLayer(this._layers[e].id);this._map._obj.removeSource(this._layerID+"_source"),this._map=null}this._regions=[],this._layers=[],this.acvtiveRegion=null},MapPlatForm.Base.MapShapRegion.prototype.refresh=function(){this.acvtiveRegion?(this._map._obj.setFilter(this._layerID+"_polygon",["all",["==","$type","Polygon"],["==","children",1],["!=","id",this.acvtiveRegion.id]]),this._map._obj.setFilter(this._layerID+"_polygonActive",["all",["==","$type","Polygon"],["==","children",1],["==","id",this.acvtiveRegion.id]]),this._map._obj.setFilter(this._layerID+"_activeLine",["all",["==","$type","Polygon"],["==","children",1],["==","id",this.acvtiveRegion.id]])):(this._map._obj.setFilter(this._layerID+"_polygon",["all",["==","$type","Polygon"],["==","children",1]]),this._map._obj.setFilter(this._layerID+"_polygonActive",["all",["==","$type","Polygon"],["==","children",1],["==","id",""]]),this._map._obj.setFilter(this._layerID+"_activeLine",["all",["==","$type","Polygon"],["==","children",1],["==","id",""]]))},MapPlatForm.Base.MapMultiMarkers=function(e,t){this.CLASS_NAME="MapMultiMarkers",this._layerID=ZenMap.Utils.BaseUtils.uuid(),this._map=e,this._markers=[],this._showMarkers=[],this._imgMarkers={},this.acvtivePoint=null,this.activeFeature=null,this._points={},this.mouseOver=t?t.mouseOver:null,this.mouseOut=t?t.mouseOut:null,this.click=t?t.click:null,this._source={type:"geojson",data:{type:"FeatureCollection",features:[]}},this._markerLayer={id:this._layerID+"_symbol",type:"symbol",source:this._layerID+"_source",layout:{"icon-image":["get","icon"],"text-field":"{title}","text-font":["Microsoft YaHei"],"text-offset":["get","text-offset"],"icon-offset":["get","icon-offset"],"icon-size":["get","icon-size"],"text-size":["get","text-size"],"icon-allow-overlap":!0,"text-allow-overlap":!0,"icon-ignore-placement":!0,"text-anchor":"center"},paint:{"text-color":["get","text-color"],"text-opacity":["get","text-opacity"],"icon-opacity":["get","icon-opacity"]},filter:["==","$type","Point"]},this._activeMarkerLayer={id:this._layerID+"_activeSymbol",type:"symbol",source:this._layerID+"_source",layout:{"icon-image":["get","icon"],"text-field":"{title}","text-font":["Microsoft YaHei"],"text-offset":["get","text-offset"],"icon-offset":["get","icon-offset"],"icon-size":["get","icon-size"],"text-size":["get","text-size"],"icon-allow-overlap":!0,"text-allow-overlap":!0,"icon-ignore-placement":!0,"text-anchor":"center"},paint:{"text-color":["get","text-color"],"text-opacity":["get","text-opacity"],"icon-opacity":["get","icon-opacity"]},filter:["==","$type","Point"]}},MapPlatForm.Base.MapMultiMarkers.prototype._getFeature=function(e){for(var t=this._map._obj.style._order.length-1;0<=t;t--)if(-1<this._map._obj.style._order[t].indexOf(this._layerID)){var i=this._map._obj.style._order[t];if("none"!=this._map._obj.getLayoutProperty(i,"visibility")){i=this._map._obj.queryRenderedFeatures(e.point,{layers:[i]});if(i&&0<i.length)return[i[0]]}}return[]},MapPlatForm.Base.MapMultiMarkers.prototype._mouseout=function(){this._map._obj.getCanvasContainer().style.cursor="",this.mouseOut&&this.activePoint&&this.mouseOut(this.activePoint),this.activeFeature=null,this.activePoint=null},MapPlatForm.Base.MapMultiMarkers.prototype._initInteractive=function(e){var t=this;this._mousemoveFun||(this._mousemoveFun=function(e){e=t._getFeature(e);0!=e.length?t.activeFeature&&e[0].properties.id==t.activeFeature.properties.id||(t._mouseout(),e&&0<e.length&&(t._map._obj.getCanvasContainer().style.cursor="pointer",t.activeFeature=e[0],t.activePoint=t._points[e[0].properties.id],t.mouseOver&&t.activePoint&&(t.mouseOver(t.activePoint),t._map._obj.setFilter(t._activeMarkerLayer.id,["==","id",t.activePoint.id])))):t._mouseout()}),this._clickFun||(this._clickFun=function(){t.activePoint&&t.click(t.activePoint)}),e?(this._map._obj.off("mousemove",this._mousemoveFun),this._map._obj.off("click",this._clickFun)):(this._map._obj.on("mousemove",this._mousemoveFun),this._map._obj.on("click",this._clickFun))},MapPlatForm.Base.MapMultiMarkers.prototype.addMarkers=function(e){if(e&&0<e.length)for(var t,i,o=0;o<e.length;o++)e[o].opts.url&&(this._points[e[o].id]=e[o],t=ZenMap.T.setPoint(this._map,e[o]),i=e[o].opts||{},this._source.data.features.push({type:"Feature",geometry:{type:"Point",coordinates:[t.lon,t.lat]},properties:{id:e[o].id,layerId:this._layerID,title:i.label||"",icon:i.url,"icon-offset":i.iconOffset||void 0,"text-offset":i.labelOffset||void 0,"text-opacity":i.textOpacity||1,"icon-opacity":i.iconOpacity||1,"icon-rotate":i.rotation||void 0,"icon-size":i.iconSize||1,"text-size":i.fontSize||12,"icon-rotation-alignment":i.showInMap?"map":"viewport","text-color":i.fontColor||void 0}}));this._map._obj.getSource(this._layerID)?this._map._obj.getSource(this._layerID+"_source").setData(this._source.data):(this._map._obj.addSource(this._layerID+"_source",this._source),this._map._obj.addLayer(this._markerLayer),this._map._obj.addLayer(this._activeMarkerLayer)),this._initInteractive()},MapPlatForm.Base.MapMultiMarkers.prototype.setStyle=function(e){this._map&&!this._map._obj.getLayer(this._layerID+"_activeSymbol")&&(e&&e.url&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","icon-image",e.url),e&&e.iconSize&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","icon-size",e.iconSize),e&&e.fontSize&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","text-size",e.fontSize),e&&e.fontColor&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","text-color",e.fontColor),e&&e.iconOffset&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","icon-offset",e.iconOffset),e&&e.textOffset&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","text-offset",e.textOffset),e&&e.label&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","text-field",e.label))},MapPlatForm.Base.MapMultiMarkers.prototype.destory=function(){this._map&&(this._initInteractive(!0),this._map._obj.removeLayer(this._markerLayer.id),this._map._obj.removeLayer(this._activeMarkerLayer.id),this._map._obj.removeSource(this._layerID+"_source"),this._map=null),this.activeFeature=null,this.activePoint=null,this._points={}},MapPlatForm.Base.MapMultiMarkers.prototype.refresh=function(){this._map&&this._map._obj.getSource(this._layerID)&&this._map._obj.getSource(this._layerID+"_source").setData(this._source.data)},MapPlatForm.Base.MapMultiMarkers.prototype.setVisibile=function(e){e?(this._map._obj.getLayer(this._layerID+"_symbol")&&this._map._obj.setLayoutProperty(this._layerID+"_symbol","visibility","visible"),this._map._obj.getLayer(this._layerID+"_activeSymbol")&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","visibility","visible")):(this._map._obj.getLayer(this._layerID+"_symbol")&&this._map._obj.setLayoutProperty(this._layerID+"_symbol","visibility","none"),this._map._obj.getLayer(this._layerID+"_activeSymbol")&&this._map._obj.setLayoutProperty(this._layerID+"_activeSymbol","visibility","none"))},function(){function m(e,t,i){this.lonLats=e,this.context=t,this.opts=i,this.visibile=!0,this.pixels=[],this.nears=[],this.defaultStrokeColor="rgb(255,255,255)",this.strokeColor=this.defaultStrokeColor,this.fillColor=(this.strokeColor.substring(0,this.strokeColor.lastIndexOf(")"))+",1)").replace("rgb","rgba"),this.defaultFillColor=this.fillColor,this.backOffset=[40,0],this.acvtiveOffset=[5,0],this.font="18px 微软雅黑",this.fontColor="#000000",this.value=1,this.mainValue=1e3,this.center=this.opts.center||null,this.name=this.opts.name||"",this.resetStyle=function(){this.fillColor=this.defaultFillColor,this.strokeColor=this.defaultStrokeColor},this.reset=function(e,t,i,o){this.resetStyle(),this.pixels=[];for(var r=0,a=0,s=0,n=0;n<this.lonLats.length;n++)el={x:t.x+(this.lonLats[n][0]-e.lon)/i,y:t.y-(this.lonLats[n][1]-e.lat)/i},r+=el.x,a+=el.y,s++,this.pixels.push(el);this.centerXY={x:r/s,y:a/s},this.center&&o&&(this.centerXY={x:t.x+(this.center.lon-e.lon)/i,y:t.y-(this.center.lat-e.lat)/i})},this.draw=function(){if(0!=this.pixels.length){this.context.beginPath(),this.context.moveTo(this.pixels[0].x,this.pixels[0].y);for(var e,t=1;t<this.pixels.length;t++)this.context.lineTo(this.pixels[t].x,this.pixels[t].y);this.context.closePath(),this.gradientColor1&&this.gradientColor2?((e=this.context.createLinearGradient(this.context.canvas.width/2,0,this.context.canvas.width/2,this.context.canvas.height)).addColorStop(0,this.gradientColor1),e.addColorStop(1,this.gradientColor2),this.context.fillStyle=e):this.context.fillStyle=this.fillColor,this.context.fill()}},this.drawLine=function(){if(0!=this.pixels.length){this.context.beginPath(),this.context.lineJoin="round",this.context.moveTo(this.pixels[0].x,this.pixels[0].y);for(var e=1;e<this.pixels.length;e++)this.context.lineTo(this.pixels[e].x,this.pixels[e].y);this.context.closePath(),this.context.strokeStyle=this.strokeColor,this.context.lineWidth=1,this.context.stroke()}},this.drawTJ=function(e){var t;void 0!==this.value&&(t=this.context.createLinearGradient(this.centerXY.x-5,this.centerXY.y-85*this.value,this.centerXY.x-5,this.centerXY.y-20),e?(t.addColorStop(0,this._getOpacityColor(this.TJActivecolor)),t.addColorStop(1,this.TJActivecolor)):(t.addColorStop(0,this._getOpacityColor(this.TJcolor)),t.addColorStop(1,this.TJcolor)),this.context.fillStyle=t,this.context.fillRect(this.centerXY.x-5,this.centerXY.y-20-85*this.value,10,85*this.value),0<this.mainValue&&(this.context.beginPath(),this.context.arc(this.centerXY.x,this.centerXY.y-20-.5,5,0,Math.PI),this.context.fill()),this.name&&this.centerXY&&(this.context.textAlign="center",this.context.font="italic small-caps bold 14px arial",this.context.fillStyle=e?this.TJActivetextcolor:this.TJtextcolor,this.context.fillText(this.mainValue,this.centerXY.x,this.centerXY.y-85*this.value-30),this.context.restore()))},this._getOpacityColor=function(e){return-1<e.indexOf("rgba")?e=e.substring(0,e.lastIndexOf(","))+",0)":-1<e.indexOf("rgb")&&(e=(e=e.replace("rgb","rgba")).substring(0,xx.indexOf(")"))+",0)"),e},this.drawTJ2=function(e){var t;void 0!==this.value&&((t=this.context.createLinearGradient(this.centerXY.x-5,this.centerXY.y-85*this.value*e,this.centerXY.x-5,this.centerXY.y-20)).addColorStop(0,this._getOpacityColor(this.TJcolor)),t.addColorStop(1,this.TJcolor),this.context.fillStyle=t,this.context.fillRect(this.centerXY.x-5,this.centerXY.y-20-85*this.value*e,10,85*this.value*e),0<this.mainValue&&(this.context.beginPath(),this.context.arc(this.centerXY.x,this.centerXY.y-.5-20,5,0,Math.PI),this.context.fill()),this.name&&this.centerXY&&(this.context.textAlign="center",this.context.font="italic small-caps bold 14px arial",this.context.fillStyle=this.TJtextcolor,this.context.fillText(Math.ceil(this.mainValue*e),this.centerXY.x,this.centerXY.y-85*this.value*e-30),this.context.restore()))},this.drawBack=function(){if(0!=this.pixels.length){for(var e=1;e<this.pixels.length-1;e++){this.context.save(),this.context.beginPath(),this.context.moveTo(this.pixels[e].x+this.backOffset[0],this.pixels[e].y+this.backOffset[1]),this.context.lineTo(this.pixels[e+1].x+this.backOffset[0],this.pixels[e+1].y+this.backOffset[1]),this.context.lineTo(this.pixels[e+1].x,this.pixels[e+1].y),this.context.lineTo(this.pixels[e].x,this.pixels[e].y),this.context.closePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.beginPath(),this.context.moveTo(this.pixels[e].x+this.backOffset[0],this.pixels[e].y+this.backOffset[1]),this.context.lineTo(this.pixels[e+1].x+this.backOffset[0],this.pixels[e+1].y+this.backOffset[1]),this.context.lineTo(this.pixels[e+1].x,this.pixels[e+1].y),this.context.lineTo(this.pixels[e].x,this.pixels[e].y),this.context.closePath();var t=(this.pixels[e+1].x+this.pixels[e].x)/2,i=(this.pixels[e+1].y+this.pixels[e].y)/2,i=this.context.createLinearGradient(t,i,t+this.backOffset[0],i+this.backOffset[1]);i.addColorStop(0,this.backShaderColor),i.addColorStop(1,this.backShaderColor2),this.context.fillStyle=i,this.context.fill()}this.context.save(),this.context.beginPath(),this.context.moveTo(this.pixels[0].x,this.pixels[0].y);for(e=1;e<this.pixels.length;e++)this.context.lineTo(this.pixels[e].x,this.pixels[e].y);this.context.closePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore()}},this.drawActive=function(){if(0!=this.pixels.length)if(this.JianBian){this.context.beginPath(),this.context.moveTo(this.pixels[0].x,this.pixels[0].y);for(e=1;e<this.pixels.length;e++)this.context.lineTo(this.pixels[e].x,this.pixels[e].y);this.context.closePath(),this.context.fillStyle=this.hoverColor,this.context.fill()}else{for(var e=1;e<this.pixels.length-1;e++)this.context.save(),this.context.beginPath(),this.context.moveTo(this.pixels[e].x-this.acvtiveOffset[0],this.pixels[e].y-this.acvtiveOffset[1]),this.context.lineTo(this.pixels[e+1].x-this.acvtiveOffset[0],this.pixels[e+1].y-this.acvtiveOffset[1]),this.context.lineTo(this.pixels[e+1].x,this.pixels[e+1].y),this.context.lineTo(this.pixels[e].x,this.pixels[e].y),this.context.closePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.beginPath(),this.context.moveTo(this.pixels[e].x-this.acvtiveOffset[0],this.pixels[e].y-this.acvtiveOffset[1]),this.context.lineTo(this.pixels[e+1].x-this.acvtiveOffset[0],this.pixels[e+1].y-this.acvtiveOffset[1]),this.context.lineTo(this.pixels[e+1].x,this.pixels[e+1].y),this.context.lineTo(this.pixels[e].x,this.pixels[e].y),this.context.closePath(),this.context.fillStyle=this.backShaderColor,this.context.fill();this.context.beginPath(),this.context.moveTo(this.pixels[0].x-this.acvtiveOffset[0],this.pixels[0].y-this.acvtiveOffset[1]);for(var e=1;e<this.pixels.length;e++)this.context.lineTo(this.pixels[e].x-this.acvtiveOffset[0],this.pixels[e].y-this.acvtiveOffset[1]);this.context.closePath(),this.context.fillStyle=this.hoverColor,this.context.fill()}},this.drawTitle=function(){this.name&&this.centerXY&&(this.context.textAlign="center",this.context.font=this.font,this.context.fillStyle=this.fontColor,this.context.fillText(this.name,this.centerXY.x,this.centerXY.y),this.context.restore())},this.crossMul=function(e,t){return e.x*t.y-e.y*t.x},this.checkCross=function(e,t,i,o){var r={x:e.x-i.x,y:e.y-i.y},a={x:t.x-i.x,y:t.y-i.y},s={x:o.x-i.x,y:o.y-i.y},n=this.crossMul(r,s)*this.crossMul(a,s),r={x:i.x-e.x,y:i.y-e.y},a={x:o.x-e.x,y:o.y-e.y},s={x:t.x-e.x,y:t.y-e.y};return n<=0&&this.crossMul(r,s)*this.crossMul(a,s)<=0},this.containsPoint=function(e,t){for(var i,o,r=e,a={x:-1e5,y:e.y},s=0,n=0;n<t.length-1;n++)i=t[n],o=t[n+1],this.checkCross(r,a,i,o)&&s++;return i=t[t.length-1],o=t[0],this.checkCross(r,a,i,o)&&s++,s%2!=0},this.isContains=function(e){if(void 0!==this.pixels[0].x)return this.containsPoint(e,this.pixels);for(var t=0,i=0;i<this.pixels.length;i++)this.containsPoint(e,this.pixels[i])&&t++;return t%2!=0},this.setStyle=function(e){e&&(e.fillColor&&(this.fillColor=e.fillColor),e.strokeColor&&(this.strokeColor=e.strokeColor))}}MapPlatForm.Base.ShapMap=function(e,t,i){for(var o in this.mapContainer=e,this.CLASS_NAME="MapPlatForm.Base.ShapMap",this.fullExtent=this._getExtent(t),this.scrollTop=0,this._regions=[],this._backRegion=null,this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.left="0px",this.canvas.style.top="0px",this.canvas.width=e.offsetWidth,this.canvas.height=e.offsetHeight,this.canvas.style.pointerEvents="none",this.canvas.style.zIndex=205,e.appendChild(this.canvas),this.canvas.setAttribute("class","olScrollable"),this.context=this.canvas.getContext("2d"),this.canvasActive=document.createElement("canvas"),this.canvasActive.style.position="absolute",this.canvasActive.style.left="0px",this.canvasActive.style.top="0px",this.canvasActive.width=e.offsetWidth,this.canvasActive.height=e.offsetHeight,this.canvasActive.style.pointerEvents="none",this.canvasActive.style.zIndex=206,e.appendChild(this.canvasActive),this.canvasActive.setAttribute("class","olScrollable"),this.contextActive=this.canvasActive.getContext("2d"),this.points=i&&i.points?i.points:[],this.acvtiveRegion=null,this.legendColor=i&&i.legendColor?i.legendColor:{},this.legendValue=i&&i.legendValue?i.legendValue:{},this.maxValue=0,this.showAllTJ=!i||!1!==i.showAllTJ,this.showAllNames=!(!i||!i.showAllNames),this.legendValue)this.legendValue[o]>this.maxValue&&(this.maxValue=this.legendValue[o]);this.maxValue=this.maxValue||100,"{}"===JSON.stringify(this.legendColor)?(this.JianBian=!0,this.gradientColor1=i&&i.gradientColor1?i.gradientColor1:"#3f96c3",this.gradientColor2=i&&i.gradientColor2?i.gradientColor2:"#175579",this.hoverColor=i&&i.hoverColor?i.hoverColor:"#154e6e"):this.hoverColor=i&&i.hoverColor?i.hoverColor:null,this.JianBian?this.backShaderColor=i&&i.backShaderColor?i.backShaderColor:"#11a4b5":this.backShaderColor=i&&i.backShaderColor?i.backShaderColor:"#bcdefd",this.backShaderColor2=i&&i.backShaderColor2?i.backShaderColor2:this.backShaderColor,this.JianBian?this.strokeColor=i&&i.strokeColor?i.strokeColor:"#15b1e5":this.strokeColor=i&&i.strokeColor?i.strokeColor:"#FFFFFF",this.TJcolor=i&&i.TJcolor?i.TJcolor:"rgba(255,198,0,255)",this.TJtextcolor=i&&i.TJtextcolor?i.TJtextcolor:this.TJcolor,this.TJActivecolor=i&&i.TJActivecolor?i.TJActivecolor:"rgba(242,19,75,255)",this.TJActivetextcolor=i&&i.TJActivetextcolor?i.TJActivetextcolor:this.TJActivecolor,this.backOffset=i&&i.backOffset?i.backOffset:[40,0],this.acvtiveOffset=i&&i.acvtiveOffset?i.acvtiveOffset:[5,0],this.font=i&&i.font?i.font:"14px 宋体",this.fontColor=i&&i.fontColor?i.fontColor:"#000000",this.shadowColor=i&&i.shadowColor?i.shadowColor:"rgba(61,154,235,0.2)",this.fillColors=["#7fc3ff","#3d9aeb","#2a7cc4","#215e94"],this.mouseOver=i?i.mouseOver:null,this.mouseOut=i?i.mouseOut:null,this.mouseMove=i?i.mouseMove:null,this.click=i?i.click:null,this.starRadio=i?i.starRadio:3,this.starColor=i?i.starColor:"rgba(255,255,255,0.8)",this._initPoints(),this.addGeoRegions(t)},MapPlatForm.Base.ShapMap.prototype._initInteractive=function(){var r=this;this.mapContainer.onmousemove=function(e){var t={x:e.offsetX,y:e.offsetY};t.y=t.y+r.scrollTop;for(var i=!1,o=0;o<r._regions.length;o++)if(r._regions[o].isContains(t)){if(r._regions[o]==r.acvtiveRegion)return void(r.mouseMove&&r.mouseMove(r.acvtiveRegion,t));i=!0,r.mouseOut&&r.acvtiveRegion&&(r.refresh(),r.mouseOut(r.acvtiveRegion)),r.acvtiveRegion=r._regions[o],r.mouseOver&&(r.refresh(r.acvtiveRegion),r.acvtiveRegion.drawTJ(!0),r.acvtiveRegion.drawTitle(),r.mouseOver(r.acvtiveRegion,t)),r.mouseMove&&r.mouseMove(r.acvtiveRegion,t);break}!i&&r.acvtiveRegion&&(r.mouseOut&&(r.refresh(),r.mouseOut(r.acvtiveRegion)),r.acvtiveRegion=null)},this.mapContainer.onmousedown=function(e){e={x:e.offsetX,y:e.offsetY};r.curentXY=e},this.mapContainer.onclick=function(e){if(e.offsetX==r.curentXY.x&&e.offsetY==r.curentXY.y){var t={x:e.offsetX,y:e.offsetY};t.y=t.y+r.scrollTop;for(var i=0;i<r._regions.length;i++)if(r._regions[i].isContains(t)){isContains=!0,r.click&&r.click(r._regions[i]);break}}}},MapPlatForm.Base.ShapMap.prototype._initPoints=function(){for(var e=[],t=Math.ceil(this.points.length/1e3),i=0;i<this.points.length;i+=t)e.push(this.points[i]);this.points=e},MapPlatForm.Base.ShapMap.prototype._resetAndDrawPoint=function(e,t,i){for(var o=0;o<this.points.length;o++){var r=t.x+(this.points[o][0]-e.lon)/i,a=t.y-(this.points[o][1]-e.lat)/i;this.context.beginPath();var s=this.context.createRadialGradient(r,a,0,r,a,this.starRadio);s.addColorStop(0,this.starColor),s.addColorStop(1,"rgba(255,255,255,0)"),this.context.fillStyle=s,this.context.arc(r,a,this.starRadio,0,2*Math.PI,!0),this.context.closePath(),this.context.fill()}},MapPlatForm.Base.ShapMap.prototype.addGeoRegions=function(e){for(var t,i=this.fullExtent,o={lon:(i.minX+i.maxX)/2,lat:(i.minY+i.maxY)/2},r={x:this.canvas.width/2,y:this.canvas.height/2},i=Math.abs(i.maxY-i.minY)/this.canvas.height>Math.abs(i.maxX-i.minX)/this.canvas.width?(t=this.canvas.height,Math.abs(i.maxY-i.minY)):(t=this.canvas.width,Math.abs(i.maxX-i.minX)),a=i/(t-80),s=0;s<e.geometry.coordinates.length;s++)for(var n=e.geometry.coordinates[s],l=0;l<n.length;l++){var h=n[l];this._backRegion=new m(h,this.context,{center:o})}if(this._backRegion.strokeColor=this.strokeColor,this._backRegion.backOffset=this.backOffset,this._backRegion.backShaderColor=this.backShaderColor,this._backRegion.backShaderColor2=this.backShaderColor2,this._backRegion.shadowColor=this.shadowColor,this._backRegion.reset(o,r,a),this._backRegion.drawBack(),this._resetAndDrawPoint(o,r,a),this.JianBian&&(this._backRegion.gradientColor1=this.gradientColor1,this._backRegion.gradientColor2=this.gradientColor2,this._backRegion.JianBian=this.JianBian,this._backRegion.draw()),e.districts)for(var p,c,u,s=0;s<e.districts.length;s++)e.districts[s]&&(p=e.districts[s].geometry.coordinates[0][0],c=e.districts[s].name,u=JSON.parse(e.districts[s].center).coordinates,(u=new m(p,this.contextActive,{center:u,name:c})).defaultStrokeColor=this.strokeColor,u.strokeColor=this.strokeColor,u.defaultFillColor=this.legendColor[c]||this.fillColors[s%4],u.fillColor=this.legendColor[c]||this.fillColors[s%4],u.hoverColor=this.hoverColor||u.fillColor,u.JianBian=this.JianBian,u.backShaderColor=this.backShaderColor,u.backShaderColor2=this.backShaderColor2,u.acvtiveOffset=this.acvtiveOffset,u.font=this.font,u.fontColor=this.fontColor,u.value=void 0!==this.legendValue[c]?this.legendValue[c]/this.maxValue:void 0,u.mainValue=this.legendValue[c]||0,u.TJcolor=this.TJcolor,u.TJtextcolor=this.TJtextcolor,u.TJActivecolor=this.TJActivecolor,u.TJActivetextcolor=this.TJActivetextcolor,u.reset(o,r,a),this._regions.push(u));this.v=0,this._anim(),this._initInteractive()},MapPlatForm.Base.ShapMap.prototype._anim=function(){this.contextActive.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvasActive.style.left="0px",this.canvasActive.style.top="0px";for(var e=0;e<this._regions.length;e++){var t=this._regions[e];this.JianBian?t.drawLine(!0):t.draw(!0),this.showAllNames&&t.drawTitle()}if(this.showAllTJ){this.v=this.v+.02;for(var i=0;i<this._regions.length;i++)this._regions[i].drawTJ2(this.v);var o=this;this.v<1&&setTimeout(function(){o._anim()},2)}},MapPlatForm.Base.ShapMap.prototype._getExtent=function(e){for(var t,i,o,r,a=e.geometry.coordinates,s=0;s<a.length;s++)for(var n=0;n<a[s].length;n++)for(var l=a[s][n],h=0;h<l.length;h++)0==n&&0==h&&0==s?(t=l[h][0],o=l[h][1],i=l[h][0],r=l[h][1]):(t>l[h][0]&&(t=l[h][0]),o<l[h][0]&&(o=l[h][0]),i>l[h][1]&&(i=l[h][1]),r<l[h][1]&&(r=l[h][1]));return{minX:t,minY:i,maxX:o,maxY:r}},MapPlatForm.Base.ShapMap.prototype.destory=function(){this.mapContainer.onclick=null,this.mapContainer.onmousemove=null,this.mapContainer.onmousedown=null,this.mapContainer&&(this.mapContainer=null),this._regions=[],this._backRegion=null,this.canvas.remove(),this.canvasActive.remove()},MapPlatForm.Base.ShapMap.prototype.refresh=function(e){this.contextActive.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvasActive.style.left="0px",this.canvasActive.style.top="0px";for(var t=0;t<this._regions.length;t++){var i=this._regions[t];this.JianBian?i.drawLine(!0):i.draw(!0),this.showAllNames&&i.drawTitle()}if(e&&e.drawActive(),this.showAllTJ)for(var o=0;o<this._regions.length;o++)this._regions[o].drawTJ()}}(),function(){var e=MapPlatForm.Base.ArrowLine=function(e,t){this._map=e,this.id=ZenMap.Utils.BaseUtils.uuid(),this._visible=!0,this._layers=[],this.image=new Image,this.image.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgEAYAAAAj6qa3AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAASAAAAEgARslrPgAAAjBJREFUaN7tmCFIQ1EUhvd0TmQTQdAgIrLkkmkIYjBYTGPBYhKLxWKwG8dQhphtYjCYLILNooJgGQwMBhGDhgV1bGznN/xb2GTHqfd6ZHjKz+DBvv977913uaHQ/7gdCAQSiVhz/HLhwUEAAC4vmbUac2+PGQTWnJ4FLC2h3QgEsr1tzelPAABgcpJFX150EZub1rz+RAgEsrDAtuVyGwvCXF215vUnAgCwvNy8FrROtcpMp615/YkQCGR9Heq8vfG6uTlrXs8islldRLHI66anrXndC6h/Bllwf18X8fDQWFStuT2J6O1lHh/rIm5vKWx01Jrbk4iBAeb5uS7i6ooiYjFrbvciBAIZGmLRmxt9/3B2xuzvt+Z2LwIAMDbGvLvTn4jDQ2ZPjzW3JxFTU7zTT0/6E7GzY83rT4RAIDMznW2tk8mf/l/YuvCHCUJBKCiX+aNa/UQXrHGdDW9rPM58fNTvfDZrzeuuuEAgIyNsVyjoi+DBAbMLzheaD1Kur/XiJye8Pvz3XtnvFY9EWOz0VH/ULy74Ixq15v558fr3m8WOjvQ7ns8zh4etuR0L2N3Vi9/fU9DEhDWv4+JbW3rx52dmImHN6664QCBra3rx11fm7Kw1r7viAIBUitk4+mqdSoW5uGjN67j4/DyzVGqztNcPRVdWrHndFRcIZHycxYpF/ZHf2LDmdS8AAJBO68UzGWtOfwIaO7qmjUvj3c/lmF2wdf2akL4+a47/6XDeAd6F40H7Yd0JAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTEyLTI4VDE1OjEzOjQyKzA4OjAwCT5KagAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0xMi0yOFQxNToxMzo0MiswODowMHhj8tYAAABKdEVYdHN2ZzpiYXNlLXVyaQBmaWxlOi8vL2hvbWUvYWRtaW4vaWNvbi1mb250L3RtcC9pY29uX3R4N3JpcjU3ZXpiL2ppYW50b3Uuc3Zn6JRGFAAAAABJRU5ErkJggg==",this.size=32,this.offsetX=-32,this._isAnimation=t,this._isLoadImage=!1};e.prototype._drawImage=function(){var t=this;return{width:this.size,height:this.size,data:new Uint8Array(this.size*this.size*4),onAdd:function(){var e=document.createElement("canvas");e.width=this.width,e.height=this.height,this.context=e.getContext("2d");this.context},render:function(){if(!t._isAnimation&&t._isLoadImage)return!1;t.offsetX=t.offsetX+1,0<t.offsetX&&(t.offsetX=-32);var e=this.context;return e.clearRect(0,0,this.width,this.height),e.drawImage(t.image,t.offsetX,0,32,32),e.drawImage(t.image,t.offsetX+32,0,32,32),this.data=e.getImageData(0,0,this.width,this.height).data,t._map._obj.triggerRepaint(),t._isLoadImage=!0}}},e.prototype.load=function(e){if(this._map._obj.hasImage(this.id+"arrawIcon")||this._map._obj.addImage(this.id+"arrawIcon",this._drawImage(),{pixelRatio:1}),e&&0<e.length)for(var t=0;t<e.length;t++){var i={id:this.id+"_line"+e[t].id,type:"line",source:e[t].layer._layerID+"_source",paint:{"line-width":e[t]._weight,"line-translate-anchor":"map","line-opacity":e[t]._visible?e[t]._opacity:1,"line-pattern":this.id+"arrawIcon"},filter:["==","id",e[t].id]};this._layers.push(i),this._map._obj.addLayer(i)}},e.prototype.remove=function(){if(this._map._obj.hasImage(this.id+"arrawIcon")&&this._map._obj.removeImage(this.id+"arrawIcon"),this._layers.length)for(var e=0;e<this._layers.length;e++)this._map._obj.getLayer(this._layers[e].id)&&this._map._obj.removeLayer(this._layers[e].id)},e.prototype.show=function(e){if(this._layers.length&&!this._visible){for(var t=0;t<this._layers.length;t++)this._map._obj.setLayoutProperty(this._layers[t].id,"visibility","visible");this._visible=!0}},e.prototype.hide=function(e){if(this._layers.length&&this._visible){for(var t=0;t<this._layers.length;t++)this._map._obj.setLayoutProperty(this._layers[t].id,"visibility","none");this._visible=!1}}}(),function(){function i(e,t){this.points=[e.point],this._map=t,this.id=e.id,this._point=e,this._count=60,this.offset=e.offset,this._currentIndex=0,this._linePoints=[],this._lineLength=20,this._visible=!0,this._show3D=!1;var i=document.createElement("div");i.className="marker",i.style.backgroundImage="url("+e.url+")",i.style.width=(e.iconSize?e.iconSize[0]:32)+"px",i.style.height=(e.iconSize?e.iconSize[1]:32)+"px",i.style.cursor="pointer";var o=this;i.addEventListener("click",function(){return e.click&&e.click instanceof Function&&e.click(o._point),!1}),i.addEventListener("mouseover",function(){return e.mouseOver&&e.mouseOver instanceof Function&&e.mouseOver(o._point),!1}),i.addEventListener("mouseout",function(){return e.mouseOut&&e.mouseOut instanceof Function&&e.mouseOut(o._point),!1}),this._element=i,t=ZenMap.T.setPoint(this._map,{lon:e.point.lon,lat:e.point.lat}),this.marker=new zmapboxgl.Marker({element:i,offset:this.offset}).setLngLat([t.lon,t.lat]),this.setUrl=function(e){this._point.url=e,i.style.backgroundImage="url("+e+")"},this.addToMap=function(){this.marker.addTo(this._map._obj)},this.addPoint=function(e){var t,i;this._currentIndex=0,this.points.push(e),2!=this.points.length&&(i=this.points[this.points.length-2],e=((t=this.points[this.points.length-1]).lon-i.lon)/this._count*this._currentIndex+i.lon,i=(t.lat-i.lat)/this._count*this._currentIndex+i.lat,i=ZenMap.T.setPoint(this._map,{lon:e,lat:i}),this.marker.setLngLat([i.lon,i.lat]),0<this._linePoints.length&&i.lon==this._linePoints[this._linePoints.length-1].lon&&i.lat==this._linePoints[this._linePoints.length-1].lat||(this._linePoints.push(i),this._linePoints=this._linePoints.slice(-this._lineLength)))},this._calculateAngle=function(){var e=this.points[this.points.length-2],t=this.points[this.points.length-1];if(e.lon==t.lon&&e.lat==t.lat)return-100;e=180*Math.atan2(t.lat-e.lat,t.lon-e.lon)/Math.PI;return(e=!(0<(e-=270))?360+e:e)/180*Math.PI},this.moveNext=function(){var e,t,i,o;this.points.length<2||this._currentIndex>=this._count-1||(this._currentIndex++,e=this.points[this.points.length-2],t=((o=this.points[this.points.length-1]).lon-e.lon)/this._count*this._currentIndex+e.lon,i=(o.lat-e.lat)/this._count*this._currentIndex+e.lat,t=ZenMap.T.setPoint(this._map,{lon:t,lat:i}),this.marker.getLngLat().lng===t.lon&&this.marker.getLngLat().lat===t.lat||this.marker.setLngLat([t.lon,t.lat]),0<this._linePoints.length&&t.lon==this._linePoints[this._linePoints.length-1].lon&&t.lat==this._linePoints[this._linePoints.length-1].lat||(this._linePoints.push(t),this._linePoints=this._linePoints.slice(-this._lineLength)),this._show3D&&(i=-100,e.lon==o.lon&&e.lat==o.lat&&(i=-100),this._map.getDistance(e,o)<1&&(i=-100),o=[0,0,i=this._calculateAngle()],-100==i&&(o=[this._modelTransform.rotateX,this._modelTransform.rotateY,this._modelTransform.rotateZ]),this._modelTransform={translateX:zmapboxgl.MercatorCoordinate.fromLngLat([t.lon,t.lat],0).x,translateY:zmapboxgl.MercatorCoordinate.fromLngLat([t.lon,t.lat],0).y,translateZ:zmapboxgl.MercatorCoordinate.fromLngLat([t.lon,t.lat],0).z,rotateX:o[0],rotateY:o[1],rotateZ:o[2],scale:3e-8}))},this.hide=function(){this._visible=!1,this._element.style.display="none"},this.show=function(){this._visible=!0,this._element.style.display="block"},this.hide3DModel=function(){this._show3D&&(this._map._obj.getLayer("GPSRefreshManager-3DModel")&&this._map._obj.removeLayer("GPSRefreshManager-3DModel"),this._element.style.display="block",this._show3D=!1)},this.show3DModel=function(){var e,t,i,o,s,r;this._show3D||this._point.url3d&&(this._map._obj.getLayer("GPSRefreshManager-3DModel")&&this._map._obj.removeLayer("GPSRefreshManager-3DModel"),this._element.style.display="none",this._show3D=!0,r=[o=i=0,0,0],r=1<this.points.length?(e=this.points[this.points.length-2],i=((t=this.points[this.points.length-1]).lon-e.lon)/this._count*this._currentIndex+e.lon,o=(t.lat-e.lat)/this._count*this._currentIndex+e.lat,[0,0,this._calculateAngle()]):[0,0,0],o=ZenMap.T.setPoint(this._map,{lon:i,lat:o}),this._modelTransform={translateX:zmapboxgl.MercatorCoordinate.fromLngLat([o.lon,o.lat],0).x,translateY:zmapboxgl.MercatorCoordinate.fromLngLat([o.lon,o.lat],0).y,translateZ:zmapboxgl.MercatorCoordinate.fromLngLat([o.lon,o.lat],0).z,rotateX:r[0],rotateY:r[1],rotateZ:r[2],scale:3e-8},r={id:"GPSRefreshManager-3DModel",type:"custom",renderingMode:"3d",onAdd:function(e,t){this.camera=new THREE.Camera,this.scene=new THREE.Scene;var i=new THREE.DirectionalLight(16777215);i.position.set(-200,0,200).normalize(),this.scene.add(i);i=new THREE.DirectionalLight(16777215);i.position.set(200,0,200).normalize(),this.scene.add(i);i=new THREE.DirectionalLight(16777215);i.position.set(0,-200,200).normalize(),this.scene.add(i);i=new THREE.DirectionalLight(16777215);i.position.set(0,200,200).normalize(),this.scene.add(i),(new THREE.GLTFLoader).load(s._point.url3d,function(e){this.scene.add(e.scene)}.bind(this)),this.map=e,this.renderer=new THREE.WebGLRenderer({antialias:!0,canvas:e.getCanvas(),context:t}),this.renderer.autoClear=!1},render:function(e,t){var i=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(1,0,0),s._modelTransform.rotateX),o=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,1,0),s._modelTransform.rotateY),r=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,0,1),s._modelTransform.rotateZ),a=(new THREE.Matrix4).fromArray(t),r=(new THREE.Matrix4).makeTranslation(s._modelTransform.translateX,s._modelTransform.translateY,s._modelTransform.translateZ).scale(new THREE.Vector3(s._modelTransform.scale,-s._modelTransform.scale,s._modelTransform.scale)).multiply(i).multiply(o).multiply(r);this.camera.projectionMatrix.elements=t,this.camera.projectionMatrix=a.multiply(r),this.renderer.state.reset(),this.renderer.render(this.scene,this.camera),this.map.triggerRepaint()}},(s=this)._map._obj.getLayer("GPSRefreshManager-3DModel")||(this._map._obj.getLayer("city_normal_building_id")?this._map._obj.addLayer(r,"city_normal_building_id"):this._map._obj.addLayer(r)))}}var e=MapPlatForm.Base.GPSRefreshManager=function(e,t){this._map=e,this._gpsPoints={},this._status=1,this._popup=null,this._layerID=ZenMap.Utils.BaseUtils.uuid(),this.interval=t&&t.interval?t.interval:50,this.time=t&&t.time?t.time:3e3,this._lineColor=t&&t.lineColor?t.lineColor:"red",this._lineWidth=t&&t.lineWidth?t.lineWidth:4,this._lineLength=t&&t.lineLength?t.lineLength:20,this._lineTypes=t&&t.lineTypes?t.lineTypes:{car:this._lineColor,man:"yellow"},this._source={type:"geojson",lineMetrics:!0,data:{type:"FeatureCollection",features:[]}},this._map._obj.addSource(this._layerID+"_source",this._source),this._lineLayer={id:this._layerID+"_line",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":this._lineTypes.man,"line-width":this._lineWidth,"line-gradient":["interpolate",["linear"],["line-progress"],0,"rgba(0,0,0,0)",1,this._lineTypes.man]},filter:["all",["==","visible",!0],["==","type","man"]]},this._map._obj.addLayer(this._lineLayer),this._lineLayer2={id:this._layerID+"_line2",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":this._lineTypes.man,"line-width":this._lineWidth,"line-gradient":["interpolate",["linear"],["line-progress"],0,"rgba(0,0,0,0)",1,this._lineTypes.car]},filter:["all",["==","visible",!0],["==","type","car"]]},this._map._obj.addLayer(this._lineLayer2),this._map._obj.getLayer("city_normal_building_id")&&(this._map._obj.moveLayer(this._layerID+"_line","city_normal_building_id"),this._map._obj.moveLayer(this._layerID+"_line2","city_normal_building_id"))};e.prototype.setGPSLineTpes=function(e){this._map._obj.setPaintProperty(this._layerID+"_line","line-gradient",["interpolate",["linear"],["line-progress"],0,"rgba(0,0,0,0)",1,e.man]),this._map._obj.setPaintProperty(this._layerID+"_line2","line-gradient",["interpolate",["linear"],["line-progress"],0,"rgba(0,0,0,0)",1,e.car])},e.prototype.addGPSPoints=function(e){for(var t=0;t<e.length;t++)e[t].url3d=e[t].url3d||ZenMap.Utils.BaseUtils.getHostPath()+"/ZenView/car3d.gltf",this._gpsPoints[e[t].id]=new i(e[t],this._map),this._gpsPoints[e[t].id]._count=this.time/this.interval,this._gpsPoints[e[t].id]._lineLength=this._lineLength,this._gpsPoints[e[t].id].addToMap()},e.prototype.updataGPSPoints=function(e){if(this._status)for(var t=0;t<e.length;t++)this._gpsPoints[e[t].id]?(e[t].url3d=e[t].url3d||ZenMap.Utils.BaseUtils.getHostPath()+"/ZenView/car3d.gltf",this._gpsPoints[e[t].id]._point=e[t],this._gpsPoints[e[t].id].addPoint(e[t].point)):(e[t].url3d=e[t].url3d||ZenMap.Utils.BaseUtils.getHostPath()+"/ZenView/car3d.gltf",this._gpsPoints[e[t].id]=new i(e[t],this._map),this._gpsPoints[e[t].id]._count=this.time/this.interval,this._gpsPoints[e[t].id]._lineLength=this._lineLength,this._gpsPoints[e[t].id].addToMap())},e.prototype.setLineVisible=function(e){e?(this._map._obj.setLayoutProperty(this._lineLayer.id,"visibility","visible"),this._map._obj.setLayoutProperty(this._lineLayer2.id,"visibility","visible")):(this._map._obj.setLayoutProperty(this._lineLayer.id,"visibility","none"),this._map._obj.setLayoutProperty(this._lineLayer2.id,"visibility","none"))},e.prototype.setGPSVisibleByFilter=function(t,i,o){var r=this;Object.keys(r._gpsPoints).forEach(function(e){r._gpsPoints[e]._point[t]==i&&r.setGPSVisibleByID(e,o)})},e.prototype.setGPSVisibleByID=function(e,t){this._gpsPoints[e]&&(t?this._gpsPoints[e].show():(this._gpsPoints[e].hide(),(e=this._gpsPoints[e].marker.getPopup())&&e.isOpen()&&e.remove()))},e.prototype.show3DModelByID=function(e){this._gpsPoints[e]&&this._gpsPoints[e].show3DModel()},e.prototype.hide3DModelByID=function(e){this._gpsPoints[e]&&this._gpsPoints[e].hide3DModel()},e.prototype.setGPSStyleByID=function(e,t){this._gpsPoints[e]&&(t.url&&this._gpsPoints[e].setUrl(t.url),t.offset&&this._gpsPoints[e].marker.setOffset(t.offset),t.iconSize&&(this._gpsPoints[e]._element.style.width=t.iconSize[0]+"px",this._gpsPoints[e]._element.style.height=t.iconSize[1]+"px"))},e.prototype.setGPSInfoWindowByID=function(e,t,i){var o,r;this._popup&&(this._popup.remove(),this._popup=null),this._gpsPoints[e]&&(o=i&&i.width?i.width:0,r=i&&i.height?i.height:0,i=this._gpsPoints[e]._point.iconSize?this._gpsPoints[e]._point.iconSize[1]:32,this._gpsPoints[e]._point.iconSize&&this._gpsPoints[e]._point.iconSize[0],this._popup=new zmapboxgl.Popup({closeButton:!1,closeOnClick:!1,onlyLeftTop:!0,offset:[0-o/2,0-i-r-2]}).setDOMContent(t).addTo(this._map._obj),this._gpsPoints[e].marker.setPopup(this._popup),this._activeID=e,this._popup._container.setAttribute("id",this._layerID+"Infowindow"))},e.prototype.closeGPSInfoWindow=function(){this._popup&&(this._popup.remove(),this._popup=null)},e.prototype.getGPSInfoWindowID=function(){return this._popup&&this._popup._container?this._popup._container.getAttribute("id"):null},e.prototype.unbindInfoWindow=function(){this._activeID&&this._gpsPoints[this._activeID]&&this._gpsPoints[this._activeID].marker._popup&&(this._gpsPoints[this._activeID].marker._popup._map=null,this._gpsPoints[this._activeID].marker._popup=null)},e.prototype.bindInfoWindow=function(){this._activeID&&this._gpsPoints[this._activeID]&&this._popup&&(this._popup._map=this._map._obj,this._gpsPoints[this._activeID].marker._popup=this._popup)},e.prototype.bindCamera=function(e,t){this._isTrack=!0,this._bindGPSID=e,this._callBack=t},e.prototype.unbindCamera=function(){this._isTrack=!1,this._bindGPSID=null,this._callBack=null},e.prototype.start=function(){var o=this;this._status=!0;function t(){var e;o._status&&(o._source.data.features=[],Object.keys(o._gpsPoints).forEach(function(e){o._gpsPoints[e].moveNext(o._bindGPSID==e);for(var t={type:"Feature",geometry:{type:"LineString",coordinates:[]},properties:{id:e,visible:o._gpsPoints[e]._visible,type:o._gpsPoints[e]._point.type||"car"}},i=0;i<o._gpsPoints[e]._linePoints.length;i++)t.geometry.coordinates.push([o._gpsPoints[e]._linePoints[i].lon,o._gpsPoints[e]._linePoints[i].lat]);o._source.data.features.push(t)}),o._map._obj.getSource(o._layerID+"_source").setData(o._source.data),o._gpsPoints[o._bindGPSID]&&o._isTrack&&(e=o._gpsPoints[o._bindGPSID].marker.getLngLat(),o._map._obj.jumpTo({center:[e.lng,e.lat]}),e=ZenMap.T.getPoint(o._map,{lon:e.lng,lat:e.lat}),o._callBack&&o._callBack(o._bindGPSID,new ZenMap.Geometry.Point(e.lon,e.lat))),setTimeout(t,o.interval-15))}setTimeout(t,this.interval-15)},e.prototype.stop=function(){this._status=0},e.prototype.getGPSPositionByID=function(e){e=this._gpsPoints[e].marker.getLngLat(),e={lon:e.lng,lat:e.lat};return ZenMap.T.getPoint(this._map,e)},e.prototype.getGPSVisibleByID=function(e){return this._gpsPoints[e]._visible},e.prototype.destory=function(){this.stop();var t=this;Object.keys(this._gpsPoints).forEach(function(e){t._gpsPoints[e].marker.remove(),t._gpsPoints[e]=null}),this._map._obj.removeLayer(this._layerID+"_line"),this._map._obj.removeLayer(this._layerID+"_line2"),this._map._obj.removeSource(this._layerID+"_source"),this._map._obj.getLayer("GPSRefreshManager-3DModel")&&this._map._obj.removeLayer("GPSRefreshManager-3DModel"),this._gpsPoints={},this._map=null}}(),function(){MapPlatForm.Base.ShapMap3D=function(e,t,i){this.geoRegion=t;var o=++ZenMap.LayerIndex;this._layerID="RegionLayer"+o,this.CLASS_NAME="MapPlatForm.Base.ShapMap3D",this._map=e;e=GeoJSON.read(t.geometry);this.fullExtent=e.getExtent(),this._regions=[],this._layers=[],this.acvtiveLayer=null,this.acvtiveRegion=null,this.activeFeature=null,this.opts=i||{},this.fillColor=this.opts.fillColors||["#A4D3EE","#7EC0EE","#63B8FF","#5CACEE","#87CEFF"];var r={};if(this.geoRegion.districts)for(var a=0;a<this.geoRegion.districts.length;a++){var s=a%this.fillColor.length;r[this.geoRegion.districts[a].name]=this.fillColor[s]}this.mapParam=this.opts.mapParam||null,this.markers=this.opts.markers||null,this.legendColor=this.opts.legendColor||r,this.opacity=this.opts.opacity||.5,this.hoverColor=this.opts.hoverColor||"#154e6e",this.fontSize=this.opts.fontSize||12,this.fontColor=this.opts.fontColor||"#000000",this.fontOpacity=this.opts.fontOpacity||1,this.fontOffset=this.opts.fontOffset||[0,-1],this.minZoom=this.opts.minZoom||5,this.maxZoom=this.opts.maxZoom||12,this.maxExtrusionHeight=this.opts.maxExtrusionHeight||1e4,this.minExtrusionHeight=this.opts.minExtrusionHeight||500,this.mouseOver=this.opts.mouseOver||function(){},this.mouseOut=this.opts.mouseOut||function(){},this.click=this.opts.click||function(){},this._source={type:"geojson",data:{type:"FeatureCollection",features:[]}},this.labelLayer={id:this._layerID+"_symbol",type:"symbol",source:this._layerID+"_source",layout:{"text-field":"{title}","text-font":["Microsoft YaHei"],"text-size":["get","text-size"],"text-offset":["get","text-offset"],"text-anchor":"center"},paint:{"text-color":["get","text-color"],"text-opacity":["get","text-opacity"]},minzoom:this.minZoom,maxzoom:this.maxZoom,filter:["==","$type","Point"]},this.addGeoRegions(t)},MapPlatForm.Base.ShapMap3D.prototype._getFeature=function(e){for(var t=this._map._obj.style._order.length-1;0<=t;t--)if(-1<this._map._obj.style._order[t].indexOf("RegionLayer")){var i=this._map._obj.style._order[t];if("none"!=this._map._obj.getLayoutProperty(i,"visibility")){i=this._map._obj.queryRenderedFeatures(e.point,{layers:[i]});if(i&&0<i.length)return[i[0]]}}return[]},MapPlatForm.Base.ShapMap3D.prototype._mouseout=function(){this._map._obj.getCanvas().style.cursor="",this.mouseOut&&this.activeFeature&&(this.refresh(),this.mouseOut(this.acvtiveRegion)),this.acvtiveRegion=null,this.activeFeature=null,this.acvtiveLayer=null},MapPlatForm.Base.ShapMap3D.prototype._initInteractive=function(e){this._map._events.through=!0;var t=this;this._mousemoveFun||(this._mousemoveFun=function(e){e=t._getFeature(e);0!=e.length?t.activeFeature&&e[0].properties.id==t.activeFeature.properties.id||(t._mouseout(),e&&0<e.length&&(t._map._obj.getCanvas().style.cursor="pointer",t.activeFeature=e[0],t.acvtiveRegion=t._regions[e[0].properties.index],t.acvtiveLayer=t._layers[e[0].properties.index],t.mouseOver&&t.activeFeature&&(t.refresh(t.acvtiveLayer),t.mouseOver(t.acvtiveRegion)))):t._mouseout()}),this._clickFun||(this._clickFun=function(){t.acvtiveRegion&&t.click(t.acvtiveRegion)}),e?(this._map._obj.off("mousemove",this._mousemoveFun),this._map._obj.off("click",this._clickFun)):(this._map._obj.on("mousemove",this._mousemoveFun),this._map._obj.on("click",this._clickFun))},MapPlatForm.Base.ShapMap3D.prototype.addGeoRegions=function(geoRegion){if(geoRegion.districts){for(var i=0,polygon,f,center,center,l;i<geoRegion.districts.length;i++){geoRegion.districts[i]&&(polygon=GeoJSON.read(geoRegion.districts[i].geometry),this._regions.push(geoRegion.districts[i]),f={type:"Feature",geometry:{type:geoRegion.districts[i].geometry.type,coordinates:polygon._getCoordinates(this._map)},properties:{id:polygon.id,fillColor:this.legendColor[geoRegion.districts[i].name],index:i}},center=geoRegion.districts[i].center?GeoJSON.read(eval("("+geoRegion.districts[i].center+")")):polygon.getCenter(),center=ZenMap.T.setPoint(this._map,center),l={type:"Feature",geometry:{type:"Point",coordinates:[center.lon,center.lat]},properties:{id:polygon.id,title:geoRegion.districts[i].name,"text-offset":this.fontOffset,"text-opacity":this.fontOpacity,"text-size":this.fontSize,"text-color":this.fontColor,index:i}},this._source.data.features.push(f),this._source.data.features.push(l))}this._map._obj.addSource(this._layerID+"_source",this._source);for(var i=0,polygonLayer;i<geoRegion.districts.length;i++){geoRegion.districts[i]&&(polygonLayer={id:this._layerID+"_polygon"+i,type:"fill-extrusion",source:this._layerID+"_source",paint:{"fill-extrusion-color":this.legendColor[geoRegion.districts[i].name],"fill-extrusion-opacity":this.opacity,"fill-extrusion-translate-anchor":"map","fill-extrusion-height":{stops:[[this.minZoom,this.maxExtrusionHeight],[this.maxZoom,this.minExtrusionHeight]]},"fill-extrusion-base":0},minzoom:this.minZoom,maxzoom:this.maxZoom,filter:["all",["==","index",i],["==","$type","Polygon"]]},this._layers.push(polygonLayer),this._map._obj.addLayer(polygonLayer))}for(var i=0;i<this._layers.length;i++)this._map._obj.setPaintProperty(this._layers[i].id,"fill-extrusion-color",this.legendColor[this.geoRegion.districts[i].name]);this._map._obj.addLayer(this.labelLayer)}this.mapParam?this._map.jumpTo(this.mapParam):this._map.zoomToExtent(this.fullExtent),this.markers&&this._map.addOverlays(this.markers),this._initInteractive()},MapPlatForm.Base.ShapMap3D.prototype.setLegendColor=function(e){this.legendColor=e;for(var t=0;t<this._layers.length;t++)this._map._obj.setPaintProperty(this._layers[t].id,"fill-extrusion-color",this.legendColor[this.geoRegion.districts[t].name])},MapPlatForm.Base.ShapMap3D.prototype.getRegionByName=function(e){if("string"==typeof e&&void 0!==e&&this._regions&&0<this._regions.length)for(var t=0;t<this._regions.length;t++)if(this._regions[t].name==e)return this._regions[t];return[]},MapPlatForm.Base.ShapMap3D.prototype.flash=function(e){for(var t="string"==typeof e&&void 0===e.name?this.getRegionByName(e):e,i=0;i<this._regions.length;i++)t&&this._regions[i].name==t.name&&this._flash(i)},MapPlatForm.Base.ShapMap3D.prototype._flash=function(i){var o=this,r=0;this.timer&&(window.clearTimeout(this.timer),this.show(),this.timer=null),function e(){if(++r%2){o._map._obj.setPaintProperty(o._layers[i].id,"fill-extrusion-opacity",0);for(var t=0;t<o._source.data.features.length;t++)o._source.data.features[t].properties.index===i&&(o._source.data.features[t].properties["text-opacity"]=0)}else{o._map._obj.setPaintProperty(o._layers[i].id,"fill-extrusion-opacity",.8);for(t=0;t<o._source.data.features.length;t++)o._source.data.features[t].properties.index===i&&(o._source.data.features[t].properties["text-opacity"]=1)}o._map._obj.getSource(o._layerID+"_source").setData(o._source.data),o.timer=r<6?window.setTimeout(e,500):null}()},MapPlatForm.Base.ShapMap3D.prototype.destory=function(){if(this._map){this._initInteractive(!0);for(var e=0;e<this._layers.length;e++)this._map._obj.removeLayer(this._layers[e].id);this._map._obj.removeLayer(this.labelLayer.id),this._map._obj.removeSource(this._layerID+"_source"),this._map=null}this._regions=[],this._layers=[],this.acvtiveRegion=null,this.activeFeature=null},MapPlatForm.Base.ShapMap3D.prototype.refresh=function(e){for(var t=0;t<this._layers.length;t++)this._map._obj.setPaintProperty(this._layers[t].id,"fill-extrusion-color",this.legendColor[this.geoRegion.districts[t].name]);e&&this._map._obj.setPaintProperty(e.id,"fill-extrusion-color",this.hoverColor)}}(),MapPlatForm.Base.MapGeoLine=function(e,t){this.CLASS_NAME="MapGeoLine",this._layerID=ZenMap.Utils.BaseUtils.uuid(),this._map=e,this._lines={},this.activeFeature=null,this.activeLine=null,this.mouseOver=t?t.mouseOver:null,this.mouseOut=t?t.mouseOut:null,this.click=t?t.click:null,this._source={type:"geojson",data:{type:"FeatureCollection",features:[]}},this._lineLayer={id:this._layerID+"_line",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":["get","color"],"line-width":["get","width"],"line-opacity":["get","opacity"]},filter:["==","$type","LineString"]}},MapPlatForm.Base.MapGeoLine.prototype._getFeature=function(e){for(var t=this._map._obj.style._order.length-1;0<=t;t--)if(-1<this._map._obj.style._order[t].indexOf(this._layerID)){var i=this._map._obj.style._order[t];if("none"!=this._map._obj.getLayoutProperty(i,"visibility")){i=this._map._obj.queryRenderedFeatures(e.point,{layers:[i]});if(i&&0<i.length)return[i[0]]}}return[]},MapPlatForm.Base.MapGeoLine.prototype._mouseout=function(){this._map._obj.getCanvasContainer().style.cursor="",this.mouseOut&&this.activeLine&&this.mouseOut(this.activeLine),this.activeFeature=null},MapPlatForm.Base.MapGeoLine.prototype._initInteractive=function(e){var t=this;this._mousemoveFun||(this._mousemoveFun=function(e){e=t._getFeature(e);0!=e.length?t.activeFeature&&e[0].properties.id==t.activeFeature.properties.id||(t._mouseout(),e&&0<e.length&&(t._map._obj.getCanvasContainer().style.cursor="pointer",t.activeFeature=e[0],t.activeLine=t._lines[e[0].properties.id],t.mouseOver&&t.activeLine&&t.mouseOver(t.activeLine))):t._mouseout()}),this._clickFun||(this._clickFun=function(){t.activeLine&&t.click(t.activeLine)}),e?(this._map._obj.off("mousemove",this._mousemoveFun),this._map._obj.off("click",this._clickFun)):(this._map._obj.on("mousemove",this._mousemoveFun),this._map._obj.on("click",this._clickFun))},MapPlatForm.Base.MapGeoLine.prototype.addGeoLines=function(e){if(e&&0<e.length){for(var t=0;t<e.length;t++)this._lines[e[t].id]=e[t],this._source.data.features.push({type:"Feature",geometry:{type:"LineString",coordinates:e[t]._getCoordinates(this._map)},properties:{id:e[t].id,layerId:this._layerID,color:e[t]._color,width:e[t]._weight,hasDash:e[t]._lineStyle!=ZenMap.LINE_TYPE_SOLID,opacity:e[t]._visible?e[t]._opacity:0,join:"round",visible:e[t]._visible}});this._map._obj.addSource(this._layerID+"_source",this._source),this._map._obj.addLayer(this._lineLayer)}this._initInteractive()},MapPlatForm.Base.MapGeoLine.prototype.destory=function(){this._map&&(this._initInteractive(!0),this._map._obj.removeLayer(this._lineLayer.id),this._map._obj.removeSource(this._layerID+"_source"),this._map=null),this.activeFeature=null,this.activeLine=null,this._lines={}},MapPlatForm.Base.MapGeoLine.prototype.refresh=function(){this._map&&this._map._obj.getSource(this._layerID+"_source").setData(this._source.data)},MapPlatForm.Base.MapRoomControl=function(e,t){this.CLASS_NAME="MapRoomControl",this._layerID=ZenMap.Utils.BaseUtils.uuid(),this._map=e,this._activeID=null,this._minZoom=(t=t||{})&&t.showZoom?t.showZoom:17,this._hasMask=!(!t||!t.hasMask)&&t.hasMask,this.maskStyle={"fill-color":"#222","fill-opacity":.8},this.maskStyle=ZenMap.Utils.extend(this.maskStyle,t.maskStyle),this._floorControlStyle=t?t.floorControlStyle:null,this._events=new ZenMap.Events(this,["changed"]),this._source={type:"geojson",data:{type:"FeatureCollection",features:[]}},this._floorRegionLayer={id:this._layerID+"_floor_region",type:"fill",source:this._layerID+"_source",paint:{"fill-color":"#f5f2eb","fill-opacity":1},minzoom:this._minZoom,filter:["all",["==","datatype","floor"],["==","$type","Polygon"]]},this._normalFloorLineLayer={id:this._layerID+"_normal_floor_line",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#adafb1","line-width":3},minzoom:this._minZoom,filter:["all",["==","datatype","floor"],["==","$type","Polygon"],["==","active",!1]]},this._activeFloorLineLayer={id:this._layerID+"_active_floor_line",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#f69428","line-width":3},minzoom:this._minZoom,filter:["all",["==","datatype","floor"],["==","$type","Polygon"],["==","active",!0]]},this._roomLayer={id:this._layerID+"_room",type:"fill-extrusion",source:this._layerID+"_source",layout:{},paint:{"fill-extrusion-color":"#d4b7dd","fill-extrusion-base":0,"fill-extrusion-height":2.5,"fill-extrusion-opacity":.8},minzoom:this._minZoom,filter:["all",["==","datatype","room"],["==","$type","Polygon"]]},this._labelLayer={id:this._layerID+"_symbol",type:"symbol",source:this._layerID+"_source",layout:{"text-field":"{name}","text-font":["Microsoft YaHei"],"text-size":11,"text-offset":[0,0],"text-anchor":"center"},paint:{"text-color":"#3b3d3d","text-opacity":1,"text-halo-width":1,"text-halo-color":"#FFF"},minzoom:this._minZoom,filter:["==","$type","Point"]},this._addLayers(),this._mapService=new MapPlatForm.Base.MapService(e)},MapPlatForm.Base.MapRoomControl.prototype._addLayers=function(){this._map._obj.addSource(this._layerID+"_source",this._source),this._hasMask&&this._map._obj.addLayer({id:this._layerID+"_mask",type:"fill",source:{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[-180,-90],[-180,90],[180,90],[180,-90],[-180,-90]]]}}},layout:{},paint:{"fill-color":this.maskStyle["fill-color"],"fill-opacity":this.maskStyle["fill-opacity"]}}),this._map._obj.addLayer(this._floorRegionLayer),this._map._obj.addLayer(this._normalFloorLineLayer),this._map._obj.addLayer(this._activeFloorLineLayer),this._map._obj.addLayer(this._roomLayer),this._map._obj.addLayer(this._labelLayer),this._map._obj.getLayer("city_normal_building_id")&&(this._hasMask||(this._map._obj.moveLayer(this._floorRegionLayer.id,"city_normal_building_id"),this._map._obj.moveLayer(this._normalFloorLineLayer.id,"city_normal_building_id"),this._map._obj.moveLayer(this._activeFloorLineLayer.id,"city_normal_building_id")))},MapPlatForm.Base.MapRoomControl.prototype.showFloorChangeInMap=function(){this._map.addEventListener("moveend",this._updateFloors,this),this._updateFloors()},MapPlatForm.Base.MapRoomControl.prototype._updateFloors=function(){var e,t,i,o=this._map.getZoom(),r=document.getElementById("ZenMap_Room_Control");o<this._minZoom?r&&(r.style.display="none"):r&&(r.style.display="block"),o>=this._minZoom&&o<21&&(e=this._map.getContainer(),t=this._map._obj.unproject({x:0,y:0}),r=this._map._obj.unproject({x:e.offsetWidth,y:0}),o=this._map._obj.unproject({x:e.offsetWidth,y:e.offsetHeight}),e=this._map._obj.unproject({x:0,y:e.offsetHeight}),t=new ZenMap.Geometry.Point(t.lng,t.lat),r=new ZenMap.Geometry.Point(r.lng,r.lat),o=new ZenMap.Geometry.Point(o.lng,o.lat),e=new ZenMap.Geometry.Point(e.lng,e.lat),t=new ZenMap.Geometry.Polygon([t,r,o,e,t]),(i=this)._mapService.queryRoomFloorsByGeometry(t,function(e){i.addFloors(e.data)}))},MapPlatForm.Base.MapRoomControl.prototype.addFloors=function(e){if(0==(this.floors=e=e||[]).length)return this._activeID=null,this._source.data.features=[],this._map&&this._map._obj.getSource(this._layerID+"_source").setData(this._source.data),void this._removeControl();var t=[];if(this._activeID==e[0].id)for(var i=0;i<this._source.data.features.length;i++)this._source.data.features[i].properties.buildid==this._activeID&&t.push(this._source.data.features[i]);this._source.data.features=t;for(var o=0;o<e.length;o++)0==o?this._activeID!==e[o].id&&(this._activeID=e[o].id,this._removeControl(),this._addControl(e[o]),this.addFloor(e[o],!0)):this.addFloor(e[o],!1);this._map&&this._map._obj.getSource(this._layerID+"_source").setData(this._source.data)},MapPlatForm.Base.MapRoomControl.prototype._changeFloor=function(e,t){for(var i=[],o=0;o<this._source.data.features.length;o++)this._source.data.features[o].properties.active||i.push(this._source.data.features[o]);this._source.data.features=i;var r=this;this._mapService.queryRoomFloor(e,t,function(e){r.addFloor(e.data[0],!0),r._map&&r._map._obj.getSource(r._layerID+"_source").setData(r._source.data)})},MapPlatForm.Base.MapRoomControl.prototype.addFloor=function(e,t){var i=e.floor.floor,o=i.properties.namecode;i.properties={floorname:o,buildid:e.id,datatype:"floor",active:t},this._source.data.features.push(i);for(var r=0;r<e.floor.shops.length;r++){var a=e.floor.shops[r],s=a.properties.name,n=a.properties.font_anthor_point;a.properties={buildid:e.id,floorname:o,datatype:"room",active:t},this._source.data.features.push(a),this._source.data.features.push({type:"Feature",geometry:{type:"Point",coordinates:n},properties:{name:s,floorname:o,buildid:e.id,active:t}})}for(r=0;r<e.floor.cons.length;r++){var l=e.floor.cons[r],h=l.properties.name;l.properties={buildid:e.id,floorname:o,name:h,active:t},this._source.data.features.push(l)}for(r=0;r<e.floor.pubs.length;r++){var p=e.floor.pubs[r],c=p.properties.name;p.properties={buildid:e.id,floorname:c,name:h,active:t},this._source.data.features.push(p)}t&&this._events.triggerEvt("changed",{buildid:e.id,floorname:o})},MapPlatForm.Base.MapRoomControl.prototype._addControl=function(e){var t=this._map.getContainer(),i=document.createElement("div");i.id="ZenMap_Room_Control",i.className="zenmap-indoormap-floorbar-control",i.title=e.building.properties.name_cn,this._floorControlStyle&&this._floorControlStyle.bottom&&(i.style.bottom=this._floorControlStyle.bottom),this._floorControlStyle&&this._floorControlStyle.right&&(i.style.right=this._floorControlStyle.right);var o=document.createElement("div");o.className="panel-box";var r=document.createElement("div");r.className="select-dock";var a=document.createElement("div");a.className="floor-list-box";var s=document.createElement("ul");s.className="floor-list";for(var n,l,h=0,p=0,c=e.building.properties.floor_nonas,u=e.id,m=this,d=c.length-1;0<=d;d--){c[d]==e.floor.floor.properties.namecode&&(h=d);var y=document.createElement("li");y.className="floor-list-item",y.data=d;var _=document.createElement("div");_.innerText=c[d],_.className="floor-btn floor-nonas",y.appendChild(_),y.addEventListener("click",function(e){5<c.length?r.style.top=28*(p-e.currentTarget.data+5)+6+"px":r.style.top=28*(c.length-1-e.currentTarget.data-h)+"px",h=e.currentTarget.data;e=e.currentTarget.innerText;e=(e=e.replace(/\r\n/g,"")).replace(/\n/g,""),m._changeFloor(u,e)}),s.appendChild(y)}a.appendChild(s),5<c.length?((n=document.createElement("div")).className="floor-btn floor-nav floor-plus",n.addEventListener("click",function(){p<c.length-5&&(p++,s.style.top=6-28*(c.length-5-p)+"px",r.style.top=28*(1+p)+6+"px")}),(l=document.createElement("div")).className="floor-btn floor-nav floor-minus",l.addEventListener("click",function(){0<p&&(p--,s.style.top=6-28*(c.length-5-p)+"px",r.style.top=28*(1+p)+6+"px")}),s.style.top=6-28*(c.length-5-p)+"px",r.style.top=28*(p+1)+6+"px",o.appendChild(n),o.appendChild(r),o.appendChild(a),o.appendChild(l),i.addEventListener("mousewheel",function(e){e.deltaY<0?p<c.length-5&&(p++,s.style.top=6-28*(c.length-5-p)+"px",r.style.top=6-28*(h-5-p)+"px"):0<p&&(p--,s.style.top=6-28*(c.length-5-p)+"px",r.style.top=6-28*(h-5-p)+"px")},!1)):(r.style.top=28*(c.length-1-h)+"px",o.appendChild(r),o.appendChild(a)),i.appendChild(o),t.appendChild(i)},MapPlatForm.Base.MapRoomControl.prototype._removeControl=function(){var e=document.getElementById("ZenMap_Room_Control");e&&e.remove()},MapPlatForm.Base.MapRoomControl.prototype.destroy=function(){this._map.removeEventListener("moveend",this._updateFloors,this),this._hasMask&&this._map._obj.removeLayer(this._layerID+"_mask"),this._map._obj.removeLayer(this._floorRegionLayer.id),this._map._obj.removeLayer(this._normalFloorLineLayer.id),this._map._obj.removeLayer(this._activeFloorLineLayer.id),this._map._obj.removeLayer(this._roomLayer.id),this._map._obj.removeLayer(this._labelLayer.id),this._map._obj.removeSource(this._layerID+"_source"),this._removeControl(),this._mapService=null,this._events=null},MapPlatForm.Base.MapRoomControl.prototype.addEventListener=function(e,t,i){this._events.register(e,t,i)},MapPlatForm.Base.MapRoomControl.prototype.removeEventListener=function(e,t){this._events.unregister(e,t)},MapPlatForm.Base.MapGeoRegion=function(e,t){this.CLASS_NAME="MapGeoRegion",this._layerID=ZenMap.Utils.BaseUtils.uuid(),this._map=e,this._polygons={},this._lines={},this.activeFeature=null,this.activePolygon=null,this.activeLine=null,this.opts=t||{},this.mouseOver=this.opts.mouseOver||null,this.mouseOut=this.opts.mouseOut||null,this.click=this.opts.click||null,this._source={type:"geojson",data:{type:"FeatureCollection",features:[]}},this._polygonLayer={id:this._layerID+"_polygon",type:"fill",source:this._layerID+"_source",paint:{"fill-color":["get","fillColor"],"fill-opacity":["get","fillOpacity"]},filter:["==","$type","Polygon"]},this._lineLayer={id:this._layerID+"_line",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":["get","color"],"line-width":["get","width"],"line-opacity":["get","opacity"]},filter:["==","$type","LineString"]},this._activePolygonLayer={id:this._layerID+"_activePolygon",type:"fill",source:this._layerID+"_source",paint:{"fill-color":["get","fillColor"],"fill-opacity":["get","fillOpacity"]},filter:["==","$type","Polygon"]},this._activeLineLayer={id:this._layerID+"_activeLine",type:"line",source:this._layerID+"_source",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":["get","color"],"line-width":["get","width"],"line-opacity":["get","opacity"]},filter:["==","$type","LineString"]},this._labelLayer={id:this._layerID+"_symbol",type:"symbol",source:this._layerID+"_source",layout:{"text-field":"{title}","text-font":["Microsoft YaHei"],"text-size":["get","text-size"],"text-offset":["get","text-offset"],"text-anchor":"center"},paint:{"text-color":["get","text-color"],"text-opacity":["get","text-opacity"]},filter:["==","$type","Point"]}},MapPlatForm.Base.MapGeoRegion.prototype._getFeature=function(e){for(var t=this._map._obj.style._order.length-1;0<=t;t--)if(-1<this._map._obj.style._order[t].indexOf(this._layerID)){var i=this._map._obj.style._order[t];if("none"!=this._map._obj.getLayoutProperty(i,"visibility")){i=this._map._obj.queryRenderedFeatures(e.point,{layers:[i]});if(i&&0<i.length)return[i[0]]}}return[]},MapPlatForm.Base.MapGeoRegion.prototype._mouseout=function(){this._map._obj.getCanvasContainer().style.cursor="",this.mouseOut&&this.activePolygon&&this.mouseOut(this.activePolygon),this.activeFeature=null,this.activeLine=null,this.activePolygon=null},MapPlatForm.Base.MapGeoRegion.prototype._initInteractive=function(e){var t=this;this._mousemoveFun||(this._mousemoveFun=function(e){e=t._getFeature(e);0!=e.length?t.activeFeature&&e[0].properties.id==t.activeFeature.properties.id||(t._mouseout(),e&&0<e.length&&(t._map._obj.getCanvasContainer().style.cursor="pointer",t.activeFeature=e[0],t.activePolygon=t._polygons[e[0].properties.id],t.activeLine=t._lines[e[0].properties.id+"line"],t.mouseOver&&t.activePolygon&&(t.mouseOver(t.activePolygon),t._map._obj.setFilter(t._activePolygonLayer.id,["==","id",t.activePolygon.id]),t._map._obj.setFilter(t._activeLineLayer.id,["==","id",t.activeLine.properties.id])))):t._mouseout()}),this.clickFun||(this.clickFun=function(){t.activePolygon&&t.click(t.activePolygon)}),e?(this._map._obj.on("mousemove",this._mousemoveFun),this._map._obj.on("click",this.clickFun)):(this._map._obj.off("mousemove",this._mousemoveFun),this._map._obj.off("click",this.clickFun))},MapPlatForm.Base.MapGeoRegion.prototype.addGeoRegions=function(e,t){var i=(t=t||{}).fontSize||12,o=t.fontColor||"#000000",r=t.fontOpacity||1,a=t.fontOffset||[0,0],s=!0;if(e&&0<e.length){for(var n=0;n<e.length;n++){var l=(s=e[n]&&"ZenMap.Geometry.Polygon"!=e[n].CLASS_NAME?!1:s)?e[n]:GeoJSON.read(e[n].geometry);l._fillColor=s||void 0===e[n].properties.fillColor?l._fillColor:e[n].properties.fillColor,l._fillOpacity=s||void 0===e[n].properties.fillOpacity?l._fillOpacity:e[n].properties.fillOpacity,l._weight=s||void 0===e[n].properties.weight?l._weight:e[n].properties.weight,l._color=s||void 0===e[n].properties.color?l._color:e[n].properties.color,l._opacity=s||void 0===e[n].properties.opacity?l._opacity:e[n].properties.opacity;var h={type:"Feature",geometry:{type:(this._polygons[l.id]=l).polygonType,coordinates:l._getCoordinates(this._map)},properties:{id:l.id,fillColor:l._fillColor,fillOpacity:l._fillOpacity}};this._source.data.features.push(h);for(var p=0;p<l._getCoordinates(this._map).length;p++){var c={type:"Feature",geometry:{type:"LineString",coordinates:l._getCoordinates(this._map)[p][0]},properties:{id:l.id+"line",color:l._color,width:l._weight,opacity:l._opacity,join:"round"}};this._lines[l.id+"line"]=c,this._source.data.features.push(c)}s&&void 0===e[n].properties.name||(h={type:"Feature",geometry:{type:"Point",coordinates:[l.getCenter().lon,l.getCenter().lat]},properties:{id:l.id,title:e[n].properties.name,"text-offset":a,"text-opacity":r,"text-size":i,"text-color":o}},this._source.data.features.push(h))}this._map._obj.addSource(this._layerID+"_source",this._source),this._map._obj.addLayer(this._polygonLayer),this._map._obj.addLayer(this._lineLayer),this._map._obj.addLayer(this._activePolygonLayer),this._map._obj.addLayer(this._activeLineLayer),s&&void 0===e[n].properties.name||this._map._obj.addLayer(this._labelLayer)}this._initInteractive()},MapPlatForm.Base.MapGeoRegion.prototype.setStyle=function(e){e&&e.fillColor&&this._map._obj.setPaintProperty(this._layerID+"_activePolygon","fill-color",e.fillColor),e&&e.fillOpacity&&this._map._obj.setPaintProperty(this._layerID+"_activePolygon","fill-opacity",e.fillOpacity),e&&e.color&&this._map._obj.setPaintProperty(this._layerID+"_activeLine","line-color",e.color),e&&e.width&&this._map._obj.setPaintProperty(this._layerID+"_activeLine","line-width",e.width),e&&e.opacity&&this._map._obj.setPaintProperty(this._layerID+"_activeLine","line-opacity",e.opacity)},MapPlatForm.Base.MapGeoRegion.prototype.destory=function(){this._map&&(this._initInteractive(!0),this._map._obj.addLayer(this._polygonLayer.id),this._map._obj.addLayer(this._lineLayer.id),this._map._obj.addLayer(this._activePolygonLayer.id),this._map._obj.addLayer(this._activeLineLayer.id),this._labelLayer&&this._map._obj.addLayer(this._labelLayer.id),this._map._obj.removeSource(this._layerID+"_source"),this._map=null),this.activeFeature=null,this.activePolygon=null,this.activeLine=null,this._polygons={},this._lines={}},MapPlatForm.Base.MapGeoRegion.prototype.refresh=function(){this._map&&this._map._obj.getSource(this._layerID+"_source").setData(this._source.data)},function(){var e=MapPlatForm.Base.FlyManager=function(e){this._map=e,this.stops=[],this.currentIndex=0,this.status=!1,this.events=new ZenMap.Events(this,["preStop","afterStop"])};e.prototype.addStops=function(e){this.stops=e},e.prototype.play=function(e){this.status||(this.currentIndex=0,this.events.triggerEvt("preStop",{stop:this.stops[this.currentIndex]}),this.status=!0,this.isRepeat=e,this._map.disableMapOperation(),this._play())},e.prototype.setCenter=function(e,t,i){t=t||this._map._obj.getZoom();var o=ZenMap.T.setPoint(this._map,e),r=(i=i||{}).bearing||0===i.bearing?i.bearing:this._map._obj.getBearing(),a=i.pitch||0===i.pitch?i.pitch:this._map._obj.getPitch(),s=i.speed||1.2,n=i.curve||1,e=i.offset||[0,0],l=i.callback,h=this._map._obj.keyboard.isEnabled(),p=this._map._obj.dragPan.isEnabled(),c=this._map._obj.scrollZoom.isEnabled(),u=this._map._obj.dragRotate.isEnabled(),m=this._map._obj.doubleClickZoom.isEnabled();i.isOnlyFly&&(this._map.disableMapOperation(),this._map.disableKeyboard());var d=this;this._map._obj.easeTo({center:[o.lon,o.lat],zoom:t,bearing:r,pitch:a,speed:s,curve:n,offset:e,animate:i.animate,duration:1e3/s,easing:function(e){return e},callBack:function(){i.isOnlyFly&&(h&&d._map.enableKeyboard(),m&&d._map._obj.doubleClickZoom.enable(),p&&d._map._obj.dragPan.enable(),c&&d._map._obj.scrollZoom.enable(),u&&d._map._obj.dragRotate.enable()),l&&l instanceof Function&&l()}})},e.prototype._play=function(){var e=this;this.status&&this.setCenter(this.stops[e.currentIndex].position,this.stops[e.currentIndex].zoom,{bearing:this.stops[e.currentIndex].bearing,pitch:this.stops[e.currentIndex].pitch,speed:this.stops[e.currentIndex].speed,curve:this.stops[e.currentIndex].curve,animate:0!==e.currentIndex,callback:function(){e.status&&(e.events.triggerEvt("afterStop",{stop:e.stops[e.currentIndex]}),setTimeout(function(){e.currentIndex++,e.status&&(e.currentIndex<e.stops.length?(e.events.triggerEvt("preStop",{stop:e.stops[e.currentIndex]}),e._play()):e.isRepeat?(e.currentIndex=0,e.events.triggerEvt("preStop",{stop:e.stops[e.currentIndex]}),e._play()):(e.status=!1,e._map.enableMapOperation()))},e.stops[e.currentIndex].waitTime))},isOnlyFly:!0})},e.prototype.stop=function(){this._map._obj.stop(),this._map.enableMapOperation(),this.status=!1,this.currentIndex=0},e.prototype.rePlay=function(){this._map._obj.stop(),this.currentIndex=0,this.events.triggerEvt("preStop",{stop:this.stops[this.currentIndex]}),this._play()},e.prototype.continus=function(){this.events.triggerEvt("preStop",{stop:this.stops[this.currentIndex]}),this._play()},e.prototype.pause=function(){this._map._obj.stop(),this.status=!1},e.prototype.addEventListener=function(e,t,i){this.events.register(e,t)},e.prototype.removeEventListener=function(e,t){this._events.unregister(e,t)}}(),MapPlatForm.Base.Stop=function(e,t){this.position=e,this.bearing=t&&t.bearing?t.bearing:0,this.pitch=t&&t.pitch?t.pitch:0,this.zoom=t&&t.zoom?t.zoom:14,this.waitTime=t&&t.waitTime?t.waitTime:0,this.speed=t&&t.speed?t.speed:1.2,this.curve=t&&t.curve?t.curve:1.42,this.name=t&&t.name?t.name:"未知站点"},MapPlatForm.Base.Stop.prototype.setData=function(e){this._data=e},MapPlatForm.Base.Stop.prototype.getData=function(){return this._data},function(){function o(e,t,i,o,r,a){this.id=ZenMap.Utils.BaseUtils.uuid(),this.maxR=t||1e3,this.minR=i||0,this.point=e,this.defaultR=o,this._legend=r||[0,"rgba(0,255,0,0)",.5,"rgba(0,255,0,0.8)",1,"rgba(255,0,0,0.8)"],this._layer={id:this.id,type:"heatmap",source:a,minzoom:0,maxzoom:22,paint:{"heatmap-weight":["interpolate",["linear"],["get","value"],0,0,1,1],"heatmap-intensity":1,"heatmap-color":["interpolate",["linear"],["heatmap-density"]],"heatmap-radius":100,"heatmap-opacity":.8},filter:["==","id",this.id]};for(var s=0;s<this._legend.length;s++)this._layer.paint["heatmap-color"].push(this._legend[s]);this.addMap=function(e){(this._map=e)._obj.addLayer(this._layer)},this._getPixelDistance=function(e,t){var i=this._map._obj.unproject({x:this._map._obj.transform.width,y:this._map._obj.transform.height/2}),o=this._map._obj.getCenter();return t/this._map.getDistance({lon:i.lng,lat:i.lat},{lon:o.lng,lat:o.lat})*this._map._obj.transform.width/2},this.removeMap=function(){this._map&&this._map.getLayer(this._layer.id)&&this._map._obj.removeLayer(this._layer.id)},this.changeRadius=function(e){this.defaultR=e;e=this._getPixelDistance(this.point,e);this._layer.paint["heatmap-radius"]=e,this._map&&this._map._obj.getLayer(this._layer.id)&&(this.defaultR==this.minR?(this._map._obj.removeLayer(this._layer.id),this._map._obj.addLayer(this._layer)):(this._map._obj.setPaintProperty(this._layer.id,"heatmap-opacity",1-this.defaultR/this.maxR),this._map._obj.setPaintProperty(this._layer.id,"heatmap-radius",e)))},this.updataRadius=function(){var e=this._map._obj.getCenter(),e=this._getPixelDistance({lon:e.lng,lat:e.lat},this.defaultR);this._layer.paint["heatmap-radius"]=e,this._map&&this._map._obj.getLayer(this._layer.id)&&this._map._obj.setPaintProperty(this._layer.id,"heatmap-radius",e)}}var e=MapPlatForm.Base.AnimationCircle=function(e){this._map=e,this.id=ZenMap.Utils.BaseUtils.uuid(),this._visible=!0,this._source={type:"geojson",data:{type:"FeatureCollection",features:[]}},this._circles=[]};e.prototype._eventsFun=function(e){var t;this._callBack||((t=this)._callBack=function(){for(var e=0;e<t._circles.length;e++)t._circles[e].updataRadius()}),e?(this._map._obj.on("zoom",this._callBack),this._map._obj.on("zoomend",this._callBack)):(this._map._obj.off("zoom",this._callBack),this._map._obj.off("zoomend",this._callBack))},e.prototype.addCircles=function(e){if(e&&0<e.length){for(var t=0;t<e.length;t++){var i=Math.floor(Math.random()*(e[t].maxR-e[t].minR)+e[t].minR),i=new o(e[t].point,e[t].maxR,e[t].minR,i,e[t].legend,this.id);this._circles.push(i)}this._setData(this._circles);for(t=0;t<this._circles.length;t++)this._circles[t].addMap(this._map),this._circles[t].updataRadius()}},e.prototype._setData=function(e){for(var t=0,i=e.length;t<i;t++){var o=this._map?ZenMap.T.setPoint(this._map,e[t].point):e[t].point;this._source.data.features.push({type:"Feature",geometry:{type:"Point",coordinates:[o.lon,o.lat]},properties:{value:1,id:e[t].id}})}this._map._obj.getSource(this.id)?this._map._obj.getSource(this.id).setData(this._source.data):this._map._obj.addSource(this.id,this._source)},e.prototype.start=function(){var i=this;requestAnimationFrame(function(){for(var e=0;e<i._circles.length;e++){var t=i._circles[e].defaultR;(t+=20)>i._circles[e].maxR&&(t=i._circles[e].minR),i._circles[e].changeRadius(t)}i.start()})}}(),function(){var e=MapPlatForm.Base.MapAnimationCircle=function(e,t){this._map=e,this._layerID=ZenMap.Utils.BaseUtils.uuid(),this._minZoom=t&&t.minZoom?t.minZoom:0,this._maxZoom=t&&t.maxZoom?t.maxZoom:22,this._layer={id:this._layerID,type:"fill",source:this._layerID,minzoom:this._minZoom,maxzoom:this._maxZoom,paint:{"fill-color":["get","fillColor"],"fill-opacity":["get","fillOpacity"]}},this._source={type:"geojson",data:{type:"FeatureCollection",features:[]}},this._map._obj.addSource(this._layerID,this._source),this._map._obj.addLayer(this._layer)};e.prototype.addCircles=function(e){if(e&&0<e.length){this._circles=[];for(var t,i,o=0;o<e.length;o++)e[o]&&e[o].point&&(t=e[o].maxR||2e3,i=Math.floor(Math.random()*+t),i={point:e[o].point,maxR:t,defaultR:i,color:e[o].color||"#FFFFFF"},this._circles.push(i));this._setData(this._circles)}},e.prototype._getCoords=function(e,t){for(var e=this._map?ZenMap.T.setPoint(this._map,e):e,e=ZenMap.T.helper.webMoctorJW2PM(e.lon,e.lat),i=ZenMap.Utils.MapUtil.createRegularPolygon(e,t,60),t=[],o=[],r=0;r<i.length;r++){var a=ZenMap.T.helper.inverseMercator(i[r].lon,i[r].lat);o.push([a.lon,a.lat])}return t.push(o),t},e.prototype._setData=function(e){for(var t=0,i=e.length;t<i;t++)this._source.data.features.push({type:"Feature",geometry:{type:"Polygon",coordinates:this._getCoords(e[t].point,e[t].defaultR)},properties:{fillColor:e[t].color,fillOpacity:1-e[t].defaultR/e[t].maxR,defaultR:e[t].defaultR,maxR:e[t].maxR,center:e[t].point}});this._map._obj.getSource(this._layerID)?this._map._obj.getSource(this._layerID).setData(this._source.data):this._map._obj.addSource(this._layerID,this._source)},e.prototype.start=function(){this._remove=!1,this._start()},e.prototype._start=function(){var o=this;requestAnimationFrame(function(){if(!o._remove){for(var e=performance.now()%5e3/5e3,t=0;t<o._source.data.features.length;t++){var i=o._source.data.features[t].properties.maxR,i=i/2*.9*e+i/2*.1;o._source.data.features[t].properties.defaultR=i,o._source.data.features[t].properties.fillOpacity=.3*(1-e),o._source.data.features[t].geometry.coordinates=o._getCoords(o._source.data.features[t].properties.center,i)}o._map._obj.getSource(o._layerID).setData(o._source.data),o._start()}})},e.prototype.destory=function(){this._remove=!0,this._map._obj.getLayer(this._layerID)&&this._map._obj.removeLayer(this._layerID),this._map._obj.getSource(this._layerID)&&this._map._obj.removeSource(this._layerID),this._map=null}}(),function(){function d(e,t,i){this.map=e,this.tb=t,this.id=i.id,this.centerPoint=i.centerPoint,this.height=i.height,this.position=i.position;var o=i.points;this.name=i&&i.name?i.name:"",this.isBloom=null!=i.isBloom&&i.isBloom,this.floorNum=i.floorNum,this.buildBufferGeometry=new THREE.BufferGeometry,this.material=i.material,this.verticesData={},this.verticesData.repeat=null!=i.repeat&&i.repeat,this.verticesData.vecColor=null!=this.material.side.vecColor&&this.material.side.vecColor,this.verticesData.topColor=this.material.side.topColor||"white",this.verticesData.bottomColor=this.material.side.bottomColor||"white",this.vertices=[],this.normals=[],this.uvs=[],this.colors=[],this.verticesData.vertices=[],this.verticesData.normals=[],this.verticesData.uvs=[],this.verticesData.colors=[],this.verticesData.topvertices=[],this.verticesData.topnormals=[],this.verticesData.topuvs=[],this.verticesData.topcolors=[];for(var r=0,a=[],s=t.utils.projectToWorld([this.position.lon,this.position.lat,0]),n=0;n<o.length-1;n++){var l=ZenMap.T.setPoint(e,new ZenMap.Geometry.Point(o[n][0],o[n][1])),h=t.utils.projectToWorld([l.lon,l.lat,this.height]),l=[h.x-s.x,h.y-s.y,0];0==r&&(r=h.z),a.push(l)}!function(e,t,i,o){for(var r=e[0],a=[new THREE.Vector2(r[0],r[1])],s=r[0],n=r[0],l=r[0],h=r[0],p=1;p<e.length;p++)e[p][0]>n&&(n=e[p][0]),e[p][0]<s&&(s=e[p][0]),e[p][1]>h&&(h=e[p][1]),e[p][1]<l&&(l=e[p][1]),a.push(new THREE.Vector2(e[p][0],e[p][1]));var c=n-s,u=h-l,m=[],d=[];o.vecColor&&(m=ZenMap.Utils.MapUtil.colorRgb(o.topColor),d=ZenMap.Utils.MapUtil.colorRgb(o.bottomColor));for(var y=THREE.ShapeUtils.triangulateShape(a,[]),p=0;p<y.length;p++){var _=y[p];o.topvertices.push(a[_[0]].x,a[_[0]].y,t),o.topvertices.push(a[_[1]].x,a[_[1]].y,t),o.topvertices.push(a[_[2]].x,a[_[2]].y,t),o.topnormals.push(0,0,1),o.topnormals.push(0,0,1),o.topnormals.push(0,0,1),o.topuvs.push((a[_[0]].x-s)/c,(a[_[0]].y-l)/u),o.topuvs.push((a[_[1]].x-s)/c,(a[_[1]].y-l)/u),o.topuvs.push((a[_[2]].x-s)/c,(a[_[2]].y-l)/u),o.vecColor&&(o.topcolors.push(m[0]/256,m[1]/256,m[2]/256),o.topcolors.push(m[0]/256,m[1]/256,m[2]/256),o.topcolors.push(m[0]/256,m[1]/256,m[2]/256))}for(p=0;p<e.length;p++){var f=p+1;f==e.length&&(f=0);var g=(g=e[f][0]-e[p][0],{x:(v=e[f][1]-e[p][1])/Math.sqrt(g*g+v*v),y:-g/Math.sqrt(g*g+v*v)});o.vertices.push(e[p][0],e[p][1],e[p][2]+t),o.vertices.push(e[f][0],e[f][1],e[f][2]),o.vertices.push(e[p][0],e[p][1],e[p][2]),o.normals.push(g.x,g.y,0),o.normals.push(g.x,g.y,0),o.normals.push(g.x,g.y,0),o.vecColor&&(o.colors.push(m[0]/256,m[1]/256,m[2]/256),o.colors.push(d[0]/256,d[1]/256,d[2]/256),o.colors.push(d[0]/256,d[1]/256,d[2]/256));var v=Math.round(i/5);v<1&&(v=1),o.repeat?o.uvs.push(v/5,1):o.uvs.push(1,1),o.uvs.push(0,0),o.uvs.push(0,1),o.vertices.push(e[p][0],e[p][1],e[p][2]+t),o.vertices.push(e[f][0],e[f][1],e[f][2]+t),o.vertices.push(e[f][0],e[f][1],e[f][2]),o.normals.push(g.x,g.y,0),o.normals.push(g.x,g.y,0),o.normals.push(g.x,g.y,0),o.vecColor&&(o.colors.push(m[0]/256,m[1]/256,m[2]/256),o.colors.push(m[0]/256,m[1]/256,m[2]/256),o.colors.push(d[0]/256,d[1]/256,d[2]/256)),o.repeat?(o.uvs.push(v/5,1),o.uvs.push(v/5,0)):(o.uvs.push(1,1),o.uvs.push(1,0)),o.uvs.push(0,0)}}(a,r,this.floorNum,this.verticesData),this.buildBufferGeometry.addGroup(this.vertices.length/3,this.verticesData.topvertices.length/3,0);for(var p=0;p<this.verticesData.topvertices.length;p++)this.vertices.push(this.verticesData.topvertices[p]);for(p=0;p<this.verticesData.topnormals.length;p++)this.normals.push(this.verticesData.topnormals[p]);for(p=0;p<this.verticesData.topuvs.length;p++)this.uvs.push(this.verticesData.topuvs[p]);for(p=0;p<this.verticesData.topcolors.length;p++)this.colors.push(this.verticesData.topcolors[p]);for(this.buildBufferGeometry.addGroup(this.vertices.length/3,this.verticesData.vertices.length/3,1),p=0;p<this.verticesData.vertices.length;p++)this.vertices.push(this.verticesData.vertices[p]);for(p=0;p<this.verticesData.normals.length;p++)this.normals.push(this.verticesData.normals[p]);for(p=0;p<this.verticesData.uvs.length;p++)this.uvs.push(this.verticesData.uvs[p]);for(p=0;p<this.verticesData.colors.length;p++)this.colors.push(this.verticesData.colors[p]);var c=new Float32Array(this.vertices.length);c.set(this.vertices),parseInt(THREE.REVISION),this.buildBufferGeometry.setAttribute("position",new THREE.BufferAttribute(c,3)),(c=new Float32Array(this.normals.length)).set(this.normals),this.buildBufferGeometry.setAttribute("normal",new THREE.BufferAttribute(c,3)),(c=new Float32Array(this.uvs.length)).set(this.uvs),this.buildBufferGeometry.setAttribute("uv",new THREE.BufferAttribute(c,2)),(c=new Float32Array(this.colors.length)).set(this.colors),this.buildBufferGeometry.setAttribute("color",new THREE.BufferAttribute(c,3)),this.mesh=new THREE.Mesh(this.buildBufferGeometry,[this.material.top,this.material.side]),this.mesh.name="GeoBuilding3D-"+i.id,this.mesh.eventID=i.id}var e=MapPlatForm.Base.MapGeoBuilding3D=function(e,t,i){this._map=e,this._events=new ZenMap.Events(this,["click","mousemove","mouseover","mouseout"]),this._minZoom=i&&i.minZoom?i.minZoom:11,this._maxZoom=i&&i.maxZoom?i.maxZoom:22,this.textureImageUrl=i&&i.textureImageUrl?i.textureImageUrl:void 0,this.buildTopColor=i&&i.buildTopColor?i.buildTopColor:"rgb(53,86,160)",this.buildSideColor=i&&i.buildSideColor?i.buildSideColor:["rgb(53,86,160)"],this.transparent=!(!i||null==i.transparent)&&i.transparent,this.repeat=!(!i||null==i.repeat)&&i.repeat,this.opacity=i&&i.opacity?i.opacity:1,this.buildMaterialStyle={textureImageUrl:this.textureImageUrl,buildTopColor:this.buildTopColor,buildSideColor:this.buildSideColor,transparent:this.transparent,repeat:this.repeat,opacity:this.opacity},this.edgesLineColor=i&&i.edgesLineColor?i.edgesLineColor:"yellow",this.tb=t,this.timer=null;var o=this;this.animationSpeed=i&&i.animationSpeed?i.animationSpeed:.15,this.beforeLayerID=i&&i.beforeLayerID?i.beforeLayerID:"city_normal_building_id",this.buildingsArrayGeoJson=[],this._geoBuilding3Ds=[],this._setBuildMaterial(this.buildMaterialStyle),o._map._obj.on("click",function(e){e=function(e){for(var t=o.tb.queryRenderedFeatures(e),i=0;i<t.length;i++)if(-1!=t[i].object.name.indexOf("GeoBuilding3D"))return t[i];return null}(e.point);e&&(e=e.object.eventID,e=o._geoBuilding3Ds[e],o._events.triggerEvt("click",{build:e}))})};e.prototype._setBuildMaterial=function(e){e.textureImageUrl?(this.texture=(new THREE.TextureLoader).load(e.textureImageUrl),this.texture.wrapS=this.texture.wrapT=THREE.RepeatWrapping,this.texture.repeat.set(e.repeat?5:1,1),this.buildSideMaterial=new THREE.MeshStandardMaterial({map:this.texture,transparent:e.transparent,opacity:e.opacity}),this.buildSideMaterial.repeat=e.repeat,this.buildTopMaterial=new THREE.MeshStandardMaterial({color:e.buildTopColor,transparent:e.transparent,opacity:e.opacity})):1<e.buildSideColor.length?(this.buildSideMaterial=new THREE.MeshStandardMaterial({vertexColors:THREE.VertexColors,transparent:e.transparent,opacity:e.opacity}),this.buildSideMaterial.topColor=e.buildSideColor[0],this.buildSideMaterial.bottomColor=e.buildSideColor[1],this.buildSideMaterial.vecColor=!0,this.buildTopMaterial=new THREE.MeshStandardMaterial({vertexColors:THREE.VertexColors,transparent:e.transparent,opacity:e.opacity})):(this.buildSideMaterial=new THREE.MeshStandardMaterial({color:e.buildSideColor[0],transparent:e.transparent,opacity:e.opacity}),this.buildTopMaterial=new THREE.MeshStandardMaterial({color:e.buildTopColor,transparent:e.transparent,opacity:e.opacity})),this.buildMaterials={},this.buildMaterials.top=this.buildTopMaterial,this.buildMaterials.side=this.buildSideMaterial},e.prototype.addBuildings=function(e){this.buildingsArrayGeoJson=e,this._geoBuilding3Ds=[];var t,m=this;for(t in m._geoBuilding3Ds=function(e,t,i){for(var o=[],r=0;r<e.length;r++){var a=e[r].points,s=e[r].floorNum,n=function(e){if(!(e.length<2)){for(var t=0,i=0,o=0,r=e[1],a=2;a<e.length;a++)p2=e[a],area=(e[0][0]*r[1]+r[0]*p2[1]+p2[0]*e[0][1]-r[0]*e[0][1]-p2[0]*r[1]-e[0][0]*p2[1])/2,o+=area,t+=(e[0][0]+r[0]+p2[0])*area,i+=(e[0][1]+r[1]+p2[1])*area,r=p2;return new ZenMap.Geometry.Point(t/o/3,i/o/3)}}(a),l="";e[r].name&&(l=e[r].name);var h=e[r].height,p=new ZenMap.Geometry.Point(e[r].points[0][0],e[r].points[0][1]),c=e[r].id,u=e[r].isBloom||!1,p=ZenMap.T.setPoint(t,p),u={id:c,material:m.buildMaterials,floorNum:s,repeat:m.repeat,centerPoint:n,height:h,name:l,position:p,points:a,isBloom:u},u=new d(m._map,i,u);u.data=e[r].data||{},o[c]=u}return o}(m.buildingsArrayGeoJson,m._map,m.tb),m._geoBuilding3Ds)m._geoBuilding3Ds[t].isBloom?m._geoBuilding3Ds[t].mesh.layers.set(1):m._geoBuilding3Ds[t].mesh.layers.set(0),m.tb.addAtCoordinate(m._geoBuilding3Ds[t].mesh,[m._geoBuilding3Ds[t].position.lon,m._geoBuilding3Ds[t].position.lat])},e.prototype.changeBuildMaterial=function(e){for(var t in e.repeat=this.repeat,this._setBuildMaterial(e),this._geoBuilding3Ds)this._geoBuilding3Ds[t].mesh.material=[this.buildTopMaterial,this.buildSideMaterial]},e.prototype.upBuildHeight=function(e){if(!(1<e||0==e))for(var t in this._geoBuilding3Ds)this._geoBuilding3Ds[t].mesh.scale.set(1,1,e)},e.prototype.downBuildHeight=function(e){if(!(e<0||0==e))for(var t in this._geoBuilding3Ds)this._geoBuilding3Ds[t].mesh.scale.set(1,1,e)},e.prototype._animationDownBuild=function(e){var t=this;this.timer=setTimeout(function(){t.scale=t.scale-.05,t.downBuildHeight(t.scale),t.scale<=0?e&&e instanceof Function&&e():t._animationDownBuild(e)},50)},e.prototype.animationDownBuild=function(e){this.scale=1,clearTimeout(this.timer),this._animationDownBuild(e)},e.prototype._animationUpBuild=function(e){var t=this;this.timer=setTimeout(function(){t.scale=t.scale+.05,t.upBuildHeight(t.scale),1<=t.scale?e&&e instanceof Function&&e():t._animationUpBuild(e)},50)},e.prototype.animationUpBuild=function(e){this.scale=0,clearTimeout(this.timer),this._animationUpBuild(e)},e.prototype.getBuildings=function(){return this._geoBuilding3Ds},e.prototype.setBuildSelectStyle=function(e){this.edgesLineColor=(e&&e.edgesLineColor?e:this).edgesLineColor,this.setBuildSelection(this._selections)},e.prototype.setBuildSelection=function(e){for(var t in this.deleteBuildSelection(),this._selections=e){var i,o;e[t]&&-1!=e[t].mesh.name.indexOf("GeoBuilding3D")&&(i=new THREE.EdgesGeometry(e[t].buildBufferGeometry,1),o=new THREE.LineBasicMaterial({color:this.edgesLineColor}),(o=new THREE.LineSegments(i,o)).name="cubeLine"+e[t].id,this.tb.addAtCoordinate(o,[e[t].position.lon,e[t].position.lat]))}},e.prototype.deleteBuildSelection=function(){for(var e in this._selections)this.tb.world.getObjectByName("cubeLine"+this._selections[e].id)&&this.tb.remove(this.tb.world.getObjectByName("cubeLine"+this._selections[e].id));this._selections=[]},e.prototype.addEventListener=function(e,t,i){this._events.register(e,t,i)},e.prototype.removeEventListener=function(e,t){this._events.unregister(e,t)},e.prototype.destory=function(){for(var e in this._geoBuilding3Ds){var t=this._geoBuilding3Ds[e].id;this.tb.remove(this._geoBuilding3Ds[t].mesh),this._geoBuilding3Ds[e].buildBufferGeometry=null,this._geoBuilding3Ds[e].mesh=null,this._geoBuilding3Ds[e]=null}this._geoBuilding3Ds=null}}(),function(){function y(e,t,i){this.position=e,this.points=t,this.material=i.material,this.centerPoint=i.centerPoint,this.floorIndoorHeight=i.floorIndoorHeight,this.floorIndoorLabelHeight=i.floorIndoorLabelHeight,this.meshName=i.meshName,this.shape=new THREE.Shape;for(var o=0;o<t.length;o++)0==o?this.shape.moveTo(t[o][0],t[o][1]):this.shape.lineTo(t[o][0],t[o][1]);this.geometry=new THREE.ExtrudeGeometry(this.shape,{depth:this.points[0][2],steps:parseInt(1),bevelEnabled:!1});for(var r=0,o=0;o<this.geometry.faceVertexUvs[0].length;o++)r=Math.max(r,this.geometry.vertices[this.geometry.faces[o].a].z);for(var a=0,o=0;o<this.geometry.faceVertexUvs[0].length;o++)this.geometry.vertices[this.geometry.faces[o].a].z==r&&this.geometry.vertices[this.geometry.faces[o].b].z==r&&this.geometry.vertices[this.geometry.faces[o].c].z==r?(this.geometry.faceVertexUvs[0][o][0].set(.5,.5),this.geometry.faceVertexUvs[0][o][1].set(.5,.5),this.geometry.faceVertexUvs[0][o][2].set(.5,.5),a+=1):0==this.geometry.vertices[this.geometry.faces[o].a].z&&0==this.geometry.vertices[this.geometry.faces[o].b].z&&0==this.geometry.vertices[this.geometry.faces[o].c].z&&(a+=1);if(2<=a)for(o=a;o<this.geometry.faceVertexUvs[0].length;o++)this.geometry.faceVertexUvs[0][o][0].set(0,1),this.geometry.faceVertexUvs[0][o][1].set(0,0),this.geometry.faceVertexUvs[0][o][2].set(1,1),this.geometry.faceVertexUvs[0][o+=1][0].set(0,0),this.geometry.faceVertexUvs[0][o][1].set(1,0),this.geometry.faceVertexUvs[0][o][2].set(1,1);this.mesh=new THREE.Mesh(this.geometry,[this.material[0],this.material[1]]),this.mesh.floorIndoorHeight=this.floorIndoorHeight,this.mesh.floorIndoorLabelHeight=this.floorIndoorLabelHeight,this.mesh.name=this.meshName}function l(e,t){this.material=t.material,this.geometry=t.geometry;for(var i=0,o=0;o<this.geometry.faceVertexUvs[0].length;o++)i=Math.max(i,this.geometry.vertices[this.geometry.faces[o].a].z);for(var r=0,o=0;o<this.geometry.faceVertexUvs[0].length;o++)this.geometry.vertices[this.geometry.faces[o].a].z==i&&this.geometry.vertices[this.geometry.faces[o].b].z==i&&this.geometry.vertices[this.geometry.faces[o].c].z==i?(this.geometry.faceVertexUvs[0][o][0].set(.5,.5),this.geometry.faceVertexUvs[0][o][1].set(.5,.5),this.geometry.faceVertexUvs[0][o][2].set(.5,.5),r+=1):0==this.geometry.vertices[this.geometry.faces[o].a].z&&0==this.geometry.vertices[this.geometry.faces[o].b].z&&0==this.geometry.vertices[this.geometry.faces[o].c].z&&(r+=1);if(2<=r)for(o=r;o<this.geometry.faceVertexUvs[0].length;o++)this.geometry.faceVertexUvs[0][o][0].set(0,1),this.geometry.faceVertexUvs[0][o][1].set(0,0),this.geometry.faceVertexUvs[0][o][2].set(1,1),this.geometry.faceVertexUvs[0][o+=1][0].set(0,0),this.geometry.faceVertexUvs[0][o][1].set(1,0),this.geometry.faceVertexUvs[0][o][2].set(1,1);this.mesh=new THREE.Mesh(this.geometry,[this.material[0],this.material[1]]),this.mesh.name=e}function d(e,t,i){this.meshName=i.meshName,this.shape=new THREE.Shape,this.material=i.material,this.realHeight=i.height,this.floorNum=i.floorNum,this.position=e,this.points=t,this.count=this.points.length;for(var o=0;o<t.length;o++)0==o?this.shape.moveTo(t[o][0],t[o][1]):this.shape.lineTo(t[o][0],t[o][1]);this.geometry=new THREE.ExtrudeGeometry(this.shape,{depth:this.points[0][2],steps:parseInt(this.floorNum),bevelEnabled:!1});for(var r=0,o=0;o<this.geometry.faceVertexUvs[0].length;o++)r=Math.max(r,this.geometry.vertices[this.geometry.faces[o].a].z);for(var a=0,o=0;o<this.geometry.faceVertexUvs[0].length;o++)this.geometry.vertices[this.geometry.faces[o].a].z==r&&this.geometry.vertices[this.geometry.faces[o].b].z==r&&this.geometry.vertices[this.geometry.faces[o].c].z==r?(this.geometry.faceVertexUvs[0][o][0].set(.5,.5),this.geometry.faceVertexUvs[0][o][1].set(.5,.5),this.geometry.faceVertexUvs[0][o][2].set(.5,.5),a+=1):0==this.geometry.vertices[this.geometry.faces[o].a].z&&0==this.geometry.vertices[this.geometry.faces[o].b].z&&0==this.geometry.vertices[this.geometry.faces[o].c].z&&(a+=1);if(2<=a)for(o=a;o<this.geometry.faceVertexUvs[0].length;o++)this.geometry.faceVertexUvs[0][o][0].set(0,1),this.geometry.faceVertexUvs[0][o][1].set(0,0),this.geometry.faceVertexUvs[0][o][2].set(1,1),this.geometry.faceVertexUvs[0][o+=1][0].set(0,0),this.geometry.faceVertexUvs[0][o][1].set(1,0),this.geometry.faceVertexUvs[0][o][2].set(1,1);this.mesh=new THREE.Mesh(this.geometry,[this.material[0],this.material[1]]),this.mesh.name=this.meshName}var e=MapPlatForm.Base.MapGeoIndoor3D=function(e,t){this._map=e,this._layerID=ZenMap.Utils.BaseUtils.uuid(),this._minZoom=t&&t.minZoom?t.minZoom:11,this._maxZoom=t&&t.maxZoom?t.maxZoom:22,this.textureImageUrl=t&&t.textureImageUrl?t.textureImageUrl:void 0,this.buildTopColor=t&&t.buildTopColor?t.buildTopColor:"rgb( 65,105,225)",this.buildSideColor=t&&t.buildSideColor?t.buildSideColor:"rgb(44,72,139)",this.buildInternalTopColor=t&&t.buildInternalTopColor?t.buildInternalTopColor:"rgb(51,69,92)",this.buildInternalSideColor=t&&t.buildInternalSideColor?t.buildInternalSideColor:"rgb(137,125,139)",this.opacity=t&&t.opacity?t.opacity:1,this.isTransparent=null==t.isTransparent||t.isTransparent,this._animation=null==t.animation||t.animation,this.isCollision=null==t.isCollision||t.isCollision,this.tb=null,this.timer=null;var i=this;this.notCollisionMeshs=[],this.notCollisionBounds=[],this.notCollisionIndexs=[],this._buildingsLayer={id:this._layerID,type:"custom",renderingMode:"3d",render:function(e,t){e.enable(e.DEPTH_TEST),i._map.getZoom()>=i._minZoom&&(i.tb.update(),i.isCollision&&i._map._obj.isMoving()&&i._updateMarker3D(i))}},this.buildTopMaterial=new THREE.MeshLambertMaterial({color:this.buildTopColor,transparent:this.isTransparent,opacity:this.opacity}),null==this.textureImageUrl?this.buildSideMaterial=new THREE.MeshLambertMaterial({color:this.buildSideColor,transparent:this.isTransparent,opacity:this.opacity}):(this.buildingtexture=(new THREE.TextureLoader).load(this.textureImageUrl),this.buildSideMaterial=new THREE.MeshLambertMaterial({map:this.buildingtexture,transparent:this.isTransparent,opacity:this.opacity,depthTest:!0,depthWrite:!0,wireframe:!1})),this.floorTopMaterial=new THREE.MeshLambertMaterial({color:this.buildTopColor,transparent:this.isTransparent,opacity:this.opacity}),null==this.textureImageUrl?this.floorSideMaterial=new THREE.MeshLambertMaterial({color:this.buildSideColor,transparent:this.isTransparent,opacity:this.opacity}):(this.buildingtexture=(new THREE.TextureLoader).load(this.textureImageUrl),this.floorSideMaterial=new THREE.MeshLambertMaterial({map:this.buildingtexture,transparent:this.isTransparent,opacity:this.opacity,depthTest:!0,depthWrite:!0,wireframe:!1})),this.buildInternalTopMaterial=new THREE.MeshLambertMaterial({color:this.buildInternalTopColor,transparent:this.isTransparent,opacity:this.opacity}),this.buildInternalSideMaterial=new THREE.MeshLambertMaterial({color:this.buildInternalSideColor,transparent:this.isTransparent,opacity:this.opacity})};e.prototype.addBuildings=function(e){this.buildingsArrayGeoJson=e,this._geoBuilding3Ds;var m=this;this._map&&this._map._obj.getLayer(this._layerID)&&(this._map._obj.removeLayer(this._layerID),this.tb=null);m=this;this._buildingsLayer.onAdd=function(e,t){m.tb=new Threebox(e,t,{defaultLights:!0}),m._geoBuilding3Ds=function(e,t,i){for(var o=[],r=0;r<e.length;r++){for(var a=e[r].building.geometry.coordinates[0],s=2e4*e[r].building.properties.height,n=e[r].building.properties.numberofFloor,l=new ZenMap.Geometry.Point(a[0][0],a[0][1]),l=ZenMap.T.getPoint(t,l),l=ZenMap.T.setPoint(t,l),h=i.utils.projectToWorld([l.lon,l.lat,s]),p=[[0,0,h.z]],c=1;c<a.length-1;c++){var u=ZenMap.T.getPoint(t,new ZenMap.Geometry.Point(a[c][0],a[c][1])),u=ZenMap.T.setPoint(t,new ZenMap.Geometry.Point(u.lon,u.lat)),u=i.utils.projectToWorld([u.lon,u.lat,s]),u=[u.x-h.x,u.y-h.y,u.z];p.push(u)}var n={meshName:"build-"+r,material:[m.buildTopMaterial,m.buildSideMaterial],floorNum:n,height:s},n=new d(l,p,n);o.push(n)}return o}(m.buildingsArrayGeoJson,m._map,m.tb);for(var i=0;i<m._geoBuilding3Ds.length;i++)m.tb.addAtCoordinate(m._geoBuilding3Ds[i].mesh,[m._geoBuilding3Ds[i].position.lon,m._geoBuilding3Ds[i].position.lat])},m._animation,this._map._obj.getLayer("city_normal_building_id")?this._map._obj.addLayer(this._buildingsLayer,"city_normal_building_id"):this._map._obj.addLayer(this._buildingsLayer)},e.prototype.expandFloors=function(e,t){this.tb.world.getObjectByName("build-"+e)&&this.tb.remove(this.tb.world.getObjectByName("build-"+e)),this._removeBuild_Floor(),this._removeBuild_Floor_Internal(),this._removeBuild_Floor_Sprite(),this.currentBuildIndex=e,this.currentfloorNumIndex=t,this.currentBuild=this._geoBuilding3Ds[this.currentBuildIndex],this.currentBuildHeight=this.currentBuild.points[0][2],this.realCurrentBuildHeight=this.currentBuild.realHeight,this.currentBuildFloor=this.currentBuild.floorNum;this.floorStartHeightArr=[],this.realFloorStartHeightArr=[],this.floorEndHeightArr=[],this.realFloorEndHeightArr=[],this.floorIndoorHeightArr=[],this.realFloorIndoorHeightArr=[],this.floorIndoorLabelHeightArr=[],this.realFloorIndoorLabelHeightArr=[],this.depthReal=this.realCurrentBuildHeight/this.currentBuildFloor,this.depth=this.tb.utils.projectToWorld([0,0,this.currentBuildHeight/this.currentBuildFloor]).z;var i={geometry:new THREE.ExtrudeGeometry(this.currentBuild.shape,{depth:this.currentBuildHeight/this.currentBuildFloor,steps:parseInt(1),bevelEnabled:!1}),material:[this.floorTopMaterial,this.floorSideMaterial]};this.floorMeshArr=[];for(var o=0;o<this.currentBuildFloor;o++){var r=new l("floor-"+o,i);this.floorStartHeightArr[o]=this.currentBuildHeight*o/this.currentBuildFloor,this.realFloorStartHeightArr[o]=this.realCurrentBuildHeight*o/this.currentBuildFloor,this.floorEndHeightArr[o]=this.currentBuildHeight*o/this.currentBuildFloor,this.realFloorEndHeightArr[o]=this.realCurrentBuildHeight*o/this.currentBuildFloor,this.floorIndoorHeightArr[o]=this.floorEndHeightArr[o],this.realFloorIndoorHeightArr[o]=this.realFloorEndHeightArr[o],this.floorIndoorLabelHeightArr[o]=this.floorEndHeightArr[o]+this.currentBuildHeight/this.currentBuildFloor,this.realFloorIndoorLabelHeightArr[o]=this.realFloorEndHeightArr[o]+this.realCurrentBuildHeight/this.currentBuildFloor,this.floorMeshArr.push(r.mesh)}for(o=1;o<this.currentfloorNumIndex+1;o++)this.tb.addAtCoordinate(this.floorMeshArr[o-1],[this.currentBuild.position.lon,this.currentBuild.position.lat]),this.floorMeshArr[o-1].translateZ(this.floorEndHeightArr[o-1]);this.CurrentInitFloorJson=[],this.CurrentInitSpriteJson=[];for(var a=0;a<this.buildingsArrayGeoJson[0].floor.shops.length;a++){for(var s=[],n=[],o=0;o<this.buildingsArrayGeoJson[0].floor.shops[a].length;o++)s.push(this.buildingsArrayGeoJson[0].floor.shops[a][o].geometry.coordinates[0]),n.push(this.buildingsArrayGeoJson[0].floor.shops[a][o].properties.name);this.CurrentInitFloorJson.push(s),this.CurrentInitSpriteJson.push(n)}this.isCollision=!0,this.floorInternalsArrAll=this._initFloorInternals(this.CurrentInitFloorJson,this._map,this.tb),this.spriteInternalsArrAll=this._initSpriteInternals();for(o=0;o<this.floorInternalsArrAll[this.currentfloorNumIndex].length;o++)this.tb.addAtCoordinate(this.floorInternalsArrAll[this.currentfloorNumIndex][o].mesh,[this.floorInternalsArrAll[this.currentfloorNumIndex][o].position.lon,this.floorInternalsArrAll[this.currentfloorNumIndex][o].position.lat]),this.floorInternalsArrAll[this.currentfloorNumIndex][o].mesh.translateZ(this.floorIndoorHeightArr[this.currentfloorNumIndex]);this._updateMarker3D(this),this._map._obj.triggerRepaint()},e.prototype.unexpandFloors=function(e){this._removeBuild_Floor_Internal(),this._removeBuild_Floor_Sprite(),this._removeBuild_Floor(),null!=e?null==this.tb.world.getObjectByName("build-"+e)&&this.tb.addAtCoordinate(this.currentBuild.mesh,[this.currentBuild.position.lon,this.currentBuild.position.lat]):null==this.tb.world.getObjectByName("build-"+this.currentBuildIndex)&&this.tb.addAtCoordinate(this.currentBuild.mesh,[this.currentBuild.position.lon,this.currentBuild.position.lat]),this._map._obj.triggerRepaint()},e.prototype._initFloorInternals=function(e,t,i){for(var o=[],r=0;r<e.length;r++){for(var a=[],s=e[r],n=0;n<s.length;n++){var l=new ZenMap.Geometry.Point(s[n][0][0],s[n][0][1]),h=function(e){for(var t,i,o,r=0,a=0,s=0,n=e[1],l=2;l<e.length;l++)p2=e[l],area=(t=e[0],i=n,o=p2,(t[0]*i[1]+i[0]*o[1]+o[0]*t[1]-i[0]*t[1]-o[0]*i[1]-t[0]*o[1])/2),s+=area,r+=(e[0][0]+n[0]+p2[0])*area,a+=(e[0][1]+n[1]+p2[1])*area,n=p2;return[r/s/3,a/s/3]}(s[n]),p=ZenMap.T.getPoint(t,new ZenMap.Geometry.Point(h[0],h[1]));p=ZenMap.T.setPoint(t,new ZenMap.Geometry.Point(p.lon,p.lat));for(var h=ZenMap.T.getPoint(t,l),h=ZenMap.T.setPoint(t,h),c=i.utils.projectToWorld([h.lon,h.lat,3]),u=[[0,0,c.z]],m=1;m<s[n].length;m++){var d=ZenMap.T.getPoint(t,new ZenMap.Geometry.Point(s[n][m][0],s[n][m][1])),d=ZenMap.T.setPoint(t,new ZenMap.Geometry.Point(d.lon,d.lat)),d=i.utils.projectToWorld([d.lon,d.lat,3]),d=[d.x-c.x,d.y-c.y,d.z];u.push(d)}l={meshName:"floor"+r+"-"+n,centerPoint:p,material:[this.buildInternalTopMaterial,this.buildInternalSideMaterial],floorIndoorHeight:this.floorIndoorHeightArr[n],floorIndoorLabelHeight:this.floorIndoorLabelHeightArr[n]},l=new y(h,u,l);a.push(l)}o.push(a)}return o},e.prototype._initSpriteInternals=function(){for(var e=[],t=0;t<this.floorInternalsArrAll.length;t++){for(var i=[],o=0;o<this.floorInternalsArrAll[t].length;o++){var r=this._makeTextPoint(this.CurrentInitSpriteJson[t][o],{});r.name="sprite"+t+"-"+o,r.floorIndoorHeight=this.floorIndoorHeightArr[t],r.floorIndoorLabelHeight=this.floorIndoorLabelHeightArr[t],i.push(r)}e.push(i)}return e},e.prototype._makeTextSprite=function(e,t){(t=void 0===t?{}:t).hasOwnProperty("fontface")&&t.fontface,t.hasOwnProperty("fontsize")&&t.fontsize;var i=t.hasOwnProperty("borderThickness")?t.borderThickness:4,o=t.hasOwnProperty("borderColor")?t.borderColor:{r:0,g:0,b:0,a:1},r=t.hasOwnProperty("backgroundColor")?t.backgroundColor:{r:255,g:255,b:255,a:.5},t=(a=document.createElement("canvas")).getContext("2d");t.font="22px bold";t.measureText(e).width;t.fillStyle="rgba("+r.r+","+r.g+","+r.b+","+r.a+")",t.strokeStyle="rgba("+o.r+","+o.g+","+o.b+","+o.a+")",t.lineWidth=i,t.fillText(e,150,40,100);e=new THREE.Texture(a);e.needsUpdate=!0;var e=new THREE.SpriteMaterial({map:e}),e=new THREE.Sprite(e),a=document.createElement("canvas");return e.scale.set(.4,.2,1),e},e.prototype._makeTextPoint=function(e){var t=document.createElement("canvas");t.width=200,t.height=200,t.style.width="100px",t.style.height="100px";var i=t.getContext("2d");i.font='24px " 微软雅黑';var o=i.measureText(e).width;o<=200?(i.lineWidth=6,i.strokeStyle="white",i.strokeText(e,100-o/2,100,200),i.fillStyle="black",i.fillText(e,100-o/2,100,200)):200<o&&(i.lineWidth=6,i.strokeStyle="white",i.strokeText(e,0,100,200),i.fillStyle="black",i.fillText(e,0,100,200));i=new THREE.Texture(t);i.needsUpdate=!0;(new THREE.TextureLoader).load("../../css/images/camera_active.png");e=new THREE.PointsMaterial({size:100,sizeAttenuation:!1,map:i,alphaTest:.3,transparent:!0}),t=new THREE.BufferGeometry,i=[];return i.push(0,0,0),t.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),new THREE.Points(t,e)},e.prototype._caluPOIRect=function(e,t,i){var o=e.lon,e=e.lat,t=this._map._obj.project(new zmapboxgl.LngLat(o,e),t);return{x:t.x-50,y:t.y-14,w:100,h:14}},e.prototype._isPOIRect=function(e,t){var i=e.x,o=e.y,r=e.w,a=e.h,s=t.x,n=t.y,e=t.w,t=t.h;return!(s<=i&&s+e<=i)&&(!(i<=s&&i+r<=s)&&(!(n<=o&&n+t<=o)&&!(o<=n&&o+a<=n)))},e.prototype._removeBuild=function(e){this.tb.world.getObjectByName("build-"+e)&&this.tb.remove(this.tb.world.getObjectByName("build-"+e))},e.prototype._removeBuild_Floor=function(){if(null!=this.floorMeshArr)for(var e=0;e<this.floorMeshArr.length;e++)this.tb.world.getObjectByName("floor-"+e)&&this.tb.remove(this.floorMeshArr[e])},e.prototype._removeBuild_Floor_Sprite=function(){if(this.floorInternalsArrAll){this.isCollision=!1;for(var e=0;e<this.floorInternalsArrAll.length;e++)for(var t=0;t<this.floorInternalsArrAll[e].length;t++)this.tb.world.getObjectByName("sprite"+e+"-"+t)&&this.tb.remove(this.tb.world.getObjectByName("sprite"+e+"-"+t))}},e.prototype._removeBuild_Floor_Internal=function(){if(this.floorInternalsArrAll)for(var e=0;e<this.floorInternalsArrAll.length;e++)for(var t=0;t<this.floorInternalsArrAll[e].length;t++)this.tb.world.getObjectByName("floor"+e+"-"+t)&&this.tb.remove(this.tb.world.getObjectByName("floor"+e+"-"+t))},e.prototype._updateMarker3D=function(e){var r=e;if(r.spriteInternalsArrAll){for(var a=0;a<r.notCollisionMeshs.length;a++){var s=[],n=[],l=[];r.notCollisionMeshs[a].forEach(function(e){var t,i=r._caluPOIRect(e.centerPoint,r.realFloorIndoorLabelHeightArr[a]);for(t in s){var o=s[t];if(r._isPOIRect(o,i))return}s.push(i),n.push(parseInt(e.mesh.name.split("-")[1])),l.push(e)}),r.notCollisionBounds[a]=s,r.notCollisionIndexs[a]=n,r.notCollisionMeshs[a]=l}if(0==r.notCollisionMeshs.length)for(a=0;a<r.floorInternalsArrAll.length;a++){s=[],n=[],l=[];r.floorInternalsArrAll[a].forEach(function(e){var t,i=r._caluPOIRect(e.centerPoint,r.realFloorIndoorLabelHeightArr[a]);for(t in s){var o=s[t];if(r._isPOIRect(o,i))return}s.push(i),n.push(parseInt(e.mesh.name.split("-")[1])),l.push(e)}),r.notCollisionBounds.push(s),r.notCollisionIndexs.push(n),r.notCollisionMeshs.push(l)}for(a=0;a<r.floorInternalsArrAll.length;a++)r.floorInternalsArrAll[a].forEach(function(e){var t,i=r._caluPOIRect(e.centerPoint,r.realFloorIndoorLabelHeightArr[a]);for(t in r.notCollisionBounds[a]){var o=r.notCollisionBounds[a][t];if(parseInt(r.notCollisionMeshs[a][t].mesh.name.split("-")[1])==parseInt(e.mesh.name.split("-")[1]))return;if(r._isPOIRect(o,i))return}r.notCollisionBounds[a].push(i),r.notCollisionMeshs[a].push(e),r.notCollisionIndexs[a].push(parseInt(e.mesh.name.split("-")[1]))});for(var t=0;t<r.floorInternalsArrAll[r.currentfloorNumIndex].length;t++)-1==r.notCollisionIndexs[r.currentfloorNumIndex].indexOf(t)&&r.tb.world.getObjectByName("sprite"+r.currentfloorNumIndex+"-"+t)&&r.tb.remove(r.tb.world.getObjectByName("sprite"+r.currentfloorNumIndex+"-"+t)),-1==r.notCollisionIndexs[r.currentfloorNumIndex].indexOf(t)||r.tb.world.getObjectByName("sprite"+r.currentfloorNumIndex+"-"+t)||(r.tb.addAtCoordinate(r.spriteInternalsArrAll[r.currentfloorNumIndex][t],[r.floorInternalsArrAll[r.currentfloorNumIndex][t].centerPoint.lon,r.floorInternalsArrAll[r.currentfloorNumIndex][t].centerPoint.lat]),r.spriteInternalsArrAll[r.currentfloorNumIndex][t].translateZ(r.floorIndoorLabelHeightArr[r.currentfloorNumIndex]))}},e.prototype._update=function(){this._map.getZoom()>=this._minZoom&&(this._map._obj.repaint=!0),this.timer=setTimeout(this._update.bind(this),100)},e.prototype.destory=function(){if(this.timer&&clearTimeout(this.timer),this._map&&this._map._obj.getLayer(this._layerID)){this._map._obj.removeLayer(this._layerID);for(var e=0;e<this._geoBuilding3Ds.length;e++)this.tb.remove(this._geoBuilding3Ds[e].mesh),this._geoBuilding3Ds[e].geometry=null,this._geoBuilding3Ds[e].mesh=null,this._geoBuilding3Ds[e].shape=null;for(e=this._geoBuilding3Ds.length=0;e<this.floorMeshArr.length;e++)this.tb.remove(this.floorMeshArr[e]),this.floorMeshArr[e]=null;for(e=this.floorMeshArr.length=0;e<this.floorInternalsArrAll.length;e++)this.tb.remove(this.floorInternalsArrAll[e]),this.floorInternalsArrAll[e].mesh=null,this.floorInternalsArrAll[e].geometry=null,this.floorInternalsArrAll[e].shape=null,this.floorInternalsArrAll[e]=null;for(e=this.floorInternalsArrAll.length=0;e<this.spriteInternalsArrAll.length;e++)this.spriteInternalsArrAll[e]=null;this.spriteInternalsArrAll.length=0,this.tb=null}}}(),function(){function v(e,t,i,o){this.position=e,this.points=t,this.count=t.length,this.geometry=new THREE.Geometry,this.colors=[];for(var r=0;r<t.length;r++)this.geometry.vertices.push(t[r]),this.geometry.colors.push(new THREE.Color(o[0],o[1],o[2])),this.colors.push(o[0],o[1],o[2]);this.line=new THREE.Line(this.geometry,i)}var e=MapPlatForm.Base.MapGeoWallLine3D=function(e,t,i){this._map=e,this._springLines=[],this._layerID=ZenMap.Utils.BaseUtils.uuid(),this._minZoom=i&&i.minZoom?i.minZoom:11,this._lineCount=i&&i.lineCount?i.lineCount:10,this._animation=i&&i.animation,this.tb=t,this.timer=null,this._moveCount=Math.floor(this._lineHeight/this._speed)};e.prototype.addLines=function(e){var g=new THREE.LineBasicMaterial({color:16777215,vertexColors:!0,linewidth:5});this._geoLine3Ds=[],this.lines=e;this._geoLine3Ds=function(e,t,i,o){for(var r=[],a=0;a<e.length;a++){for(var s={index:0,count:o,lines:[],colors:[]},n=e[a].getPath(),l=e[a].getData(),h=(l=l||{}).colors||["#6ff3f3","#f7e513","#a4ec62","#77e8b4","#81d1e8","#c48eec","#c48eec"],p=0;p<o;p++){for(var c=l.height||20,u=ZenMap.T.setPoint(t,n[0]),m=i.utils.projectToWorld([u.lon,u.lat,(p+1)*(c/o)]),d=[new THREE.Vector3(0,0,m.z)],y=1;y<n.length;y++){var _=ZenMap.T.setPoint(t,n[y]),_=i.utils.projectToWorld([_.lon,_.lat,(p+1)*(c/o)]),_=new THREE.Vector3(_.x-m.x,_.y-m.y,_.z);d.push(_)}var f=ZenMap.Utils.MapUtil.colorRgb(h[p%h.length]),f=new v(u,d,g,[f[0]/256,f[1]/256,f[2]/256]);l.isBloom&&f.line.layers.set(1),s.lines.push(f),s.colors.push(f.geometry.colors)}r.push(s)}return r}(this.lines,this._map,this.tb,this._lineCount);for(var t=0;t<this._geoLine3Ds.length;t++)for(var i=0;i<this._geoLine3Ds[t].lines.length;i++)this.tb.addAtCoordinate(this._geoLine3Ds[t].lines[i].line,[this._geoLine3Ds[t].lines[i].position.lon,this._geoLine3Ds[t].lines[i].position.lat]);this._animation&&this._update()},e.prototype._update=function(){for(var e=0;e<this._geoLine3Ds.length;e++){this._geoLine3Ds[e].index<0&&(this._geoLine3Ds[e].index=this._geoLine3Ds[e].count-1);for(var t=0;t<this._lineCount;t++){var i=this._geoLine3Ds[e].colors[(this._geoLine3Ds[e].index+t)%this._lineCount];this._geoLine3Ds[e].lines[t].line.geometry._bufferGeometry?(i=this._geoLine3Ds[e].lines[(this._geoLine3Ds[e].index+t)%this._lineCount].colors,this._geoLine3Ds[e].lines[t].line.geometry._bufferGeometry.setAttribute("color",new THREE.Float32BufferAttribute(i,3))):this._geoLine3Ds[e].lines[t].line.geometry.colors=i}this._geoLine3Ds[e].index--}this._map.getZoom()>=this._minZoom&&(this._map._obj.repaint=!0),this.timer=setTimeout(this._update.bind(this),200)},e.prototype.destory=function(){this.timer&&clearTimeout(this.timer);for(var e=0;e<this._geoLine3Ds.length;e++)for(var t=0;t<this._geoLine3Ds[e].lines.length;t++)this.tb.remove(this._geoLine3Ds[e].lines[t].line);this._geoLine3Ds.length=0}}(),MapPlatForm.Base.ClusterManager=function(e,t){this.CLASS_NAME="ClusterManager",this.map=e,this._layers={},this.opts=t},MapPlatForm.Base.ClusterManager.prototype.addClusters=function(e){var t,i=this.opts.clusterImage;for(t in e)if(this.map.getLayerByName(t))(a=this.map.getLayerByName(t)).useCluster&&a.addClusters(e[t]);else{for(var o=[],r=0;r<i.length;r++)o.push(r%2==0?t+i[r]:i[r]);this.opts.clusterImage=o;var a=new ZenMap.Layers.OverlayLayer(t,!0,this.opts),s=new ZenMap.Symbols.ClusterPoints(e[t]);this.map.addLayer(a),a.addOverlay(s),this._layers[t]=a}},MapPlatForm.Base.ClusterManager.prototype.addClusterPoints=function(e,t){this.map.getLayerByName(e)&&this.map.getLayerByName(e).addClusterPoints(t)},MapPlatForm.Base.ClusterManager.prototype.setMakrerTypeVisiable=function(e,t,i){this.map.getLayerByName(e)&&this.map.getLayerByName(e).setMakrerTypeVisiable(t,i)},MapPlatForm.Base.ClusterManager.prototype.hide=function(){for(var e in this._layers)this._layers.hasOwnProperty(e)&&this._layers[e].hide()},MapPlatForm.Base.ClusterManager.prototype.show=function(){for(var e in this._layers)this._layers.hasOwnProperty(e)&&this._layers[e].show()},MapPlatForm.Base.ClusterManager.prototype.refresh=function(){for(var e in this._layers)this._layers.hasOwnProperty(e)&&this._layers[e].refresh()},MapPlatForm.Base.ClusterManager.prototype.getVisibleClustersByExtent=function(e,t){return this._layers[e]&&this._layers[e].getVisible()?this._layers[e].containFeatures(t,function(e){return e.location._visible}):[]},MapPlatForm.Base.ClusterManager.prototype.getVisibleByKey=function(e){return!(!this._layers[e]||!this._layers[e].getVisible())},function(){function a(e,t,i){this._map=e,this._tb=t,this.id=i.id,this.el=i.element,this.marker=new zmapboxgl.Marker(this.el,{anchor:"bottom"}),this.position=i.position,this.height=i&&i.height?i.height:0,this.baseLineHeight=i&&i.baseLineHeight?i.baseLineHeight:0,this.lineColor=i&&i.lineColor?i.lineColor:"white",this.lineEnableTexture=!(!i||null==i.lineEnableTexture)&&i.lineEnableTexture,this.lineTextureUrl=i&&i.lineTextureUrl?i.lineTextureUrl:"",this.lineTextureWidth=i&&i.lineTextureWidth?i.lineTextureWidth:2,this.isBloom=null!=i.isBloom&&i.isBloom;var o,r,a=this._tb.utils.projectToWorld([this.position.lon,this.position.lat,this.baseLineHeight]),s=a.z,n=this._tb.utils.projectToWorld([this.position.lon,this.position.lat,this.height]),e=n.z;this.lineEnableTexture&&""!=this.lineTextureUrl?(t=(new THREE.TextureLoader).load(this.lineTextureUrl),o=new THREE.MeshBasicMaterial({map:t,side:THREE.DoubleSide,blending:THREE.AdditiveBlending,transparent:!0}),r=new THREE.BufferGeometry,i=new Float32Array(36),t=.01*this.lineTextureWidth,i.set([-1*t,0,s,t,0,s,t,0,e,t,0,e,-1*t,0,e,-1*t,0,s,0,-1*t,s,0,t,s,0,t,e,0,t,e,0,-1*t,e,0,-1*t,s]),110<=parseInt(THREE.REVISION)?r.setAttribute("position",new THREE.BufferAttribute(i,3)):r.addAttribute("position",new THREE.BufferAttribute(i,3)),(i=new Float32Array(36)).set([0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0]),110<=parseInt(THREE.REVISION)?r.setAttribute("normal",new THREE.BufferAttribute(i,3)):r.addAttribute("normal",new THREE.BufferAttribute(i,3)),(i=new Float32Array(24)).set([0,0,1,0,1,1,1,1,0,1,0,0,0,0,1,0,1,1,1,1,0,1,0,0]),110<=parseInt(THREE.REVISION)?r.setAttribute("uv",new THREE.BufferAttribute(i,2)):r.addAttribute("uv",new THREE.BufferAttribute(i,2)),this.line=new THREE.Mesh(r,o)):(o=new THREE.LineBasicMaterial({color:this.lineColor,linecap:"round",linejoin:"round"}),r=new THREE.Geometry,a=new THREE.Vector3(0,0,a.z),n=new THREE.Vector3(0,0,n.z),r.vertices.push(a,n),this.line=new THREE.Line(r,o)),this.line.name="MapMarker3DLine"+this.id}var e=MapPlatForm.Base.MapMarker3DLayer=function(e,t,i){this._map=e,this._tb=t,this._mapMarker3Ds=[],this._minZoom=i&&i.minZoom?i.minZoom:11,this._maxZoom=i&&i.maxZoom?i.maxZoom:22,this.lineVisiable=!(!i||null==i.lineVisiable)&&i.lineVisiable,this.projectChange=!i||null==i.projectChange||i.projectChange,this._events=new ZenMap.Events(this,["click","mousemove","mouseover","mouseout"]),this.marker3DsDataArray=[]};e.prototype.addMarker3Ds=function(e){for(var r=this,t=0;t<e.length;t++)this.marker3DsDataArray.push(e[t]);r._mapMarker3Ds=function(e){for(var t=[],i=0;i<e.length;i++){var o={id:ZenMap.Utils.BaseUtils.uuid(),element:e[i].dom,position:e[i].point,height:e[i].height,baseLineHeight:e[i].baseLineHeight,lineColor:e[i].lineColor,lineEnableTexture:e[i].lineEnableTexture,lineTextureUrl:e[i].lineTextureUrl,lineTextureWidth:e[i].lineTextureWidth,isBloom:null!=e[i].isBloom&&e[i].isBloom},o=new a(r._map,r._tb,o);o.data=e[i].data||{},t.push(o)}return t}(r.marker3DsDataArray,(r._map,r._tb));for(t=0;t<r._mapMarker3Ds.length;t++){var i=null,i=r.projectChange?ZenMap.T.setPoint(r._map,new ZenMap.Geometry.Point(r._mapMarker3Ds[t].position.lon,r._mapMarker3Ds[t].position.lat)):r._mapMarker3Ds[t].position;r.lineVisiable&&(r._mapMarker3Ds[t].isBloom?r._mapMarker3Ds[t].line.layers.set(1):r._mapMarker3Ds[t].line.layers.set(0),r._tb.addAtCoordinate(r._mapMarker3Ds[t].line,[i.lon,i.lat])),r._mapMarker3Ds[t].marker.setLngLat([i.lon,i.lat],r._mapMarker3Ds[t].height),r._mapMarker3Ds[t].marker.addTo(r._map._obj),function(e){var t=r._mapMarker3Ds[e];t.el.onclick=function(e){r._events.triggerEvt("click",t),e.stopPropagation()},t.el.onmousemove=function(){r._events.triggerEvt("mousemove",t)},t.el.onmouseover=function(){r._events.triggerEvt("mouseover",t)},t.el.onmouseout=function(){r._events.triggerEvt("mouseout",t)}}(t)}},e.prototype.removeMarker3Ds=function(){for(var e=0;e<this._mapMarker3Ds.length;e++){this._mapMarker3Ds[e].marker.remove();var t=this._tb.world.getObjectByName("MapMarker3DLine"+this._mapMarker3Ds[e].id);t&&this._tb.remove(t)}this.marker3DsDataArray=[]},e.prototype.hide=function(){for(var e=0;e<this._mapMarker3Ds.length;e++){this._mapMarker3Ds[e].marker.getElement().style.display="none";var t=this._tb.world.getObjectByName("MapMarker3DLine"+this._mapMarker3Ds[e].id);t&&(t.visible=!1)}},e.prototype.show=function(){for(var e=0;e<this._mapMarker3Ds.length;e++){this._mapMarker3Ds[e].marker.getElement().style.display="block";var t=this._tb.world.getObjectByName("MapMarker3DLine"+this._mapMarker3Ds[e].id);t&&(t.visible=!0)}},e.prototype.addEventListener=function(e,t,i){this._events.register(e,t,i)},e.prototype.removeEventListener=function(e,t){this._events.unregister(e,t)},e.prototype.destory=function(){this._events=null;for(var e=0;e<this._mapMarker3Ds.length;e++){this._mapMarker3Ds[e].marker.remove(),this._mapMarker3Ds[e].marker=null;var t=this._tb.world.getObjectByName("MapMarker3DLine"+this._mapMarker3Ds[e].id);t&&this._tb.remove(t),this._mapMarker3Ds[e].line=null,this._mapMarker3Ds[e]=null}this.marker3DsDataArray.length=0,this._mapMarker3Ds.length=0}}(),function(){function a(e,t,i){this._map=e,this._tb=t,this.id=i.id,this.position=i.position,this.height=i&&i.height?i.height:0,this.showType=i&&i.showType?i.showType:"text",this.imgUrl=i&&i.imgUrl?i.imgUrl:"",this.imgSize=i&&i.imgSize?i.imgSize:24,this.message=i&&i.message?i.message:"",this.baseLineHeight=i.baseLineHeight||0,this.lineColor=i&&i.lineColor?i.lineColor:"white",this.lineEnableTexture=null!=i.lineEnableTexture&&i.lineEnableTexture,this.lineTextureUrl=i&&i.lineTextureUrl?i.lineTextureUrl:"",this.lineTextureWidth=i&&i.lineTextureWidth?i.lineTextureWidth:2,this.isBloom=null!=i.isBloom&&i.isBloom,this.bounds=i.bounds;var o,r,a,s=this._tb.utils.projectToWorld([this.position.lon,this.position.lat,this.baseLineHeight]),n=s.z,l=this._tb.utils.projectToWorld([this.position.lon,this.position.lat,this.height]),h=l.z;"img"==this.showType&&(this.imgTexture=(new THREE.TextureLoader).load(this.imgUrl),this.material=new THREE.PointsMaterial({size:this.imgSize,sizeAttenuation:!1,map:this.imgTexture,alphaTest:.3,transparent:!0})),"text"==this.showType&&((o=document.createElement("canvas")).width=200,o.height=200,o.style.width="200px",o.style.height="200px",(e=o.getContext("2d")).font='24px " 微软雅黑',(t=e.measureText(this.message).width)<=200?(e.lineWidth=6,e.strokeStyle="white",e.strokeText(this.message,100-t/2,100,200),e.fillStyle="black",e.fillText(this.message,100-t/2,100,200)):200<t&&(e.lineWidth=6,e.strokeStyle="white",e.strokeText(message,0,100,200),e.fillStyle="black",e.fillText(message,0,100,200)),this.textTexture=new THREE.Texture(o),this.textTexture.needsUpdate=!0,this.material=new THREE.PointsMaterial({size:100,sizeAttenuation:!1,map:this.textTexture,alphaTest:.3,transparent:!0})),this.geometry=new THREE.BufferGeometry,this.geometry.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0],3)),this.pointMesh=new THREE.Points(this.geometry,this.material),this.pointMesh.name="markerReal3D"+this.id,this.pointMesh.eventID=i.id,this.lineEnableTexture&&""!=this.lineTextureUrl?(o=(new THREE.TextureLoader).load(this.lineTextureUrl),a=new THREE.MeshBasicMaterial({map:o,side:THREE.DoubleSide,blending:THREE.AdditiveBlending,transparent:!0}),r=new THREE.BufferGeometry,i=new Float32Array(36),o=.01*this.lineTextureWidth,i.set([-1*o,0,n,o,0,n,o,0,h,o,0,h,-1*o,0,h,-1*o,0,n,0,-1*o,n,0,o,n,0,o,h,0,o,h,0,-1*o,h,0,-1*o,n]),110<=parseInt(THREE.REVISION)?r.setAttribute("position",new THREE.BufferAttribute(i,3)):r.addAttribute("position",new THREE.BufferAttribute(i,3)),(i=new Float32Array(36)).set([0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0]),110<=parseInt(THREE.REVISION)?r.setAttribute("normal",new THREE.BufferAttribute(i,3)):r.addAttribute("normal",new THREE.BufferAttribute(i,3)),(i=new Float32Array(24)).set([0,0,1,0,1,1,1,1,0,1,0,0,0,0,1,0,1,1,1,1,0,1,0,0]),110<=parseInt(THREE.REVISION)?r.setAttribute("uv",new THREE.BufferAttribute(i,2)):r.addAttribute("uv",new THREE.BufferAttribute(i,2)),this.line=new THREE.Mesh(r,a)):(r=new THREE.LineBasicMaterial({color:this.lineColor,linecap:"round",linejoin:"round"}),a=new THREE.Geometry,a=new THREE.Geometry,s=new THREE.Vector3(0,0,s.z),l=new THREE.Vector3(0,0,l.z),a.vertices.push(s,l),this.line=new THREE.Line(a,r)),this.line.name="markerLineReal3D"+this.id}var e=MapPlatForm.Base.MapMarkerReal3DLayer=function(e,t,i){this._map=e,this._tb=t;this._mapRealMarker3Ds=[],this._minZoom=i&&i.minZoom?i.minZoom:11,this._maxZoom=i&&i.maxZoom?i.maxZoom:22,this.isCollision=!(!i||null==i.isCollision)&&i.isCollision,this.lineVisiable=!(!i||null==i.lineVisiable)&&i.lineVisiable,this.projectChange=!i||null==i.projectChange||i.projectChange,this._events=new ZenMap.Events(this,["click","mousemove","mouseover","mouseout"])};e.prototype.addMarker3Ds=function(e){var r=this;this._mapRealMarker3Ds=[];for(var t in this._mapRealMarker3Ds=function(e){for(var t=[],i=0;i<e.length;i++){var o={point:e[i].point,height:e[i].height||0,message:e[i].message,showType:e[i].showType,imgSize:e[i].imgSize},o=r._caluPOIRect(o),o={id:ZenMap.Utils.BaseUtils.uuid(),position:e[i].point,height:e[i].height||0,showType:e[i].showType,imgUrl:e[i].imgUrl,imgSize:e[i].imgSize,message:e[i].message,baseLineHeight:e[i].baseLineHeight||0,lineColor:e[i].lineColor,lineEnableTexture:e[i].lineEnableTexture,lineTextureUrl:e[i].lineTextureUrl,lineTextureWidth:e[i].lineTextureWidth,isBloom:null!=e[i].isBloom&&e[i].isBloom,bounds:o};t[e[i].id]=new a(r._map,r._tb,o),t[e[i].id].data=e[i].data||{}}return t}(e,(r._map,r._tb)),r._mapRealMarker3Ds){var i,o=null,o=r.projectChange?ZenMap.T.setPoint(r._map,r._mapRealMarker3Ds[t].position):r._mapRealMarker3Ds[t].position;r._mapRealMarker3Ds[t].isBloom?r._mapRealMarker3Ds[t].pointMesh.layers.set(1):r._mapRealMarker3Ds[t].pointMesh.layers.set(0),r._tb.addAtCoordinate(r._mapRealMarker3Ds[t].pointMesh,[o.lon,o.lat]),0<r._mapRealMarker3Ds[t].height&&(i=r._tb.utils.projectToWorld([r._mapRealMarker3Ds[t].position.lon,r._mapRealMarker3Ds[t].position.lat,r._mapRealMarker3Ds[t].height]).z,r._mapRealMarker3Ds[t].pointMesh.translateZ(i)),r.lineVisiable&&(r._mapRealMarker3Ds[t].isBloom?r._mapRealMarker3Ds[t].line.layers.set(1):r._mapRealMarker3Ds[t].line.layers.set(0),r._tb.addAtCoordinate(r._mapRealMarker3Ds[t].line,[o.lon,o.lat]))}r._map._obj.on("mousemove",function(e){var t,i=e.point;for(t in r._mapRealMarker3Ds){var o=r._mapRealMarker3Ds[t],o={point:o.position,height:o.height,message:o.message,showType:o.showType,imgSize:o.imgSize},o=r._caluPOIRect(o);r._mapRealMarker3Ds[t].bounds=o,r._pointIsPOIRect(i,r._mapRealMarker3Ds[t].bounds)&&(r._events.triggerEvt("mousemove",r._mapRealMarker3Ds[t]),r._map._obj.getCanvas().style.cursor="pointer")}}),r._map._obj.on("click",function(e){var t,i=e.point;for(t in r._mapRealMarker3Ds)r._pointIsPOIRect(i,r._mapRealMarker3Ds[t].bounds)&&r._events.triggerEvt("click",r._mapRealMarker3Ds[t])}),r._map._obj.on("mouseover",function(e){var t,i=e.point;for(t in r._mapRealMarker3Ds)r._pointIsPOIRect(i,r._mapRealMarker3Ds[t].bounds)&&(r._events.triggerEvt("mouseover",r._mapRealMarker3Ds[t]),r._map._obj.getCanvas().style.cursor="pointer")}),r._map._obj.on("mouseout",function(e){var t,i=e.point;for(t in r._mapRealMarker3Ds)r._pointIsPOIRect(i,r._mapRealMarker3Ds[t].bounds)&&(r._events.triggerEvt("mouseout",r._mapRealMarker3Ds[t]),r._map._obj.getCanvas().style.cursor="pointer")})},e.prototype.removeMarker3Ds=function(){for(var e=0;e<this._mapRealMarker3Ds.length;e++){var t=this._tb.world.getObjectByName("markerReal3D"+this._mapRealMarker3Ds[e].id);t&&this._tb.remove(t);t=this._tb.world.getObjectByName("markerLineReal3D"+this._mapRealMarker3Ds[e].id);t&&this._tb.remove(t)}},e.prototype._caluPOIRect=function(e){var t=e.point,t=ZenMap.T.setPoint(this._map,t),i=e.height,o=e&&e.message?e.message:"",r=e.showType,a=e.imgSize,e=t.lon,t=t.lat,t=this._map._obj.project(new zmapboxgl.LngLat(e,t),i);if("text"==r){i=document.createElement("canvas");i.width=200,i.height=200,i.style.width="200px",i.style.height="200px";i=i.getContext("2d");i.font='24px " 微软雅黑';var s,n,l,h,o=i.measureText(o).width;return o<=200?(s=t.x-o/2/2,n=t.y-14,l=o/2,h=14):200<o&&(s=t.x-50,n=t.y-14,l=100,h=14),{x:s,y:n,w:l,h:h}}if("img"==r)return{x:t.x-a/2,y:t.y-a/2,w:a,h:a}},e.prototype._isPOIRect=function(e,t){var i=e.x,o=e.y,r=e.w,a=e.h,s=t.x,n=t.y,e=t.w,t=t.h;return!(s<=i&&s+e<=i)&&(!(i<=s&&i+r<=s)&&(!(n<=o&&n+t<=o)&&!(o<=n&&o+a<=n)))},e.prototype._pointIsPOIRect=function(e,t){var i=t.x,o=t.y,r=t.w,a=t.h,t=e.x,e=e.y;return i<t&&t<i+r&&o<e&&e<o+a},e.prototype.addEventListener=function(e,t,i){this._events.register(e,t,i)},e.prototype.removeEventListener=function(e,t){this._events.unregister(e,t)},e.prototype.destory=function(){this._events=null;for(var e=0;e<this._mapRealMarker3Ds.length;e++){var t=this._tb.world.getObjectByName("markerReal3D"+this._mapRealMarker3Ds[e].id);t&&this._tb.remove(t),this._mapRealMarker3Ds[e].pointMesh=null;t=this._tb.world.getObjectByName("markerLineReal3D"+this._mapRealMarker3Ds[e].id);t&&this._tb.remove(t),this._mapRealMarker3Ds[e].line=null,this._mapRealMarker3Ds[e]=null}this._mapRealMarker3Ds.length=0}}(),function(){var e=MapPlatForm.Base.AnimationRadar=function(e,t,i){this._map=e,this._layerID=ZenMap.Utils.BaseUtils.uuid(),this._minZoom=i&&i.minZoom?i.minZoom:11,this._lineWidth=i&&i.lineWidth?i.lineWidth:5,this._lineColor=i&&i.lineColor?i.lineColor:"#FF0000",this._angleColor=i&&i.angleColor?i.angleColor:"#FF0000",this._animation=i&&i.animation,this.tb=t,this.timer=null,this.depthTest=!1,this._initMaterial()};e.prototype._initMaterial=function(){this.lineMaterial=new THREE.LineMaterial({color:this._lineColor,linewidth:5e-4*this._lineWidth,dashed:!1,transparent:!0,opacity:1,fog:!0,depthTest:this.depthTest,wireframe:!1}),this.dlineMaterial=new THREE.LineMaterial({color:this._lineColor,dashSize:1,gapSize:1,dashScale:2,scale:2,linewidth:.0015,opacity:1,depthTest:this.depthTest,dashed:!0}),this.dlineMaterial.defines.USE_DASH="",this.dlineMaterial1=new THREE.LineMaterial({color:this._lineColor,depthTest:this.depthTest,linewidth:.001,opacity:1}),this.matLineBasic=new THREE.LineBasicMaterial({color:this._lineColor,opacity:.2,transparent:!0,depthTest:this.depthTest}),this.rmaterial=new THREE.ShaderMaterial({uniforms:{color:{value:new THREE.Color(16777215)},fogColor:{value:this.tb.scene.fog.color},fogNear:{value:this.tb.scene.fog.near},fogFar:{value:this.tb.scene.fog.far}},depthTest:this.depthTest,fog:!0,vertexShader:"#include <fog_pars_vertex>\nattribute float cusmtomOpacity;attribute vec3 customColor;varying vec3 vColor;varying float vOpacity;void main() {vColor = customColor;vOpacity = cusmtomOpacity;vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );gl_Position = projectionMatrix * mvPosition;\n\t#include <fog_vertex>\n\t}",fragmentShader:"#include <fog_pars_fragment>\nuniform vec3 color;varying vec3 vColor;varying float vOpacity;void main() {gl_FragColor = vec4(color * vColor,vOpacity);\n\t#include <fog_fragment>\n\t}",transparent:!0}),this.circleMaterial=this.rmaterial.clone(),this.materialCuXu=new THREE.LineMaterial({color:this._lineColor,linewidth:.005,depthTest:this.depthTest,opacity:1})},e.prototype.add=function(e,t){var B=this;this.obj=function(e,t,i,o,r){for(var a=ZenMap.Utils.MapUtil.colorRgb(r),s={},n=ZenMap.T.setPoint(i,e),l=o.utils.projectToWorld([n.lon,n.lat,0]),h=ZenMap.T.helper.webMoctorJW2PM(n.lon,n.lat),p=ZenMap.Utils.MapUtil.createRegularPolygon(h,t,60),c=[],u=[],m=[],d=0;d<p.length-1;d++){var y=ZenMap.T.helper.inverseMercator(p[d].lon,p[d].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]);c.push(l.x-l.x,l.y-l.y,0),u.push(a[0]/256,a[1]/256,a[2]/256),m.push(0),c.push(_.x-l.x,_.y-l.y,0),u.push(a[0]/256,a[1]/256,a[2]/256),m.push(.2),y=ZenMap.T.helper.inverseMercator(p[d+1].lon,p[d+1].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]),c.push(_.x-l.x,_.y-l.y,0),u.push(a[0]/256,a[1]/256,a[2]/256),m.push(.2)}i=new THREE.BufferGeometry,e=new Float32Array(c.length);e.set(c),i.setAttribute("position",new THREE.BufferAttribute(e,3));e=new Float32Array(u.length);e.set(u),i.setAttribute("customColor",new THREE.BufferAttribute(e,3));e=new Float32Array(m.length);e.set(m),i.setAttribute("cusmtomOpacity",new THREE.BufferAttribute(e,1));e=new THREE.Mesh(i,B.circleMaterial);o.addAtCoordinate(e,[n.lon,n.lat]),s.circle=e;for(var f=[],d=0;d<p.length;d++){y=ZenMap.T.helper.inverseMercator(p[d].lon,p[d].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]);f.push(_.x-l.x,_.y-l.y,_.z)}i=new THREE.LineGeometry;i.setPositions(f);e=new THREE.Line2(i,B.lineMaterial);o.addAtCoordinate(e,[n.lon,n.lat]),s.outLine=e;for(var g=[],d=0;d<p.length;d+=5){y=ZenMap.T.helper.inverseMercator(p[d].lon,p[d].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]);g.push(0,0,0),g.push(_.x-l.x,_.y-l.y,_.z)}i=new THREE.BufferGeometry;i.setAttribute("position",new THREE.Float32BufferAttribute(g,3)),i.computeBoundingSphere();e=new THREE.Line(i,B.matLineBasic);o.addAtCoordinate(e,[n.lon,n.lat]),s.sline=e;for(var v=ZenMap.Utils.MapUtil.createRegularPolygon(h,.85*t,60),M=[],d=0;d<v.length;d++){y=ZenMap.T.helper.inverseMercator(v[d].lon,v[d].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]);M.push(_.x-l.x,_.y-l.y,_.z)}i=new THREE.LineGeometry;i.setPositions(M);e=new THREE.Line2(i,B.dlineMaterial);e.computeLineDistances(),o.addAtCoordinate(e,[n.lon,n.lat]),s.dline=e,s.lines=[];for(var b=0;b<3;b++){for(var P=ZenMap.Utils.MapUtil.createRegularPolygon(h,t*(.7-.15*b),60),x=[],d=0;d<P.length;d++){y=ZenMap.T.helper.inverseMercator(P[d].lon,P[d].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]);x.push(_.x-l.x,_.y-l.y,_.z)}if(0==b){s.lines2=[];for(var w=0;w<3;w++){vvs=[];for(d=20*w;d<20*w+8;d++){y=ZenMap.T.helper.inverseMercator(P[d].lon,P[d].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]);vvs.push(_.x-l.x,_.y-l.y,_.z)}var L=new THREE.LineGeometry;L.setPositions(vvs);L=new THREE.Line2(L,B.materialCuXu);o.addAtCoordinate(L,[n.lon,n.lat]),s.lines2.push(L)}}var S=new THREE.LineGeometry;S.setPositions(x);S=new THREE.Line2(S,B.dlineMaterial1);S.computeLineDistances(),o.addAtCoordinate(S,[n.lon,n.lat]),s.lines.push(S)}for(var I=ZenMap.Utils.MapUtil.createCircleSector(h,t,15,90,0,!1),C=[],T=[],k=[],i=new THREE.BufferGeometry,d=0;d<I.length-1;d++){y=ZenMap.T.helper.inverseMercator(I[d].lon,I[d].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]);C.push(l.x-l.x,l.y-l.y,0),T.push(a[0]/256,a[1]/256,a[2]/256),k.push(0),C.push(_.x-l.x,_.y-l.y,0),T.push(a[0]/256,a[1]/256,a[2]/256),k.push(.9/I.length*d),y=ZenMap.T.helper.inverseMercator(I[d+1].lon,I[d+1].lat),_=o.utils.projectToWorld([y.lon,y.lat,0]),C.push(_.x-l.x,_.y-l.y,0),T.push(a[0]/256,a[1]/256,a[2]/256),k.push(.9/I.length*(d+1))}e=new Float32Array(C.length);e.set(C),i.setAttribute("position",new THREE.BufferAttribute(e,3));e=new Float32Array(T.length);e.set(T),i.setAttribute("customColor",new THREE.BufferAttribute(e,3));e=new Float32Array(k.length);e.set(k),i.setAttribute("cusmtomOpacity",new THREE.BufferAttribute(e,1));i=new THREE.Mesh(i,B.rmaterial);return o.addAtCoordinate(i,[n.lon,n.lat]),s.rMesh=i,s}(e,t,this._map,this.tb,this._angleColor,this._lineColor),this.scale=0,clearTimeout(this.timer),this._update()},e.prototype.remove=function(){if(clearTimeout(this.timer),this.obj){this.tb.remove(this.obj.outLine),this.obj.outLine.geometry=null,this.obj.outLine=null,this.tb.remove(this.obj.sline),this.obj.sline.geometry=null,this.obj.sline=null,this.tb.remove(this.obj.dline),this.obj.dline.geometry=null,this.obj.dline=null;for(var e=0;e<this.obj.lines.length;e++)this.tb.remove(this.obj.lines[e]),this.obj.lines[e].geometry=null,this.obj.lines[e]=null;for(e=this.obj.lines.length=0;e<this.obj.lines2.length;e++)this.tb.remove(this.obj.lines2[e]),this.obj.lines2[e].geometry=null,this.obj.lines2[e]=null;this.obj.lines2.length=0,this.tb.remove(this.obj.rMesh),this.obj.rMesh.geometry=null,this.obj.rMesh=null,this.obj.circle&&(this.tb.remove(this.obj.circle),this.obj.circle.geometry=null,this.obj.circle=null),this.obj=null}},e.prototype._update=function(){if(this.scale=this.scale+.04,this.scale<1.04)this.obj.circle.scale.set(this.scale,this.scale,1),this.rmaterial.visible=!1,this.dlineMaterial.visible=!1,this.dlineMaterial1.visible=!1,this.matLineBasic.visible=!1,this.lineMaterial.visible=!1,this.materialCuXu.visible=!1;else{this.obj.circle&&(this.tb.remove(this.obj.circle),this.obj.circle.geometry=null,this.obj.circle=null),this.rmaterial.visible=!0,this.dlineMaterial.visible=!0,this.dlineMaterial1.visible=!0,this.matLineBasic.visible=!0,this.lineMaterial.visible=!0,this.materialCuXu.visible=!0,this.obj.rMesh.rotateZ(5/180*Math.PI),this.obj.dline.rotateZ(-.5/180*Math.PI);for(var e=0;e<this.obj.lines2.length;e++)this.obj.lines2[e].rotateZ(.5/180*Math.PI)}this._map.getZoom()>=this._minZoom&&(this._map._obj.repaint=!0),this.timer=setTimeout(this._update.bind(this),30)},e.prototype.destory=function(){this.remove(),this.rmaterial=null,this.dlineMaterial=null,this.dlineMaterial1=null,this.matLineBasic=null,this.lineMaterial=null,this.materialCuXu=null,this.circleMaterial=null}}(),function(){function l(e,t,i){this._map=e,this._tb=t,this.lineMarkerMaterial=new THREE.LineMaterial({color:i.color||"red",linewidth:i.weight?i.weight/1e3:.002,opacity:i.opacity||1,transparent:!0}),this.id=i.id,this.isBloom=null!=i.isBloom&&i.isBloom;for(var t=new THREE.LineGeometry,o=i.position,i=o[0],i=ZenMap.T.setPoint(e,i),r=[],a=this._tb.utils.projectToWorld([i.lon,i.lat,0]),s=0;s<o.length;s++){var n=o[s],n=ZenMap.T.setPoint(e,n),n=this._tb.utils.projectToWorld([n.lon,n.lat,0]),n=[n.x-a.x,n.y-a.y,0];r.push(n[0],n[1],0)}t.setPositions(r),this.vertices=r,this.position=i,this.line=new THREE.Line2(t,this.lineMarkerMaterial),this.line.name="threeOverLayPolyline-"+this.id,this.line.renderOrder=300}function h(e,t,i){this._map=e,this._tb=t;var o=new THREE.MeshBasicMaterial({color:i.fillColor||"white",transparent:!!i.fillOpacity,opacity:i.fillOpacity||1}),r=new THREE.LineMaterial({linewidth:5e-4*i.weight,color:i.color||"black",transparent:!!i.opacity,opacity:i.opacity||1});this.id=i.id,this.outLineMesh=[],this.isBloom=null!=i.isBloom&&i.isBloom;var a=i.position,s=!1;(t=a[0])instanceof Array&&(t=a[0][0],s=!0);var t=ZenMap.T.setPoint(e,t),n=this._tb.utils.projectToWorld([t.lon,t.lat,0]);s||(a=[a]);for(var l=new THREE.Shape,h=0;h<a.length;h++){for(var p=[],c=0;c<a[h].length;c++){var u=a[h][c],u=ZenMap.T.setPoint(e,u),u=this._tb.utils.projectToWorld([u.lon,u.lat,0]),u=[u.x-n.x,u.y-n.y,0];p.push([u[0],u[1],0])}var m,d=[];if(0==h)for(c=0;c<p.length;c++)0==c?l.moveTo(p[c][0],p[c][1]):l.lineTo(p[c][0],p[c][1]),d.push(p[c][0],p[c][1],0);else{for(var y=new THREE.Path,c=0;c<p.length;c++)0==c?y.moveTo(p[c][0],p[c][1]):y.lineTo(p[c][0],p[c][1]),d.push(p[c][0],p[c][1],0);l.holes.push(y)}0<i.weight&&((m=new THREE.LineGeometry).setPositions(d),(m=new THREE.Line2(m,r)).name="threeOverLayPolygonOutLine-"+this.id,m.renderOrder=300,this.outLineMesh.push(m))}this.position=t,t=new THREE.ShapeBufferGeometry(l),this.mesh=new THREE.Mesh(t,o),this.mesh.renderOrder=300,this.mesh.name="threeOverLayPolygon-"+this.id}var e=MapPlatForm.Base.MapThreeOverLayer=function(e,t,i){this._map=e,this._tb=t,this._minZoom=i&&i.minZoom?i.minZoom:11,this._maxZoom=i&&i.maxZoom?i.maxZoom:22,this.visible=!i||null==i.visible||i.visible,this.projectChange=!i||null==i.projectChange||i.projectChange,this._events=new ZenMap.Events(this,["click","mousemove","mouseover","mouseout"]),this.PolylineOverLays=[],this.PolygonOverLays=[]};e.prototype.addOverLays=function(e){for(var t=0;t<e.length;t++)if("ZenMap.Geometry.Polyline"===e[t].CLASS_NAME){var i=e[t],o=i.getPath(),r={id:i.getId(),position:o,color:i.getColor(),weight:i.getWeight(),opacity:i.getOpacity(),isBloom:i.isBloom};(i=new l(this._map,this._tb,r)).isBloom?i.line.layers.set(1):i.line.layers.set(0),this._tb.addAtCoordinate(i.line,[i.position.lon,i.position.lat]),this.PolylineOverLays.push(i)}else if("ZenMap.Geometry.Polygon"===e[t].CLASS_NAME){var a=e[t],o=a.getPath(),r={id:a.getId(),position:o,color:a.getColor(),fillColor:a.getFillColor(),isBloom:a.isBloom,opacity:a.getOpacity(),fillOpacity:a.getFillOpacity(),weight:a.getWeight()};if("MultiPolygon"===a.polygonType)for(var s=0;s<o.length;s++){if(r.position=o[s],(a=new h(this._map,this._tb,r)).isBloom){a.mesh.layers.set(1);for(var n=0;n<a.outLineMesh.length;n++)a.outLineMesh[n].layers.set(1)}else{a.mesh.layers.set(0);for(n=0;n<a.outLineMesh.length;n++)a.outLineMesh[n].layers.set(0)}this._tb.addAtCoordinate(a.mesh,[a.position.lon,a.position.lat,1]);for(n=0;n<a.outLineMesh.length;n++)this._tb.addAtCoordinate(a.outLineMesh[n],[a.position.lon,a.position.lat,1]);this.PolygonOverLays.push(a)}else{if((a=new h(this._map,this._tb,r)).isBloom){a.mesh.layers.set(1);for(n=0;n<a.outLineMesh.length;n++)a.outLineMesh[n].layers.set(1)}else{a.mesh.layers.set(0);for(n=0;n<a.outLineMesh.length;n++)a.outLineMesh[n].layers.set(0)}this._tb.addAtCoordinate(a.mesh,[a.position.lon,a.position.lat,1]);for(n=0;n<a.outLineMesh.length;n++)this._tb.addAtCoordinate(a.outLineMesh[n],[a.position.lon,a.position.lat,1]);this.PolygonOverLays.push(a)}}},e.prototype.showOverLays=function(e){if(this.PolylineOverLays)for(var t=0;t<this.PolylineOverLays.length;t++)(i=this._tb.world.getObjectByName("threeOverLayPolyline-"+this.PolylineOverLays[t].id))&&(i.material.visible=null==e||e);if(this.PolygonOverLays)for(t=0;t<this.PolygonOverLays.length;t++){var i=this._tb.world.getObjectByName("threeOverLayPolygon-"+this.PolygonOverLays[t].id),o=this._tb.world.getObjectByName("threeOverLayPolygonOutLine-"+this.PolygonOverLays[t].id);i&&(i.material.visible=null==e||e),o&&(o.material.visible=null==e||e)}},e.prototype.addEventListener=function(e,t,i){this._events.register(e,t,i)},e.prototype.removeEventListener=function(e,t){this._events.unregister(e,t)},e.prototype.removeAllOverlays=function(){if(this.PolylineOverLays){for(var e=0;e<this.PolylineOverLays.length;e++)(t=this._tb.world.getObjectByName("threeOverLayPolyline-"+this.PolylineOverLays[e].id))&&this._tb.remove(t);this.PolylineOverLays[e]=null,this.PolylineOverLays.length=0}if(this.PolygonOverLays){for(var t,e=0;e<this.PolygonOverLays.length;e++)for((t=this._tb.world.getObjectByName("threeOverLayPolygon-"+this.PolygonOverLays[e].id))&&this._tb.remove(t);;){var i=this._tb.world.getObjectByName("threeOverLayPolygonOutLine-"+this.PolygonOverLays[e].id);if(!i)break;this._tb.remove(i)}this.PolygonOverLays[e]=null,this.PolygonOverLays.length=0}},e.prototype.destory=function(){this.removeAllOverlays(),this._events=null},e.prototype.removeOverlays=function(e){for(var t=0;t<e;t++){if(i=this._tb.world.getObjectByName("threeOverLayPolyline-"+e[t].id))return this._tb.remove(i),void this.PolylineOverLays.splice(t,1);var i=this._tb.world.getObjectByName("threeOverLayPolygon-"+this.PolygonOverLays[t].id),o=this._tb.world.getObjectByName("threeOverLayPolygonOutLine-"+this.PolygonOverLays[t].id);o&&this._tb.remove(o),i&&(this._tb.remove(i),this.PolygonOverLays.splice(t,1))}}}(),function(){var e=MapPlatForm.Base.MapBloomManager=function(e,t,i){this._map=e,this._tb=t,this.exposure=i&&i.exposure?parseFloat(i.exposure):1,this.bloomStrength=i&&i.bloomStrength?parseFloat(i.bloomStrength):1,this.bloomThreshold=i&&i.bloomThreshold?parseFloat(i.bloomThreshold):0,this.bloomRadius=i&&i.bloomRadius?parseFloat(i.bloomRadius):0};e.prototype.add=function(){var e,t,i={exposure:this.exposure,bloomStrength:this.bloomStrength,bloomThreshold:this.bloomThreshold,bloomRadius:this.bloomRadius},o=this;THREE.RenderPass&&(e=new THREE.RenderPass(o._tb.scene,o._tb.camera),(t=new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,.4,.85)).threshold=i.bloomThreshold,t.strength=i.bloomStrength,t.radius=i.bloomRadius,o.bloomPass=t,o._tb.bloomComposer=new THREE.EffectComposer(o._tb.renderer),o._tb.bloomComposer.addPass(e),o._tb.bloomComposer.addPass(t),o._tb.renderer.toneMappingExposure=Math.pow(i.exposure,4))},e.prototype.remove=function(){this._tb.bloomComposer.passes.length=0,this._tb.bloomComposer.renderToScreen=!1,this._tb.bloomComposer=null},e.prototype.changeBloomPassParams=function(e){this.bloomPass&&(e&&void 0!==e.bloomThreshold&&(this.bloomPass.threshold=e.bloomThreshold),e&&void 0!==e.bloomStrength&&(this.bloomPass.strength=e.bloomStrength),e&&void 0!==e.bloomRadius&&(this.bloomPass.radius=e.bloomRadius))},e.prototype.destory=function(){this._tb.bloomComposer.passes.length=0,this._tb.bloomComposer.renderToScreen=!1,this._tb.bloomComposer=null}}(),function(){var e=MapPlatForm.Base.MapSkyBox=function(e){function u(){var e=u.SkyShader,e=new THREE.ShaderMaterial({fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:THREE.UniformsUtils.clone(e.uniforms),side:THREE.BackSide});THREE.Mesh.call(this,new THREE.BoxBufferGeometry(1,1,1),e)}u.prototype=Object.create(THREE.Mesh.prototype),u.SkyShader={uniforms:{luminance:{value:1},turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new THREE.Vector3},up:{value:new THREE.Vector3(0,1,0)}},vertexShader:["uniform vec3 sunPosition;","uniform float rayleigh;","uniform float turbidity;","uniform float mieCoefficient;","uniform vec3 up;","varying vec3 vWorldPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float v = 4.0;","const vec3 K = vec3( 0.686, 0.678, 0.666 );","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","const float cutoffAngle = 1.6110731556870734;","const float steepness = 1.5;","const float EE = 1000.0;","float sunIntensity( float zenithAngleCos ) {","\tzenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );","\treturn EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );","}","vec3 totalMie( float T ) {","\tfloat c = ( 0.2 * T ) * 10E-18;","\treturn 0.434 * c * MieConst;","}","void main() {","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tvWorldPosition = worldPosition.xyz;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","\tgl_Position.z = gl_Position.w;","\tvSunDirection = normalize( sunPosition );","\tvSunE = sunIntensity( dot( vSunDirection, up ) );","\tvSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );","\tfloat rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );","\tvBetaR = totalRayleigh * rayleighCoefficient;","\tvBetaM = totalMie( turbidity ) * mieCoefficient;","}"].join("\n"),fragmentShader:["varying vec3 vWorldPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","uniform float luminance;","uniform float mieDirectionalG;","uniform vec3 up;","const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );","const float pi = 3.141592653589793238462643383279502884197169;","const float n = 1.0003;","const float N = 2.545E25;","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","const float THREE_OVER_SIXTEENPI = 0.05968310365946075;","const float ONE_OVER_FOURPI = 0.07957747154594767;","float rayleighPhase( float cosTheta ) {","\treturn THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );","}","float hgPhase( float cosTheta, float g ) {","\tfloat g2 = pow( g, 2.0 );","\tfloat inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );","\treturn ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );","}","const float A = 0.15;","const float B = 0.50;","const float C = 0.10;","const float D = 0.20;","const float E = 0.02;","const float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap( vec3 x ) {","\treturn ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","}","void main() {","\tfloat zenithAngle = acos( max( 0.0, dot( up, normalize( vWorldPosition - cameraPos ) ) ) );","\tfloat inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );","\tfloat sR = rayleighZenithLength * inverse;","\tfloat sM = mieZenithLength * inverse;","\tvec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );","\tfloat cosTheta = dot( normalize( vWorldPosition - cameraPos ), vSunDirection );","\tfloat rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );","\tvec3 betaRTheta = vBetaR * rPhase;","\tfloat mPhase = hgPhase( cosTheta, mieDirectionalG );","\tvec3 betaMTheta = vBetaM * mPhase;","\tvec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );","\tLin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );","\tvec3 direction = normalize( vWorldPosition - cameraPos );","\tfloat theta = acos( direction.y ); // elevation --\x3e y-axis, [-pi/2, pi/2]","\tfloat phi = atan( direction.z, direction.x ); // azimuth --\x3e x-axis [-pi/2, pi/2]","\tvec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );","\tvec3 L0 = vec3( 0.1 ) * Fex;","\tfloat sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );","\tL0 += ( vSunE * 19000.0 * Fex ) * sundisk;","\tvec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );","\tvec3 curr = Uncharted2Tonemap( ( log2( 2.0 / pow( luminance, 4.0 ) ) ) * texColor );","\tvec3 color = curr * whiteScale;","\tvec3 retColor = pow( color, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );","\tgl_FragColor = vec4( retColor, 1.0 );","}"].join("\n")},this._map=e;var m=this;this.id=ZenMap.Utils.BaseUtils.uuid(),this._skyBoxLayer={id:this.id,type:"custom",renderingMode:"3d",onAdd:function(e,t){this.camera=new THREE.PerspectiveCamera,this.scene=new THREE.Scene,this.map=e;var i=new u;i.scale.setScalar(45e4),this.scene.add(i),sunSphere=new THREE.Mesh(new THREE.SphereBufferGeometry(2e4,16,8),new THREE.MeshBasicMaterial({color:16777215})),sunSphere.position.y=-7e5,sunSphere.visible=!1,this.scene.add(sunSphere);var o=10,r=2,a=.005,s=.8,n=1,l=.49,h=.25,p=!1,c=i.material.uniforms;c.turbidity.value=o,c.rayleigh.value=r,c.mieCoefficient.value=a,c.mieDirectionalG.value=s,c.luminance.value=n;l=Math.PI*(l-.5),h=2*Math.PI*(h-.5);sunSphere.position.x=4e5*Math.cos(h),sunSphere.position.y=4e5*Math.sin(h)*Math.sin(l),sunSphere.position.z=4e5*Math.sin(h)*Math.cos(l),sunSphere.visible=p,c.sunPosition.value.copy(sunSphere.position),this.renderer=new THREE.WebGLRenderer({antialias:!0,canvas:e.getCanvas(),context:t}),this.renderer.autoClear=!1,m.skyMaterial=i.material,m.sunSphere=sunSphere},render:function(e,t){var i=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(1,0,0),Math.PI/2),o=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,1,0),Math.PI/2),r=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,0,1),0),a=(new THREE.Matrix4).fromArray(t),r=(new THREE.Matrix4).makeTranslation(0,0,0).scale(new THREE.Vector3(1,-1,1)).multiply(i).multiply(o).multiply(r);this.camera.projectionMatrix.elements=t,this.camera.projectionMatrix=a.multiply(r),this.renderer.state.reset(),this.renderer.render(this.scene,this.camera),this.map.triggerRepaint()}}};e.prototype.add=function(){this._map._obj.getLayer("background")?this._map._obj.addLayer(this._skyBoxLayer,"background"):this._map._obj.addLayer(this._skyBoxLayer)},e.prototype.updateSunEffect=function(e){var t={turbidity:10,rayleigh:2,mieCoefficient:.005,mieDirectionalG:.8,luminance:1,inclination:.5,azimuth:.25,sun:!1};for(k in e)t[k]=e[k];var i=this.skyMaterial.uniforms;i.turbidity.value=t.turbidity,i.rayleigh.value=t.rayleigh,i.mieCoefficient.value=t.mieCoefficient,i.mieDirectionalG.value=t.mieDirectionalG,i.luminance.value=t.luminance;var o=Math.PI*(t.inclination-.5),r=2*Math.PI*(t.azimuth-.5);this.sunSphere.position.x=4e5*Math.cos(r)*Math.cos(o),this.sunSphere.position.y=4e5*Math.sin(r)*Math.sin(o),this.sunSphere.position.z=4e5*Math.sin(r)*Math.cos(o),this.sunSphere.visible=t.sun,i.sunPosition.value.copy(this.sunSphere.position)},e.prototype.destory=function(){this._map._obj.removeLayer(this._skyBoxLayer.id)}}(),MapPlatForm.Base.Map3DRoomControl=function(e,t,i){this.CLASS_NAME="Map3DRoomControl",this._activeModel=null,this._threeLayer=e,this._roomData=t,this._roomType=1,this._opts=i||{},this._opts.floorNameStyle=this._opts.floorNameStyle||{},this._moveAction=!0},MapPlatForm.Base.Map3DRoomControl.prototype.init=function(n){var l=this,h=this._threeLayer._map;this.callBacak=n,this._threeLayer.addSelectEvent(function(e,t){if(l._moveAction){if(3==l._roomType)return e&&"appliances"===e.type?l._threeLayer.setSelection(e):l._threeLayer.setSelection(null),void l._threeLayer._map.repaint();var i,o;2==l._roomType&&e&&"room"==e.type?(l._floorDom||(l._floorDom=function(){var e=document.createElement("div");e.style.width=l._opts.floorNameStyle.width||"72px",e.style.height=l._opts.floorNameStyle.height||"32px",e.style.position=l._opts.floorNameStyle.position||"absolute",e.style.background=l._opts.floorNameStyle.background||"url("+ZenMap.Utils.BaseUtils.getHostPath()+"/ZenView/floor.png) no-repeat";var t=document.createElement("span");return t.innerText="",t.style.fontSize=l._opts.floorNameStyle.fontSize||"18px",t.style.color=l._opts.floorNameStyle.color||"beige",t.style.paddingLeft=l._opts.floorNameStyle.paddingLeft||"25px",t.style.lineHeight=l._opts.floorNameStyle.lineHeight||"32px",e.append(t),h._mapContainer.append(e),t}()),i=l._opts.floorNameStyle.offsetX||10,o=l._opts.floorNameStyle.height||"32px",o=parseInt(o.replace("px","")),l._floorDom.parentElement.style.display="block",l._floorDom.parentElement.style.left=t.x+i+"px",l._floorDom.parentElement.style.top=t.y-o/2+"px",l._floorDom.innerText=e.floorName):l._floorDom&&(l._floorDom.parentElement.style.display="none"),l._threeLayer.setSelection(e),l._threeLayer._map.repaint()}},"mousemove"),h.addEventListener("dblclick",function(){if(l._threeLayer.selection)if(1==l._roomType){l._threeLayer.selection.userData.units="scene";var e=l._threeLayer.selection.modelID;if(l._roomData[e]&&0<l._roomData[e].rooms.length){l._roomType=2,l._activeModel=l._threeLayer.selection,l._threeLayer.selection.visible=!1,l._threeLayer.setAllModelVisible(!0),l._threeLayer.clearSelection();for(var t=0,i=Object.keys(l._roomData);t<i.length;t++)if(i[t]==e)for(var o=0;o<l._roomData[e].rooms.length;o++)l._roomData[e].rooms[o].visible=!0;else for(o=0;o<l._roomData[i[t]].rooms.length;o++)l._roomData[i[t]].rooms[o].visible=!1;n&&n instanceof Function&&n(l._roomType,e)}h.getZoom()<18&&(l._roomData[e]?(a=l._roomData[e].position,r=ZenMap.T.getPoint(h,a),h.setCenter(r,18)):(s=l._threeLayer.getCenterTop(l._threeLayer.selection),h.setCenter(s,18)))}else if(2==l._roomType)if("room"===l._threeLayer.selection.type){l._roomType=3;var r=l._threeLayer.selection;l._threeLayer.setAllModelVisible(!1),l._threeLayer.selection.userData.units="scene";var e=l._activeModel.modelID,a=l._roomData[e].position;l._threeLayer.tb.moveToCoordinate(l._threeLayer.selection,[a.lon,a.lat,0]),l._threeLayer._map.repaint();var s=l._threeLayer.getCenterTop(l._threeLayer.selection);l._threeLayer.setSelection(null),n&&n instanceof Function&&n(l._roomType,e,r),h.getZoom()<21&&h.setCenter(s,21)}else{l._threeLayer.selection.userData.units="scene";e=l._threeLayer.selection.modelID;if(l._roomData[e]&&0<l._roomData[e].rooms.length){l._activeModel=l._threeLayer.selection,l._threeLayer.selection.visible=!1,l._threeLayer.clearSelection(),l._threeLayer.setAllModelVisible(!0);for(t=0,i=Object.keys(l._roomData);t<i.length;t++)if(i[t]==e)for(o=0;o<l._roomData[e].rooms.length;o++)l._roomData[e].rooms[o].visible=!0;else for(o=0;o<l._roomData[i[t]].rooms.length;o++)l._roomData[i[t]].rooms[o].visible=!1;n&&n instanceof Function&&n(l._roomType,e)}h.getZoom()<18&&(s=l._threeLayer.getCenterTop(l._threeLayer.selection),h.setCenter(s,18))}}),h._obj.on("mousedown",function(){l._canRightclick=!0}),h._obj.on("move",function(){l._moveAction&&(l._canRightclick=!1,l._floorDom&&(l._floorDom.parentElement.style.display="none"))}),h.addEventListener("rightclick",function(){if(l._canRightclick)if(3==l._roomType){l._roomType=2,l._threeLayer.setAllModelVisible(!0),l._activeModel&&(l._activeModel.visible=!1);for(var e=0,t=Object.keys(l._roomData);e<t.length;e++){var i=l._roomData[t[e]].position;if(l._activeModel&&t[e]==l._activeModel.modelID)for(var o=0;o<l._roomData[t[e]].rooms.length;o++)l._roomData[t[e]].rooms[o].visible=!0,l._roomData[t[e]].rooms[o].userData.units="scene",l._threeLayer.tb.moveToCoordinate(l._roomData[t[e]].rooms[o],[i.lon,i.lat,l._roomData[t[e]].rooms[o].h])}18<h.getZoom()&&(i=l._roomData[l._activeModel.modelID].position,r=ZenMap.T.getPoint(h,i),h.setCenter(r,18)),n&&n instanceof Function&&n(l._roomType,l._activeModel.modelID)}else if(2==l._roomType){l._roomType=1;for(var r,e=0,t=Object.keys(l._roomData);e<t.length;e++)for(o=0;o<l._roomData[t[e]].rooms.length;o++)l._roomData[t[e]].rooms[o].visible=!1;l._activeModel&&(l._activeModel.visible=!0),17<h.getZoom()&&(i=l._roomData[l._activeModel.modelID].position,r=ZenMap.T.getPoint(h,i),h.setCenter(r,17)),n&&n instanceof Function&&n(l._roomType,l._activeModel.modelID)}})},MapPlatForm.Base.Map3DRoomControl.prototype.showFloor=function(e,t){if(this._roomData[e]&&2==this._roomType){this._threeLayer.setAllModelVisible(!1);for(var i=this._threeLayer._map,o=0;o<this._roomData[e].rooms.length;o++)if(this._roomData[e].rooms[o].floorNum===t){this._activeModel=this._threeLayer.getObjByModelID(e),this._roomType=3;var r=this._roomData[e].position;this._roomData[e].rooms[o].userData.units="scene",this._threeLayer.tb.moveToCoordinate(this._roomData[e].rooms[o],[r.lon,r.lat,0]),this._roomData[e].rooms[o].visible=!0;r=this._threeLayer.getCenterTop(this._roomData[e].rooms[o]);i.getZoom()<21&&i.setCenter(r,21),this.callBacak&&this.callBacak instanceof Function&&this.callBacak("roomin",e,this._roomData[e].rooms[o]);break}}},MapPlatForm.Base.Map3DRoomControl.prototype.disableMoveAction=function(){this._moveAction=!1},MapPlatForm.Base.Map3DRoomControl.prototype.enableMoveAction=function(){this._moveAction=!0},function(){var e=MapPlatForm.Base.AnimationLine=function(e,t,i){this.CLASS_NAME=" MapPlatForm.Base.AnimationLine",this.points,this.op_line,this.op_feature,this._layer,this._map=e,this.drawIndex=0,this.drawSpeed,this.isWait=!1,this.isAddPoint=!1,this.segArray,this.segIndex=0,this.panWay=-1,this.status,this.zoomStop=!1,this.interval=40,this.newStart=!0,this.events=new ZenMap.Events(this,["preDraw","afterDraw","afterStep"]),this.headerMarker=null,this.isHeaderRotate=!0,this.timer=null,this.isTrace=!1,this.isViewInMap=!1,this.isRotateMap=!1,this.addPoints=[],this.lineStyle={color:"green"},i&&(i.color&&(this.lineStyle.color=i.color),i.opacity&&(this.lineStyle.opacity=i.opacity),i.weight&&(this.lineStyle.weight=i.weight),i.isViewInMap&&(this.isViewInMap=i.isViewInMap)),this.id=-1,this._points=new Array,this._listeners={},this.layerName="动画线",this.points=t,this.points instanceof Array||(this.points=[]),this.drawSpeed=60/3.6*this.interval/1e3,this.status=0,i&&(this.headerMarker=new zmapboxgl.Marker(i.headerMarker.element,{anchor:"bottom",color:i.headerMarker.color}),this._layer=i.layer,this.isHeaderRotate=!1!==i.isHeaderRotate,this._refreshLine=!1!==i.refreshLine,i.renderFirst,this._refreshLine),this._layer||(this._layer=new ZenMap.Layers.ThreeLayer(this.layerName,!1),this._map.addLayer(this._layer),this._layer.useFog(!1)),this._init(),this.headerMarker&&(this.headerMarker.setLngLat([this.position.lon,this.position.lat]),this.headerMarker.addTo(this._map._obj))};e.prototype._initInteractive=function(){var e=this;this._map._events.through=!0,this._map._events.register("zoomstart",this,function(){0<e.status&&(e.stop(),e.zoomStop=!0)}),this._map._events.register("movestart",this,function(){0<e.status&&(e.stop(),e.zoomStop=!0)}),this._map._events.register("moveend",this,function(){e.zoomStop&&(e.start(),e.zoomStop=!1)})},e.prototype.restart=function(){this.geoLine&&this._layer&&this._layer.tb.remove(this.geoLine),this.stop(),this._init(),this.start()},e.prototype.start=function(){var e;ZenMap.isAnimat=!0,0<this.status||(this._triggerEvent(ZenMap.ANIMATION_EVENT_START),this.status=1,0<=this.panWay&&this._suitView(this.points),this.newStart&&0==this.drawIndex&&0<this.points.length&&(this.headerMarker&&(this._rotateHeaderMarker(!0),e=ZenMap.T.setPoint(this._map,this.points[this.drawIndex]),this.headerMarker.setLngLat([e.lon,e.lat])),this.events.triggerEvt("afterDraw",{point:this.points[this.drawIndex],index:this.drawIndex})),this.timer=window.requestAnimationFrame(this._startDraw.bind(this)))},e.prototype.pause=function(){ZenMap.isAnimat=!1,this.status=-1},e.prototype.stop=function(){ZenMap.isAnimat=!1,-1==this.status&&this._triggerEvent(ZenMap.ANIMATION_EVENT_STOP),this.status=0,window.clearTimeout(this.timer)},e.prototype.setSpeed=function(e){var t;e<0||(0==e?(this.isWait=!0,this.isAddPoint=!1,this.drawSpeed=0):(this.isWait=!1,this._rotateHeaderMarker(),this.drawSpeed=e/3.6*this.interval/1e3,(0<this.status||this.status<0)&&this.segArray.length>this.segIndex&&(t=this.status,this.pause(),window.clearTimeout(this.timer),e=this.segArray[this.segIndex],this.points.splice(this.drawIndex+1,0,e),this.drawIndex=this.drawIndex+1,this.segArray=this._calculateSeg(this.drawIndex),this.segIndex=this.segArray.length-1,this.status=t,this._startDraw())))},e.prototype.appendPoints=function(e){e instanceof Array&&!(e.length<=0)&&(this.points=this.points.concat(e),this._init(),0<=this.panWay&&this._suitView(e))},e.prototype.setStyle=function(e){},e.prototype._overwriteObj=function(e,t){if(!e||!t)return e;for(var i in t)i in e&&(e[i]=t[i]);return e},e.prototype._startDraw=function(){var e;if(0!=this.status)if(-1!=this.status)if(this._preDraw()){if(this.isWait)return this.isAddPoint||(this.headerMarker&&(e=ZenMap.T.setPoint(this._map,this.points[this.drawIndex]),this.headerMarker.setLngLat([e.lon,e.lat])),this.isAddPoint=!0,this.events.triggerEvt("afterDraw",{point:this.points[this.drawIndex],index:this.drawIndex})),void(this.timer=window.requestAnimationFrame(this._startDraw.bind(this)));this._addPoint(),this._afterDraw()}else this.status=0;else this._triggerEvent(ZenMap.ANIMATION_EVENT_PAUSE);else this._triggerEvent(ZenMap.ANIMATION_EVENT_STOP)},e.prototype.continus=function(){this.isAddPoint=!1,this.drawIndex++,this.start()},e.prototype.trace=function(e){this.isTrace=!0,this.isRotateMap=e},e.prototype.stopTrace=function(){this.isTrace=!1},e.prototype._preDraw=function(){0==this.drawIndex&&(this.segArray=this._calculateSeg(this.drawIndex));var e=0==this.drawIndex&&0==this.segIndex,t=this.segArray.length;return this.segIndex=this.segIndex+1,e&&this.events.triggerEvt("preDraw",{point:this.points[this.drawIndex],index:this.drawIndex}),(e||this.segIndex>=t-1)&&this._rotateHeaderMarker(),!(this.drawIndex>=this.points.length-1)&&(this.segIndex>=t&&(this.segIndex=0,this.segArray=this._calculateSeg(this.drawIndex)),this.panWay<=0||!this._inView(this.segArray[this.segIndex])&&0<this.panWay&&this._setCenter(this.segArray[this.segIndex]),!0)},e.prototype._addPoint=function(){var e,t,i,o=this.segArray[this.segIndex],r=this.addPoints;0==this.segIndex?(e=this.points[this.drawIndex],t=ZenMap.T.setPoint(this._map,e),i=this._layer.tb.utils.projectToWorld([t.lon,t.lat,0]),this.positions.push(i.x-this.vb.x),this.positions.push(i.y-this.vb.y),this.positions.push(i.z-this.vb.z),r.push(e)):r.length-1==this.drawIndex?(t=ZenMap.T.setPoint(this._map,o),i=this._layer.tb.utils.projectToWorld([t.lon,t.lat,0]),this.positions.push(i.x-this.vb.x),this.positions.push(i.y-this.vb.y),this.positions.push(i.z-this.vb.z),r.push(o)):(t=ZenMap.T.setPoint(this._map,o),i=this._layer.tb.utils.projectToWorld([t.lon,t.lat,0]),this.positions[this.positions.length-3]=i.x-this.vb.x,this.positions[this.positions.length-2]=i.y-this.vb.y,this.positions[this.positions.length-1]=i.z-this.vb.z,r[r.length-1]=o),this.isTrace?this._setCenter(r[r.length-1]):this.isViewInMap&&(this._inView(o)||this._setCenter(o)),this._moveHeaderMarker(),this._refreshLine&&(this.addPoints=r),this.unRedraw||this._redraw()},e.prototype._afterDraw=function(){0==this.drawIndex&&(1==this.segIndex||this.segIndex);var e=this.segIndex>=this.segArray.length-1;e&&(this.drawIndex++,this.events.triggerEvt("preDraw",{point:this.points[this.drawIndex],index:this.drawIndex})),0<this.drawIndex&&e&&(this.headerMarker&&(t=ZenMap.T.setPoint(this._map,this.points[this.drawIndex]),this.headerMarker.setLngLat([t.lon,t.lat])),this.events.triggerEvt("afterDraw",{point:this.points[this.drawIndex],index:this.drawIndex}));var t=this.segIndex;this.segIndex>this.segArray.length-2&&(t=0),this.events.triggerEvt("afterStep",{stepIndex:t,pointIndex:this.drawIndex,point:this.segArray[this.segIndex]}),this.segIndex>this.segArray.length-2&&this.drawIndex>this.points.length-2&&(this.status=0,ZenMap.isAnimat=!1),this.timer=window.requestAnimationFrame(this._startDraw.bind(this))},e.prototype.nextPosition=function(){var e;this.newStart=!1,0<this.drawIndex&&this.drawIndex--,this.headerMarker&&(e=ZenMap.T.setPoint(this._map,this.points[this.drawIndex]),this.headerMarker.setLngLat([e.lon,e.lat])),this._rotateHeaderMarker(),this.segIndex=0,this.segArray=this._calculateSeg(this.drawIndex),this._setLine(this.drawIndex),this.events.triggerEvt("afterStep",{stepIndex:0,pointIndex:this.drawIndex,point:this.segArray[this.segIndex]})},e.prototype.afterPosition=function(){var e;this.drawIndex<this.points.length-1&&(this.drawIndex++,this.headerMarker&&(e=ZenMap.T.setPoint(this._map,this.points[this.drawIndex]),this.headerMarker.setLngLat([e.lon,e.lat])),this._rotateHeaderMarker(),this.segIndex=0,this.segArray=this._calculateSeg(this.drawIndex),this._setLine(this.drawIndex),this.events.triggerEvt("afterStep",{stepIndex:0,pointIndex:this.drawIndex,point:this.segArray[this.segIndex]}))},e.prototype.slicePoints=function(e){this.points=this.points.slice(0,e+1)},e.prototype._setLine=function(e,t){this.positions=[],this.addPoints=[];for(var i=0;i<e+1;i++){var o=ZenMap.T.setPoint(this._map,this.points[i]),r=this._layer.tb.utils.projectToWorld([o.lon,o.lat,0]);this.positions.push(r.x-this.vb.x),this.positions.push(r.y-this.vb.y),this.positions.push(r.z-this.vb.z),this.addPoints.push(this.points[i])}0<t&&(o=ZenMap.T.setPoint(this._map,this.segArray[t]),r=this._layer.tb.utils.projectToWorld([o.lon,o.lat,0]),this.positions.push(r.x-this.vb.x),this.positions.push(r.y-this.vb.y),this.positions.push(r.z-this.vb.z),this.addPoints.push(this.segArray[t])),this._redraw()},e.prototype.setLayer=function(e){this._layer=e},e.prototype._init=function(){var e,t;this.segArray=[],this.drawIndex=0,this.segIndex=0,this.addPoints=[],this.positions=[],this.points&&0<this.points.length&&(e=ZenMap.T.setPoint(this._map,this.points[0]),t=this._layer.tb.utils.projectToWorld([e.lon,e.lat,0]),this.position=e,this.vb=t,this.addPoints.push(this.points[0]),this.positions=[0,0,0]),this.geoBuffer=new THREE.LineGeometry,this.materials=new THREE.LineMaterial({color:new THREE.Color(this.lineStyle.color),linewidth:this.lineStyle.weight||6,opacity:1,transparent:!0}),this.materials.resolution.set(this._map._obj.getCanvas().width,this._map._obj.getCanvas().height),this.geoLine=new THREE.Line2(this.geoBuffer,this.materials),this.geoLine.renderOrder=300,this._layer.tb.addAtCoordinate(this.geoLine,[this.position.lon,this.position.lat])},e.prototype._redraw=function(){this.geoLine&&this.positions&&(this._layer.tb.remove(this.geoLine),this.geoBuffer.dispose(),this.geoBuffer=null,this.geoLine=null,this.geoBuffer=new THREE.LineGeometry,this.geoBuffer.setPositions(this.positions),this.geoLine=new THREE.Line2(this.geoBuffer,this.materials),this._layer.tb.addAtCoordinate(this.geoLine,[this.position.lon,this.position.lat]),this._map.repaint())},e.prototype._calculateSeg=function(e){var t=[];if(e+1>=this.points.length)return t.push(0),t;var i,o=this.points[e],r=this.points[e+1],a=this._getDistance(o,r),s=0;0<this.drawSpeed&&(s=Math.round(a/this.drawSpeed));for(var n=1;n<s;n++)i=n/s,x=parseFloat((r.lon-o.lon)*i)+parseFloat(o.lon),y=parseFloat((r.lat-o.lat)*i)+parseFloat(o.lat),i=new ZenMap.Geometry.Point(x,y),t.push(i);return t.push(this.points[e+1]),t},e.prototype._getDistance=function(e,t){e=ZenMap.T.helper.webMoctorJW2PM(e.lon,e.lat),t=ZenMap.T.helper.webMoctorJW2PM(t.lon,t.lat);return Math.sqrt((e.lon-t.lon)*(e.lon-t.lon)+(e.lat-t.lat)*(e.lat-t.lat))},e.prototype._inView=function(e){return this._map.getExtent().containsPoint(e)},e.prototype._setCenter=function(e){e=ZenMap.T.setPoint(this._map,e);this._map._obj.jumpTo({center:[e.lon,e.lat]})},e.prototype._pointToPixel=function(e){return this._map.pointToPixel(e)},e.prototype._pixelToPoint=function(e){return this._map.pixelToPoint(e)},e.prototype._setLayer=function(e){if(e&&e._useCluster)throw"can not use cluster layer";this._layer=e},e.prototype._suitView=function(e){1<e.length&&this._layer&&this._layer.map},e.prototype._rotateHeaderMarker=function(e){},e.prototype.setPosition=function(e,t){var i;-1<e&&e<this.points.length&&(this.drawIndex=e,e=this._calculateSeg(this.drawIndex),-1<t&&t<e.length?(this.segArray=e,this.segIndex=t):t<0?(this.segArray=e,this.segIndex=0):t>e.length-1&&(this.segArray=e,this.segIndex=e.length-2),1==e.length&&0==e[0]&&this.headerMarker&&(i=ZenMap.T.setPoint(this._map,this.points[this.drawIndex]),this.headerMarker.setLngLat([i.lon,i.lat])),this._rotateHeaderMarker(),0==this.segIndex?(i=ZenMap.T.setPoint(this._map,this.points[this.drawIndex]),this.headerMarker.setLngLat([i.lon,i.lat])):this._moveHeaderMarker(),this._setLine(this.drawIndex,this.segIndex))},e.prototype._calculateAngle=function(){if(this.drawIndex>=this.points.length-1)return-1;var e=this.points[this.drawIndex],t=this.points[this.drawIndex+1];if(e.lon==t.lon&&e.lat==t.lat)return-1;if(this._map.getDistance(e,t)<1)return-1;e=180*Math.atan2(t.lat-e.lat,t.lon-e.lon)/Math.PI;return e=0<e?360-e:0-e},e.prototype._moveHeaderMarker=function(){var e;!this.headerMarker||(e=this.segArray[this.segIndex]).lon&&e.lat&&(e=ZenMap.T.setPoint(this._map,e),this.headerMarker.setLngLat([e.lon,e.lat]))},e.prototype.getAllSegCount=function(){for(var e=0,t=0;t<this.points.length;t++)e+=this._calculateSeg(t).length;return e},e.prototype.addEventListener=function(e,t){switch(e){case ZenMap.ANIMATION_EVENT_START:this._listeners.start||(this._listeners.start=[]),this._listeners.start.push(t);break;case ZenMap.ANIMATION_EVENT_PAUSE:this._listeners.pause||(this._listeners.pause=[]),this._listeners.pause.push(t);break;case ZenMap.ANIMATION_EVENT_STOP:this._listeners.stop||(this._listeners.stop=[]),this._listeners.stop.push(t);break;case ZenMap.ANIMATION_EVENT_MOVING:this._listeners.moving||(this._listeners.moving=[]),this._listeners.moving.push(t);break;case ZenMap.ANIMATION_EVENT_MOVED:this._listeners.moved||(this._listeners.moved=[]),this._listeners.moved.push(t);break;case"preDraw":case"afterDraw":case"afterStep":this.events.register(e,t)}},e.prototype.removeEventListener=function(e,t){if("preDraw"!==e&&"afterDraw"!==e&&"afterStep"!==e){var i=this._listeners[e];if(i instanceof Array)for(var o=0;o<i.length;++o)if(i[o].toString()==t.toString()){i.pop(t);break}}else this.events.unregiste(e)},e.prototype._triggerEvent=function(e,t){var i=this._listeners[e];if(i instanceof Array)for(var o=0;o<i.length;++o)i[o].apply(this,t)},e.prototype.remove=function(){this.stop(),this.geoLine&&this._layer&&(this._layer.tb.remove(this.geoLine),this.geoBuffer.dispose(),this.geoBuffer=null,this.geoLine=null),this._layer&&"动画线"===this._layer.name&&this._map.removeLayer(this._layer),this.headerMarker&&this.headerMarker.remove()}}(),function(){var e=32;function t(e,t,i,o){this.xx=e,this.yy=t,this.radius=i,this.context=o}t.prototype.radiu=function(){e+=3,60<=this.radius&&(e=16)},t.prototype.paint=function(){this.context.beginPath(),this.context.arc(this.xx,this.yy,16,0,2*Math.PI),this.context.fillStyle="rgba(255,0,0,1)",this.context.fill(),this.context.closePath(),this.context.lineWidth=5,this.context.strokeStyle="rgba(255,0,0,1)",this.context.stroke(),this.paintkong(),this.paintkong(0),this.paintkong(32),this.paintkong(64)},t.prototype.paintkong=function(e){this.context.beginPath(),this.context.arc(this.xx,this.yy,this.radius+e,0,2*Math.PI),this.context.closePath(),this.context.lineWidth=5-e/16,this.context.strokeStyle="rgba(255,"+(this.radius+e)/255*255+",0,1)",this.context.stroke()};var i=MapPlatForm.Base.AnimationCircleMarker=function(e,t,i){this.map=e,this.threebox=t,this.width=256,this.height=256,this.useCustomCanvas=!!i,this.newfun=null,this.canvas=i||this._initCanavas(),this.timer=null,this.material=this._initMaterial()};i.prototype._initMaterial=function(){var e=new THREE.MeshLambertMaterial({map:new THREE.CanvasTexture(this.canvas),transparent:!0});return this.useCustomCanvas||this._renderCanvas(),e},i.prototype._initCanavas=function(){var e=document.createElement("canvas");return this._context=e.getContext("2d"),e.width=this.width,e.height=this.height,this._context.globalAlpha=1,this.backCanvas=document.createElement("canvas"),this.backCtx=this.backCanvas.getContext("2d"),this.backCtx.globalCompositeOperation="copy",this.backCanvas.width=this.width,this.backCanvas.height=this.height,this.createCircles(),e},i.prototype.addMarkerPoint=function(e,t){var i=new THREE.PlaneBufferGeometry(t/25.4,t/25.4),t=new THREE.Mesh(i,this.material);t.renderOrder=200;i=ZenMap.T.setPoint(this.map,e);this.threebox.addAtCoordinate(t,[i.lon,i.lat,e.height])},i.prototype._renderCanvas=function(){this._context.clearRect(0,0,this.width,this.height),this.createCircles(),this.material&&this.material.map&&(this.material.map.needsUpdate=!0,this.map._obj.repaint=!0),this.timer=setTimeout(this._renderCanvas.bind(this),40)},i.prototype.createCircles=function(){this.newfun=new t(128,128,e,this._context),this.newfun.paint(),this.newfun.radiu(),this.newfun=null}}(),function(){var e=MapPlatForm.Base.MapScene=function(e){var t=MapPlatForm.dataServiceURL+"scene/"+e;this.sceneID=e,this.url=t,this.buildings=[],this.appliances=[],this.outRooms=[],this.wall=null,this.tree=null,this.skyBox=null};e.prototype.addToMap=function(e,t){this.threeLayer=t,this.map=e;var i=this;ZenMap.Utils.Request.Get(this.url,"",function(e){(e=(e=JSON.parse(e)).data.sceneInfo)&&(e=JSON.parse(e),i._creatScene(e))})},e.prototype.remove=function(){for(var e=0;e<this.buildings.length;e++)this.threeLayer.tb.remove(this.buildings[e]);for(e=0;e<this.appliances.length;e++)this.threeLayer.tb.remove(this.appliances[e]);for(e=0;e<this.outRooms.length;e++)this.threeLayer.tb.remove(this.outRooms[e]);this.tree&&(this.tree.removeAllTreeCollect(),this.tree=null),this.wall&&(this.wall.removeAllWalls(),this.wall=null),this.ground&&(this.ground.removeAllGrounds(),this.ground=null),this.particleFire&&(this.particleFire.removeAllFires(),this.particleFire.loop=!1,this.particleFire=null),this.particleWater&&(this.particleWater.removeAllWaterFountains(),this.particleWater.loop=!1,this.particleWater=null),this.water&&(this.water.removeAllWaterEffects(),this.water.loop=!1,this.water=null)},e.prototype._creatScene=function(a){var s=this.threeLayer,e=this.map,h=MapPlatForm.dataServiceURL+"models/{modelID}/{modelID}.gltf",i=this;if(a.buildings)for(var t=0;t<a.buildings.length;t++){var o=a.buildings[t].modelIndex,r=h.replace("{modelID}",a.models[o]).replace("{modelID}",a.models[o]);(function(t){s.loader.load(r,function(e){e=s.addModel(e.scene,a.buildings[t].position,{rotation:a.buildings[t].rotation,scale:a.buildings[t].scale,name:a.buildings[t].name,id:a.buildings[t].id});e.renderOrder=50,e.type="building",i.buildings.push(e)})})(t)}if(a.appliances)for(t=0;t<a.appliances.length;t++){o=a.appliances[t].modelIndex,r=h.replace("{modelID}",a.models[o]).replace("{modelID}",a.models[o]);(function(t){s.loader.load(r,function(e){e=s.addModel(e.scene,a.appliances[t].position,{rotation:a.appliances[t].rotation,scale:a.appliances[t].scale,name:a.appliances[t].name,id:a.appliances[t].id});e.type="appliances",i.appliances.push(e)})})(t)}if(a.outRoom)for(t=0;t<a.outRoom.length;t++){o=a.outRoom[t].modelIndex,r=h.replace("{modelID}",a.models[o]).replace("{modelID}",a.models[o]);(function(t){s.loader.load(r,function(e){e=s.addModel(e.scene,a.outRoom[t].position,{rotation:a.outRoom[t].rotation,scale:a.outRoom[t].scale,name:a.outRoom[t].name,id:a.outRoom[t].id});e.type="outRoom",i.outRooms.push(e)})})(t)}if(a.tree){for(var p=new BigScreenMap.TreeManager(e,s.tb),t=0;t<a.tree.length;t++)(function(n){for(var l=[],e=[],r=0;r<n.models.length;r++){var t=new Promise(function(t,e){var i=n.models[r],o=h.replace("{modelID}",a.models[i]).replace("{modelID}",a.models[i]);s.loader.load(o,function(e){t({index:i,model:e.scene})},void 0,void 0,function(){t({index:i,model:null})})});e.push(t)}Promise.all(e).then(function(e){for(var t,i=0;i<n.treeGeometries.length;i++)"POLYLINE"===n.type||"POLYGON"===n.type?(t=WKT.read(n.treeGeometries[i]),l.push(t)):(t=new ZenMap.Geometry.Point(n.treeGeometries[i][0],n.treeGeometries[i][1]),l.push(t));for(var o,r=[],i=0;i<n.models.length;i++)for(var a=0;a<e.length;a++)if(n.models[i]===e[a].index){var s=e[a].model;s&&r.push(s);break}r.length&&(o=new BigScreenMap.TreeCollect(l,n.type,n.split,r,n.side),p.addTreeCollect(o))})})(a.tree[t]);i.tree=p}if(a.particle&&0<a.particle.length){for(var n,l,c=new BigScreenMap.WaterFountainManager(e,s.tb),u=new BigScreenMap.FireManager(e,s.tb),t=0;t<a.particle.length;t++)"water"===a.particle[t].type?(n=new BigScreenMap.WaterFountain({dX:a.particle[t].system[0],dY:a.particle[t].system[1],dZ:a.particle[t].system[2],dX1:a.particle[t].system[3],dY1:a.particle[t].system[4],dZ1:a.particle[t].system[5]}),l=a.particle[t].position,c.addWaterFountain(n,new ZenMap.Geometry.Point(l[0],l[1]),{height:l[2]})):"fire"===a.particle[t].type&&((n=new BigScreenMap.Fire(s.tb)).scale(a.particle[t].scale[0],a.particle[t].scale[1],a.particle[t].scale[2]),l=a.particle[t].position,u.addFire(n,new ZenMap.Geometry.Point(l[0],l[1]),{height:l[2]}));i.particleFire=u,i.particleWater=c}if(a.walls){for(var m=new BigScreenMap.WallManager(e,s.tb),t=0;t<a.walls.length;t++)for(var d=0;d<a.walls[t].geomtries.length;d++){var y=WKT.read(a.walls[t].geomtries[d]),y=new BigScreenMap.Wall(y,a.walls[t].height,{imageURL:a.walls[t].image,width_height:a.walls[t].width_height});m.addWall(y)}i.wall=m}var _=[],f=new BigScreenMap.GroundManager(e,s.tb);if(a.grounds)for(t=0;t<a.grounds.length;t++){for(var g=WKT.read(a.grounds[t].landGeometry),v=[],d=0;d<a.grounds[t].grassGeometries.length;d++){var M=WKT.read(a.grounds[t].grassGeometries[d]);v.push(M)}_.push(g),a.grounds[t].landImage.imageURL=a.grounds[t].landImage.imageURL,a.grounds[t].grassImage.imageURL=a.grounds[t].grassImage.imageURL;g=new BigScreenMap.Ground(g,v,{land:a.grounds[t].landImage,grass:a.grounds[t].grassImage},a.grounds[t].hasHoles);f.addGround(g)}i.ground=f,a.plane&&a.plane.geometry&&(e=WKT.read(a.plane.geometry),e=new BigScreenMap.Ground(e,_,{land:{color:a.plane.color}},!0),f.addGround(e))}}();